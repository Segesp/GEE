# üéØ Gu√≠a de Uso - EcoPlan con Google Earth Engine

## üìñ Introducci√≥n

Esta gu√≠a te mostrar√° c√≥mo utilizar todas las funcionalidades de EcoPlan con datos satelitales reales de Google Earth Engine.

---

## üöÄ Inicio R√°pido

### 1. Verificar que el Servidor Est√° Funcionando

```bash
# En la terminal
curl http://localhost:3000/api/health

# Respuesta esperada:
# {
#   "status": "ok",
#   "earthEngineInitialized": true,
#   "timestamp": "2025-10-05T..."
# }
```

### 2. Abrir el Hub Principal

Abre tu navegador en: **http://localhost:3000**

Ver√°s 9 tarjetas con las herramientas disponibles:
- üìù Reportes Ciudadanos
- üåä Calidad de Aire y Agua
- üå≥ Vegetaci√≥n e Islas de Calor
- üèõÔ∏è Panel para Autoridades
- üèòÔ∏è Mi Barrio
- üìö Tutoriales
- üîí Transparencia
- üìñ Documentaci√≥n API
- üõ∞Ô∏è Google Earth Engine

---

## üåä Herramienta: Calidad de Aire y Agua

### Acceso
http://localhost:3000/calidad-aire-agua.html

### Funcionalidades

#### ‚úÖ Variables Disponibles
- **AOD** (Aerosol Optical Depth) - Calidad del aire
- **NO‚ÇÇ** (Di√≥xido de Nitr√≥geno) - Contaminaci√≥n vehicular
- **Clorofila-a** - Calidad del agua costera
- **NDWI** (Normalized Difference Water Index) - Humedad

#### üìÖ C√≥mo Usar

1. **Selecciona una fecha hist√≥rica** (recomendado: √∫ltimos 2 meses)
   ```
   Ejemplo: 2024-08-15
   ```

2. **Marca las variables que deseas analizar**
   - ‚òëÔ∏è AOD
   - ‚òëÔ∏è NO‚ÇÇ
   - ‚òëÔ∏è Clorofila
   - ‚òëÔ∏è NDWI

3. **Haz clic en "üîÑ Cargar Datos"**

4. **Espera 5-30 segundos** - Ver√°s un overlay de carga con mensaje:
   ```
   Procesando datos satelitales...
   Esto puede tomar entre 5-30 segundos
   ```

5. **Explora los resultados**
   - Los mapas se actualizar√°n con capas de GEE
   - Las estad√≠sticas (media, min, max) se mostrar√°n
   - Usa las tabs para cambiar entre variables

#### üîç Ejemplo de Respuesta de API

```bash
curl "http://localhost:3000/api/air-water-quality/all?date=2024-08-15" | jq '.'
```

```json
{
  "date": "2024-08-15",
  "region": "Lima Metropolitana",
  "variables": [
    {
      "variable": "AOD",
      "date": "2024-08-15",
      "unit": "unitless",
      "source": "MODIS/061/MCD19A2_GRANULES",
      "resolution": "1 km",
      "statistics": {
        "mean": 0.234,
        "min": 0.089,
        "max": 0.567,
        "stdDev": 0.112
      },
      "mapId": "projects/github-nasa/maps/...",
      "token": "",
      "interpretation": "Calidad de aire: Moderada"
    },
    // ... m√°s variables
  ]
}
```

#### üé® Interpretaci√≥n de Colores

**AOD (Aerosoles):**
- üü¢ Verde (0.0 - 0.1): Excelente
- üü° Amarillo (0.1 - 0.2): Bueno
- üü† Naranja (0.2 - 0.3): Moderado
- üî¥ Rojo (0.3 - 0.5): Malo
- üî¥üî¥ Rojo oscuro (> 0.5): Muy malo

**NO‚ÇÇ (Di√≥xido de Nitr√≥geno):**
- üîµ Azul (< 50 Œºmol/m¬≤): Bajo
- üü° Amarillo (50 - 100): Moderado
- üü† Naranja (100 - 150): Alto
- üî¥ Rojo (150 - 200): Muy alto
- üî¥üî¥ Rojo oscuro (> 200): Extremo

---

## üå≥ Herramienta: Vegetaci√≥n e Islas de Calor

### Acceso
http://localhost:3000/vegetacion-islas-calor.html

### Funcionalidades

#### ‚úÖ An√°lisis Disponibles
- **NDVI** (Normalized Difference Vegetation Index) - Cobertura vegetal
- **LST** (Land Surface Temperature) - Temperatura superficial
- **Anomal√≠as LST** - Desviaciones respecto a climatolog√≠a 2018-2022
- **Detecci√≥n de Islas de Calor** - Eventos extremos de temperatura
- **√çndice de Prioridad** - Rankings de distritos para intervenciones

#### üìÖ C√≥mo Usar

1. **Configura el rango de fechas**
   ```
   Fecha inicio: 2024-01-01
   Fecha fin:    2024-03-31
   ```

2. **Ajusta controles opcionales**
   - Umbral de detecci√≥n de islas de calor: **2.0¬∞C** (default)
   - LST d√≠a/noche: **D√≠a (~10:30 LT)** (default)
   - M√°scara de nubes: **Activada** ‚úÖ

3. **Haz clic en "üîÑ Cargar An√°lisis"**

4. **Espera mientras GEE procesa** (15-30 segundos para an√°lisis completo)

5. **Explora los resultados**
   - **Mapa NDVI**: Muestra vegetaci√≥n (verde = alta, caf√© = baja)
   - **Mapa LST Anomal√≠a**: Muestra islas de calor (rojo = caliente, azul = fresco)
   - **Tabla de Eventos**: Lista de islas de calor detectadas
   - **Tabla de Prioridades**: Distritos ordenados por urgencia de intervenci√≥n

#### üîç Ejemplo de Respuesta de API

```bash
curl "http://localhost:3000/api/vegetation-heat/analysis?startDate=2024-01-01&endDate=2024-03-31" | jq '.'
```

```json
{
  "startDate": "2024-01-01",
  "endDate": "2024-03-31",
  "region": "Lima Metropolitana",
  "ndvi": {
    "variable": "NDVI",
    "statistics": {
      "mean": 0.0266,
      "min": -0.9950,
      "max": 0.8360,
      "stdDev": 0.1285
    },
    "mapId": "projects/github-nasa/maps/...",
    "interpretation": "Vegetaci√≥n: Baja cobertura (urbano)"
  },
  "lst": {
    "variable": "LST",
    "statistics": {
      "mean": 28.5,
      "min": 15.2,
      "max": 42.8,
      "stdDev": 4.7
    },
    "mapId": "projects/github-nasa/maps/...",
    "unit": "¬∞C"
  },
  "heatIslands": {
    "threshold": 2.0,
    "events": [
      {
        "date": "2024-01-15",
        "timeOfDay": "day",
        "anomaly": 3.2,
        "area_km2": 15.7
      },
      // ... m√°s eventos
    ]
  }
}
```

#### üé® Interpretaci√≥n de Colores

**NDVI (Vegetaci√≥n):**
- ‚ö´ Gris (0.0 - 0.2): Suelo desnudo/urbano
- üü° Amarillo (0.2 - 0.4): Vegetaci√≥n dispersa
- üü¢ Verde claro (0.4 - 0.6): Vegetaci√≥n moderada
- üü¢üü¢ Verde oscuro (0.6 - 0.8): Vegetaci√≥n densa

**LST Anomal√≠a:**
- üîµ Azul (-2.5 a 0¬∞C): M√°s fresco que lo normal
- ‚ö™ Blanco (0 a 0.5¬∞C): Normal
- üü° Amarillo (0.5 a 2.0¬∞C): Ligeramente c√°lido
- üü† Naranja (2.0 a 3.0¬∞C): Isla de calor moderada
- üî¥ Rojo (> 3.0¬∞C): Isla de calor severa

---

## üîå API REST - Endpoints Completos

### Calidad de Aire y Agua

#### 1. Todas las Variables
```bash
GET /api/air-water-quality/all?date=2024-08-15

curl "http://localhost:3000/api/air-water-quality/all?date=2024-08-15"
```

#### 2. AOD Individual
```bash
GET /api/air-water-quality/aod?date=2024-08-15

curl "http://localhost:3000/api/air-water-quality/aod?date=2024-08-15"
```

#### 3. NO‚ÇÇ Individual
```bash
GET /api/air-water-quality/no2?date=2024-08-15

curl "http://localhost:3000/api/air-water-quality/no2?date=2024-08-15"
```

#### 4. Clorofila Individual
```bash
GET /api/air-water-quality/chlorophyll?date=2024-08-15

curl "http://localhost:3000/api/air-water-quality/chlorophyll?date=2024-08-15"
```

#### 5. NDWI Individual
```bash
GET /api/air-water-quality/ndwi?date=2024-08-15

curl "http://localhost:3000/api/air-water-quality/ndwi?date=2024-08-15"
```

#### 6. Series Temporales
```bash
GET /api/air-water-quality/timeseries?variable=aod&startDate=2024-01-01&endDate=2024-03-31&district=lima-centro

curl "http://localhost:3000/api/air-water-quality/timeseries?variable=aod&startDate=2024-01-01&endDate=2024-03-31"
```

### Vegetaci√≥n e Islas de Calor

#### 1. NDVI
```bash
GET /api/vegetation-heat/ndvi?startDate=2024-01-01&endDate=2024-03-31

curl "http://localhost:3000/api/vegetation-heat/ndvi?startDate=2024-01-01&endDate=2024-03-31"
```

#### 2. LST (Temperatura Superficial)
```bash
GET /api/vegetation-heat/lst?startDate=2024-01-01&endDate=2024-03-31&timeOfDay=day

curl "http://localhost:3000/api/vegetation-heat/lst?startDate=2024-01-01&endDate=2024-03-31&timeOfDay=day"
```

#### 3. Anomal√≠a LST
```bash
GET /api/vegetation-heat/lst-anomaly?targetDate=2024-08-15&timeOfDay=day

curl "http://localhost:3000/api/vegetation-heat/lst-anomaly?targetDate=2024-08-15&timeOfDay=day"
```

#### 4. Detecci√≥n de Islas de Calor
```bash
GET /api/vegetation-heat/heat-islands?startDate=2024-01-01&endDate=2024-03-31&threshold=2.0

curl "http://localhost:3000/api/vegetation-heat/heat-islands?startDate=2024-01-01&endDate=2024-03-31&threshold=2.0"
```

#### 5. An√°lisis Completo
```bash
GET /api/vegetation-heat/analysis?startDate=2024-01-01&endDate=2024-03-31

curl "http://localhost:3000/api/vegetation-heat/analysis?startDate=2024-01-01&endDate=2024-03-31"
```

#### 6. √çndice de Prioridad
```bash
GET /api/vegetation-heat/priority?date=2024-08-15

curl "http://localhost:3000/api/vegetation-heat/priority?date=2024-08-15"
```

---

## üó∫Ô∏è Integraci√≥n con Leaflet

### Agregar Capa GEE a un Mapa Leaflet

```javascript
// Obtener datos de la API
const response = await fetch('/api/air-water-quality/aod?date=2024-08-15');
const data = await response.json();

// Extraer mapId y token
const { mapId, token } = data;

// Construir URL de tiles
const tileUrl = `https://earthengine.googleapis.com/v1alpha/projects/github-nasa/maps/${mapId}/tiles/{z}/{x}/{y}`;

// Agregar capa al mapa
const geeLayer = L.tileLayer(tileUrl, {
    attribution: 'Google Earth Engine',
    maxZoom: 20,
    opacity: 0.7
});

geeLayer.addTo(map);
```

### Cambiar entre Capas

```javascript
// Array para almacenar capas
const layers = {
    aod: null,
    no2: null,
    chl: null,
    ndwi: null
};

// Funci√≥n para cambiar capa visible
function showLayer(variableName) {
    Object.keys(layers).forEach(key => {
        if (layers[key]) {
            if (key === variableName) {
                layers[key].setOpacity(0.7); // Mostrar
            } else {
                layers[key].setOpacity(0);   // Ocultar
            }
        }
    });
}

// Uso
showLayer('aod'); // Muestra solo AOD
```

---

## üìä Ejemplos de Uso Pr√°ctico

### Caso 1: Monitoreo de Calidad del Aire Mensual

```bash
# Obtener datos de AOD para todo enero 2024
for day in {01..31}; do
    curl -s "http://localhost:3000/api/air-water-quality/aod?date=2024-01-$day" \
    | jq '.statistics.mean' >> aod_january.txt
done

# Calcular promedio
awk '{sum+=$1; count++} END {print sum/count}' aod_january.txt
```

### Caso 2: Detecci√≥n de Eventos de Calor

```javascript
// En frontend JavaScript
async function monitorHeatEvents() {
    const response = await fetch(
        '/api/vegetation-heat/heat-islands?startDate=2024-01-01&endDate=2024-12-31&threshold=2.5'
    );
    
    const data = await response.json();
    const criticalEvents = data.events.filter(e => e.anomaly > 3.0);
    
    if (criticalEvents.length > 0) {
        alert(`‚ö†Ô∏è Se detectaron ${criticalEvents.length} eventos cr√≠ticos de islas de calor`);
        
        // Mostrar en tabla
        criticalEvents.forEach(event => {
            console.log(`${event.date}: +${event.anomaly}¬∞C`);
        });
    }
}
```

### Caso 3: Ranking de Distritos para Intervenci√≥n Verde

```bash
# Obtener √≠ndice de prioridad
curl -s "http://localhost:3000/api/vegetation-heat/priority?date=2024-08-15" \
| jq '.priorities | sort_by(-.priority) | .[:5] | .[] | "\(.name): \(.priority)"'

# Resultado ejemplo:
# "San Juan de Lurigancho: 0.82"
# "Ate: 0.75"
# "Villa Mar√≠a del Triunfo: 0.68"
# "Comas: 0.62"
# "Lima Centro: 0.58"
```

---

## üõ†Ô∏è Troubleshooting

### Problema: "No data available"

**S√≠ntomas:**
```json
{
  "statistics": {
    "mean": null,
    "min": null,
    "max": null
  },
  "interpretation": "No data available"
}
```

**Causas posibles:**
1. Fecha muy reciente (datos a√∫n no procesados)
2. Fecha fuera del rango de disponibilidad del dataset
3. Cobertura de nubes 100% (no hay p√≠xeles v√°lidos)

**Soluciones:**
- Usa fechas con al menos 7 d√≠as de antig√ºedad
- Intenta con diferentes fechas hist√≥ricas
- Para vegetaci√≥n, usa rangos de fechas m√°s largos (ej: 3 meses) para obtener composites m√°s robustos

### Problema: Loading infinito

**S√≠ntomas:**
El overlay de carga no desaparece despu√©s de 30+ segundos.

**Soluciones:**
1. Revisa la consola del navegador (F12) para errores JavaScript
2. Verifica el estado del servidor:
   ```bash
   curl http://localhost:3000/api/health
   ```
3. Revisa los logs del servidor:
   ```bash
   tail -f /workspaces/GEE/server.log
   ```
4. Reinicia el servidor:
   ```bash
   pkill -f "node server.js"
   cd /workspaces/GEE && node server.js > server.log 2>&1 &
   ```

### Problema: Mapas no se visualizan

**S√≠ntomas:**
Los mapas est√°n vac√≠os o muestran solo el mapa base.

**Soluciones:**
1. Verifica que mapId no sea null en la respuesta de la API
2. Comprueba la consola del navegador para errores de red
3. Verifica que tienes conexi√≥n a internet (las tiles vienen de GEE servers)
4. Intenta con un zoom diferente o recentraliza el mapa

---

## üìà Mejores Pr√°cticas

### 1. Selecci√≥n de Fechas
- **Calidad de Aire y Agua**: Usa fechas individuales con 7-14 d√≠as de antig√ºedad
- **Vegetaci√≥n e Islas de Calor**: Usa rangos de 1-3 meses para mejores composites

### 2. Rendimiento
- Evita hacer muchas consultas simult√°neas (espera que una termine antes de la siguiente)
- Los resultados son m√°s r√°pidos si otros usuarios ya consultaron fechas similares (cach√© futuro)
- Las consultas de an√°lisis completo tardan m√°s que consultas individuales

### 3. Interpretaci√≥n de Resultados
- LST Anomal√≠a es m√°s √∫til que LST absoluta para detectar islas de calor
- NDVI < 0.2 indica √°reas urbanas con poca vegetaci√≥n (oportunidad de intervenci√≥n)
- AOD > 0.3 indica calidad de aire preocupante (considera alertas)

### 4. Integraci√≥n en Aplicaciones
- Usa async/await para manejo de promesas
- Implementa manejo de errores robusto (try/catch)
- Muestra indicadores de carga siempre (UX)
- Cacha resultados en localStorage para consultas repetidas

---

## üìö Recursos Adicionales

- **Swagger UI Interactivo**: http://localhost:3000/api-docs
- **Documentaci√≥n Completa**: `/workspaces/GEE/INTEGRACION-API-COMPLETADA.md`
- **Gu√≠a de Implementaci√≥n**: `/workspaces/GEE/IMPLEMENTACION-GEE-COMPLETA.md`
- **Google Earth Engine Docs**: https://developers.google.com/earth-engine
- **Leaflet Documentation**: https://leafletjs.com/reference.html

---

## üéâ ¬°Listo para Usar!

Ahora tienes acceso completo a datos satelitales reales de Google Earth Engine para monitorear la calidad ambiental de Lima Metropolitana. 

**¬øPreguntas?** Revisa los ejemplos de c√≥digo o consulta la documentaci√≥n de la API.

**¬øEncontraste un bug?** Revisa la secci√≥n de Troubleshooting o verifica los logs del servidor.

**¬°Feliz monitoreo ambiental!** üåçüõ∞Ô∏è‚ú®
