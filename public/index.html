<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Monitoreo de floraciones algales y EcoPlan Urbano para Lima.">
  <title>EcoPlan Urbano &amp; Bloom Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="vendor/leaflet/leaflet.css">
  <link rel="stylesheet" href="vendor/leaflet-markercluster/MarkerCluster.css">
  <link rel="stylesheet" href="vendor/leaflet-markercluster/MarkerCluster.Default.css">
  <style>
    :root {
      --bg: #0b1120;
      --surface: #0f172a;
      --surface-muted: rgba(15, 23, 42, 0.6);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.24);
      --primary: #2563eb;
      --success: #16a34a;
      --warning: #eab308;
      --error: #f87171;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.12), transparent 40%), #020617;
      color: var(--text);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 32px clamp(16px, 5vw, 48px) 24px;
      gap: 24px;
    }

    header h1 {
      font-size: clamp(1.8rem, 2.5vw, 2.4rem);
      margin: 0 0 8px;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      line-height: 1.5;
    }

    main {
      padding: 0 clamp(16px, 5vw, 48px) 48px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(320px, 360px) 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1100px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .view-switcher {
      display: inline-flex;
      gap: 10px;
      background: var(--surface);
      border-radius: 999px;
      padding: 6px;
      border: 1px solid var(--border);
      align-self: flex-start;
      margin-bottom: 24px;
    }

    body.modal-open {
      overflow: hidden;
    }
    .mode-button {
      border: none;
      background: transparent;
      padding: 8px 20px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.78);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(16px, 5vw, 32px);
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    
    .modal-overlay[hidden] {
      display: none !important;
    }
    
    .modal-dialog {
      width: min(780px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
      padding: clamp(20px, 4vw, 28px);
      position: relative;
    }
    .modal-close-button {
      position: absolute;
      top: 14px;
      right: 14px;
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.5);
      border-radius: 999px;
      width: 36px;
      height: 36px;
      font-size: 1.4rem;
      font-weight: 700;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10000;
    }
    .modal-close-button:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.8);
      transform: scale(1.1);
    }
    .modal-close-button:active {
      transform: scale(0.95);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      padding-right: 48px;
      margin-bottom: 18px;
    }
    .modal-subtitle {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .modal-title {
      margin: 0;
      font-size: 1.35rem;
    }
    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .modal-footer {
      margin-top: 24px;
      display: flex;
      justify-content: flex-end;
    }
    .modal-footer .button-secondary {
      min-width: 120px;
    }
    .modal-section h4 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .key-value-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px 18px;
    }
    .key-value-grid .key-label {
      display: block;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .key-value-grid .key-value {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .metrics-card {
      background: rgba(15, 23, 42, 0.25);
      border: 1px solid rgba(148, 163, 184, 0.24);
      border-radius: 12px;
      padding: 12px;
    }
    .metrics-card h5 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .metrics-card .metric-value {
      font-size: 1rem;
      font-weight: 600;
    }
    .json-block {
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 12px;
      padding: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 240px;
    }
    .results-list,
    .notifications-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .result-item,
    .notification-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      background: rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 12px;
      padding: 10px 14px;
    }
    .result-item-main,
    .notification-item-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .result-item-actions,
    .notification-item-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .result-item-actions a {
      color: var(--primary);
      font-size: 0.8rem;
      text-decoration: none;
    }
    .result-item-actions a:hover {
      text-decoration: underline;
    }
    .clickable-row {
      cursor: pointer;
    }
    .clickable-row:focus {
      outline: 2px solid var(--primary);
      outline-offset: -2px;
    }

    .mode-button.active {
      background: linear-gradient(120deg, #2563eb, #0ea5e9);
      color: #fff;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
    }

    .hidden {
      display: none !important;
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
      padding: 18px 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .controls form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    input[type="number"],
    input[type="date"],
    select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.03);
      color: inherit;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 123, 182, 0.2);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      background: linear-gradient(120deg, #2563eb, #0ea5e9);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.3);
    }

    .button-secondary {
      background: rgba(37, 99, 235, 0.18);
      color: var(--text);
      border: 1px solid rgba(37, 99, 235, 0.35);
    }

    .button-secondary:hover {
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.35);
      transform: translateY(-2px);
    }

    .download-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .download-buttons button {
      flex: 1 1 140px;
    }

    .history-filters {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .history-filters label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .history-filters select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.12);
      color: inherit;
      font-size: 0.82rem;
    }

    .history-controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    .history-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.22);
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--text-muted);
      user-select: none;
      transition: border 0.2s ease, background 0.2s ease;
    }

    .history-toggle input {
      accent-color: var(--primary);
    }

    .history-toggle:hover {
      border-color: rgba(148, 163, 184, 0.4);
    }

    .history-controls select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.12);
      color: inherit;
      font-size: 0.82rem;
    }

    .map-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #map {
      width: 100%;
      min-height: 520px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .summary-card h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .summary-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 8px 0 4px;
    }

    .summary-card small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    canvas {
      width: 100% !important;
      height: 280px !important;
    }

    .status-log {
      max-height: 140px;
      overflow-y: auto;
      padding-right: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
    }

    .history-summary {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .summary-pill {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-pill .summary-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .summary-pill .summary-value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      color: var(--text);
    }

    table thead {
      background: rgba(15, 23, 42, 0.05);
    }

    table th,
    table td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    table tbody tr:hover {
      background: rgba(30, 123, 182, 0.08);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(15, 23, 42, 0.45);
      color: var(--text-muted);
      text-decoration: none;
    }

    .tag.success {
      background: rgba(22, 163, 74, 0.22);
      color: #bbf7d0;
    }

    .tag.error {
      background: rgba(248, 113, 113, 0.22);
      color: #fecaca;
    }

    .tag.warning {
      background: rgba(234, 179, 8, 0.2);
      color: #fef08a;
    }

    .tag.neutral {
      background: rgba(148, 163, 184, 0.25);
      color: var(--text-muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .status-pill.success {
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .status-pill.warning {
      background: rgba(234, 179, 8, 0.2);
      color: #fef08a;
    }

    .status-pill.error {
      background: rgba(248, 113, 113, 0.22);
      color: #fecaca;
    }

    .status-pill.neutral {
      background: rgba(148, 163, 184, 0.22);
      color: var(--text-muted);
    }

    .row-subtext {
      display: block;
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .layer-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.75rem;
      margin-top: 12px;
    }

    .layer-badge {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(30, 123, 182, 0.12);
      color: #0f172a;
      font-weight: 600;
    }

    footer {
      padding: 14px 24px 32px;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }
      .modal-dialog {
        padding: 18px;
      }

      .result-item,
      .notification-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .result-item-actions,
      .notification-item-actions {
        width: 100%;
        justify-content: flex-start;
      }

    .loader {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--primary);
      font-weight: 600;
    }

    .loader span {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(120deg, #2563eb, #38bdf8);
      animation: pulse 1s infinite ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    a {
      color: inherit;
      text-decoration: underline dashed;
    }

    @media (max-width: 640px) {
      footer {
        padding: 18px 20px 28px;
        font-size: 0.8rem;
      }

      .modal-dialog {
        padding: 18px;
      }

      .result-item,
      .notification-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .result-item-actions,
      .notification-item-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
    /* Estilos para el nuevo modal MVP de reportes */
    .step-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }
    
    .step-indicator.active {
      opacity: 1;
    }
    
    .step-indicator.completed {
      opacity: 0.7;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(148, 163, 184, 0.2);
      border: 2px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }
    
    .step-indicator.active .step-number {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
      transform: scale(1.1);
    }
    
    .step-indicator.completed .step-number {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    
    .step-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    
    .step-indicator.active .step-label {
      color: #3b82f6;
    }
    
    .step-connector {
      width: 50px;
      height: 2px;
      background: rgba(148, 163, 184, 0.3);
      margin-top: 20px;
    }
    
    .report-step {
      min-height: 300px;
    }
    
    .report-step.hidden {
      display: none;
    }
    
    .category-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
    }
    
    .category-card:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .category-card.selected {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .category-icon {
      font-size: 3rem;
      line-height: 1;
    }
    
    .category-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    /* Estilos para indicadores de exploración */
    .explore-indicators {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    
    .indicator-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(14, 165, 233, 0.08) 100%);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: 12px;
      padding: 14px 12px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .indicator-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.4);
    }
    
    .indicator-card .indicator-icon {
      font-size: 2rem;
      margin-bottom: 6px;
      display: block;
    }
    
    .indicator-card .indicator-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text);
      display: block;
      margin-bottom: 4px;
    }
    
    .indicator-card .indicator-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
      color: var(--text-muted);
    }
    
    /* Estilos para filtros de exploración */
    .explore-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    .explore-search-icon {
      position: relative;
      flex: 1;
      min-width: 200px;
    }
    
    .explore-search-icon::before {
      content: "🔍";
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      pointer-events: none;
      z-index: 1;
    }
    
    /* Estilos para capas GEE */
    .gee-layer-controls {
      background: rgba(139, 92, 246, 0.05);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 14px;
      padding: 18px;
    }
    
    .gee-layer-controls h3 {
      margin: 0 0 16px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
      color: #8b5cf6;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .gee-layer-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    
    .gee-layer-item:hover {
      background: rgba(139, 92, 246, 0.08);
    }
    
    .gee-layer-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #8b5cf6;
    }
    
    .gee-layer-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      user-select: none;
    }
    
    .gee-opacity-slider {
      width: 100px;
      height: 6px;
      border-radius: 3px;
      background: rgba(139, 92, 246, 0.2);
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
    }
    
    .gee-opacity-slider::-webkit-slider-thumb {
      appearance: none;
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #8b5cf6;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
      transition: all 0.2s ease;
    }
    
    .gee-opacity-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 3px 10px rgba(139, 92, 246, 0.6);
    }
    
    .gee-opacity-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #8b5cf6;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
      transition: all 0.2s ease;
    }
    
    .gee-opacity-slider::-moz-range-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 3px 10px rgba(139, 92, 246, 0.6);
    }
    
    .gee-opacity-slider:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Estilos para el mapa modal integrado */
    .modal-map-container {
      position: relative;
      width: 100%;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
      margin-bottom: 16px;
      background: var(--surface);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    #modalMap {
      width: 100%;
      height: 100%;
      cursor: crosshair;
      z-index: 1;
    }
    
    .modal-map-instructions {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(59, 130, 246, 0.95);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: pulse 2s infinite;
      pointer-events: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
      50% { opacity: 0.8; transform: translateX(-50%) scale(1.02); }
    }
    
    .location-input-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .location-input-group input {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
      background: rgba(148, 163, 184, 0.05);
      color: var(--text);
      text-align: center;
      font-weight: 600;
    }
    
    .location-input-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .location-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .location-buttons button {
      flex: 1;
      padding: 10px;
      font-size: 0.85rem;
    }

  </style>
</head>
<body>
  <header>
    <div>
      <h1>Monitoreo de Floraciones – Lima, Perú</h1>
      <p>Integra Sentinel-2 (NDCI/FAI), contexto regional MODIS (clorofila) y NOAA OISST (temperatura superficial) para analizar blooms costeros en tiempo casi real.</p>
    </div>
    <div class="loader" id="headerLoader" hidden>
      <span></span>
      <span></span>
      <span></span>
      Procesando solicitud...
    </div>
  </header>

  <main>
    <div class="view-switcher">
      <button type="button" class="mode-button active" data-mode="bloom">Floraciones algales</button>
      <button type="button" class="mode-button" data-mode="ecoplan">EcoPlan Urbano</button>
      <button type="button" class="mode-button" data-mode="citizen">Participación Ciudadana</button>
    </div>

    <div class="dashboard-grid">
      <div id="controlColumn">
        <aside class="controls" id="bloomControls">
          <section class="card">
            <h2 class="section-title">Configuración del análisis</h2>
            <form id="controlForm">
              <label>
                Zona (ROI preset)
                <select name="preset" id="presetSelect" required>
                  <option value="" disabled selected>Cargando presets...</option>
                  <option value="costa_metropolitana" data-default-buffer="400">Costa Metropolitana de Lima (mar)</option>
                  <option value="ancon" data-default-buffer="200">Bahía de Ancón (mar)</option>
                  <option value="pantanos" data-default-buffer="-200">Pantanos de Villa (humedal)</option>
                </select>
              </label>

              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  Fecha inicio
                  <input type="date" name="start" id="startDate" required>
                </label>
                <label>
                  Fecha fin
                  <input type="date" name="end" id="endDate" required>
                </label>
              </div>

              <label>
                Porcentaje máximo de nubosidad (%)
                <input type="number" name="cloudPercentage" id="cloudPercentage" min="0" max="100" step="1" value="35">
              </label>

              <div class="section-title">Umbrales (se combinan con adaptativos)</div>
              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  NDCI threshold
                  <input type="number" name="ndciThreshold" id="ndciThreshold" step="0.01" value="0.1">
                </label>
                <label>
                  FAI threshold
                  <input type="number" name="faiThreshold" id="faiThreshold" step="0.001" value="0.005">
                </label>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  Limpieza (pixeles conectados)
                  <input type="number" name="minPixelsClean" id="minPixelsClean" step="1" min="1" value="12">
                </label>
                <label>
                  Buffer ROI (m)
                  <input type="number" name="buffer" id="buffer" step="50" value="">
                </label>
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="adaptiveThreshold" name="adaptiveThreshold" checked>
                <label for="adaptiveThreshold" style="margin: 0; flex: 1;">Calcular percentiles adaptativos</label>
              </div>

              <div class="section-title">Contexto regional</div>
              <label>
                Buffer regional (km)
                <input type="number" name="contextBufferKm" id="contextBufferKm" step="1" value="5">
              </label>

              <button type="submit" id="runButton">Actualizar análisis</button>
            </form>
          </section>

          <section class="card">
            <h2 class="section-title">Prueba rápida</h2>
            <p style="margin-top: 0; font-size: 0.85rem; color: var(--text-muted);">
              Carga una imagen de referencia (Landsat 8 True Color) para comprobar que la conexión con Earth Engine funciona
              aun sin ejecutar el análisis completo de bloom.
            </p>
            <button type="button" id="quickViewButton">Ver imagen satelital simple</button>
          </section>

          <section class="card">
            <h2 class="section-title">Estado</h2>
            <div class="status-log" id="statusLog"></div>
            <div class="layer-badges" id="layerBadges"></div>
          </section>

          <section class="card" id="thresholdCard">
            <h2 class="section-title">Umbrales efectivos</h2>
            <div><strong>NDCI:</strong> <span id="thresholdNdci">–</span></div>
            <div><strong>FAI:</strong> <span id="thresholdFai">–</span></div>
            <div><strong>FAI (B8A):</strong> <span id="thresholdFaiAlt">–</span></div>
            <small>Los umbrales adaptativos se combinan con los manuales usando el máximo.</small>
          </section>
        </aside>

        <aside class="controls hidden" id="ecoControls">
          <section class="card">
            <h2 class="section-title">Parámetros EcoPlan</h2>
            <form id="ecoForm">
              <label>
                Área de trabajo
                <select name="preset" id="ecoPresetSelect" required>
                  <option value="" disabled selected>Cargando presets...</option>
                  <option value="lima_metropolitana">Lima Metropolitana (urbano)</option>
                  <option value="lima_centro">Lima Centro (urbano)</option>
                  <option value="callao">Callao (urbano)</option>
                </select>
              </label>

              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  Fecha inicio
                  <input type="date" name="start" id="ecoStartDate" required>
                </label>
                <label>
                  Fecha fin
                  <input type="date" name="end" id="ecoEndDate" required>
                </label>
              </div>

              <label>
                Porcentaje máximo de nubosidad (%)
                <input type="number" name="cloudPercentage" id="ecoCloudPercentage" min="0" max="100" step="1" value="20">
              </label>

              <label>
                Año de densidad poblacional
                <select name="populationYear" id="ecoPopulationYear">
                  <option value="2020" selected>2020</option>
                  <option value="2015">2015</option>
                  <option value="2010">2010</option>
                </select>
              </label>

              <label>
                Buffer ROI (m)
                <input type="number" name="buffer" id="ecoBuffer" step="50" placeholder="Opcional">
              </label>

              <label>
                Asset de límites (opcional)
                <input type="text" name="districtsAsset" id="ecoDistrictsAsset" placeholder="users/tu_usuario/distritos_lima">
              </label>

              <button type="submit" id="ecoRunButton">Calcular EcoPlan</button>
            </form>
          </section>

          <section class="card">
            <h2 class="section-title">Estado EcoPlan</h2>
            <div class="status-log" id="ecoStatusLog"></div>
          </section>

          <section class="card">
            <h2 class="section-title">Notas rápidas</h2>
            <ul style="margin: 0; padding-left: 18px; color: var(--text-muted); font-size: 0.85rem;">
              <li>NDVI se obtiene de Sentinel-2 SR (calidad armonizada).</li>
              <li>LST proviene de Landsat 8/9 L2 y se expresa en °C.</li>
              <li>Índice de calor combina LST, NDVI y densidad poblacional.</li>
              <li>AOD usa MODIS MOD08_M3 para contaminación atmosférica.</li>
            </ul>
          </section>

          <section class="card">
            <h2 class="section-title">Descargar reporte</h2>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem;">Genera un reporte EcoPlan con los parámetros actuales en distintos formatos listos para compartir.</p>
            <div class="download-buttons">
              <button type="button" class="button-secondary" data-report-format="pdf">Descargar PDF</button>
              <button type="button" class="button-secondary" data-report-format="html">Abrir HTML</button>
              <button type="button" class="button-secondary" data-report-format="csv">Descargar CSV</button>
            </div>
            <small style="color: var(--text-muted); display: block; margin-top: 8px;">Los reportes se generan usando Google Earth Engine y pueden tardar algunos segundos.</small>
          </section>

          <section class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
              <h2 class="section-title" style="margin-bottom: 0;">Historial de reportes</h2>
              <button type="button" class="button-secondary" id="refreshReportRuns" style="padding: 8px 14px; font-size: 0.8rem;">Actualizar</button>
            </div>
            <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.8rem;">Últimas ejecuciones del scheduler (máx. 20). Los enlaces aparecen cuando los archivos están disponibles en Cloud Storage.</p>
            <div class="history-filters" aria-label="Filtros historial reportes">
              <label>
                Job
                <select id="reportRunsJobFilter">
                  <option value="">Todos los jobs</option>
                </select>
              </label>
              <label>
                Estado
                <select id="reportRunsStatusFilter">
                  <option value="">Todos los estados</option>
                </select>
              </label>
            </div>
            <div class="history-controls" aria-label="Controles de actualización">
              <label class="history-toggle">
                <input type="checkbox" id="reportRunsAutoRefreshToggle">
                <span>Auto-actualizar</span>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);">
                Frecuencia
                <select id="reportRunsAutoRefreshInterval">
                  <option value="60000">1 minuto</option>
                  <option value="180000">3 minutos</option>
                  <option value="300000" selected>5 minutos</option>
                  <option value="600000">10 minutos</option>
                </select>
              </label>
              <span class="row-subtext" id="reportRunsAutoRefreshStatus">Actualización manual.</span>
            </div>
            <div class="history-summary" id="reportRunsSummary" hidden>
              <div class="summary-pill">
                <span class="summary-label">Total runs</span>
                <span class="summary-value" id="reportRunsTotal">0</span>
                <span class="row-subtext" id="reportRunsRange">–</span>
              </div>
              <div class="summary-pill">
                <span class="summary-label">Éxitos</span>
                <span class="summary-value" id="reportRunsSuccess">0</span>
                <span class="row-subtext" id="reportRunsSuccessPct">0%</span>
              </div>
              <div class="summary-pill">
                <span class="summary-label">Fallos</span>
                <span class="summary-value" id="reportRunsErrors">0</span>
                <span class="row-subtext" id="reportRunsErrorsPct">0%</span>
              </div>
              <div class="summary-pill">
                <span class="summary-label">Último estado</span>
                <span class="summary-value" id="reportRunsLastStatus">–</span>
                <span class="row-subtext" id="reportRunsLastWhen">–</span>
              </div>
            </div>
            <div class="table-wrapper" style="margin-top: 12px; max-height: 240px;">
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Job / Preset</th>
                    <th>Estado</th>
                    <th>Formatos</th>
                    <th>Notifs.</th>
                  </tr>
                </thead>
                <tbody id="reportRunsTableBody"></tbody>
              </table>
            </div>
            <p id="reportRunsEmpty" style="margin: 12px 0 0; font-size: 0.8rem; color: var(--text-muted);" hidden>Usa el botón «Actualizar» para cargar ejecuciones recientes.</p>
          </section>
        </aside>

        <aside class="controls hidden" id="citizenControls">
          <!-- Explorar: Encabezado y botón -->
          <section class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%); border: 2px solid rgba(59, 130, 246, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
              <div style="flex: 1;">
                <h2 style="margin: 0 0 6px; font-size: 1.4rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 1.8rem;">🗺️</span>
                  Explorar Reportes
                </h2>
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted); line-height: 1.4;">
                  Mapa temático con clustering, filtros avanzados y búsqueda inteligente
                </p>
              </div>
              <button type="button" class="button-primary" id="openNewReportModal" style="padding: 14px 24px; font-size: 1rem; border-radius: 50px; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4); white-space: nowrap;">
                ➕ Nuevo Reporte
              </button>
            </div>
          </section>

          <!-- Indicadores principales -->
          <section class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 14px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; color: var(--text-muted);">
              📊 Resumen General
            </h3>
            <div class="explore-indicators" id="exploreIndicators"></div>
          </section>
            
          <!-- Filtros de exploración -->
          <section class="card">
            <h3 style="margin: 0 0 14px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; color: var(--text-muted);">
              🔍 Filtros de Búsqueda
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <!-- Barra de búsqueda -->
              <div class="explore-search-icon" style="width: 100%;">
                <input type="search" id="exploreSearch" placeholder="Buscar por descripción, barrio, categoría..." style="width: 100%; padding: 10px 10px 10px 36px; font-size: 0.9rem;">
              </div>
              
              <!-- Filtros en grid -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                <div>
                  <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted);">Categoría</label>
                  <select id="exploreFilterCategory" style="width: 100%; padding: 8px; font-size: 0.85rem;">
                    <option value="">Todas</option>
                    <option value="green">🌳 Áreas verdes</option>
                    <option value="heat">🔥 Calor</option>
                    <option value="flooding">💧 Inundación</option>
                    <option value="waste">🗑️ Basura</option>
                    <option value="air">🌫️ Aire</option>
                    <option value="water">🚰 Agua</option>
                    <option value="other">📌 Otro</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted);">Severidad</label>
                  <select id="exploreFilterSeverity" style="width: 100%; padding: 8px; font-size: 0.85rem;">
                    <option value="">Todas</option>
                    <option value="low">✅ Baja</option>
                    <option value="medium">⚠️ Media</option>
                    <option value="high">🚨 Alta</option>
                  </select>
                </div>
              </div>
              
              <!-- Rango de fechas -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                  <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted);">Desde</label>
                  <input type="date" id="exploreFilterDateFrom" style="width: 100%; padding: 8px; font-size: 0.85rem;">
                </div>
                <div>
                  <label style="display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted);">Hasta</label>
                  <input type="date" id="exploreFilterDateTo" style="width: 100%; padding: 8px; font-size: 0.85rem;">
                </div>
              </div>
              
              <!-- Botón reset -->
              <button type="button" id="exploreResetFilters" class="button-secondary" style="width: 100%; padding: 10px; font-size: 0.85rem;">
                🔄 Limpiar Filtros
              </button>
            </div>
          </section>
          
          <!-- Capas GEE -->
          <section class="card" style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2);">
            <h3 style="margin: 0 0 14px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; color: #8b5cf6; display: flex; align-items: center; gap: 8px;">
              <span>📡</span> Capas Satelitales (GEE)
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <div class="gee-layer-item">
                <input type="checkbox" id="layerNDVI" class="gee-layer-checkbox">
                <label for="layerNDVI" class="gee-layer-label">🌿 NDVI</label>
                <input type="range" id="opacityNDVI" class="gee-opacity-slider" min="0" max="100" value="70" disabled>
                <span id="opacityValueNDVI" style="font-size: 0.75rem; color: var(--text-muted); min-width: 35px;">70%</span>
              </div>
              
              <div class="gee-layer-item">
                <input type="checkbox" id="layerLST" class="gee-layer-checkbox">
                <label for="layerLST" class="gee-layer-label">🌡️ LST</label>
                <input type="range" id="opacityLST" class="gee-opacity-slider" min="0" max="100" value="60" disabled>
                <span id="opacityValueLST" style="font-size: 0.75rem; color: var(--text-muted); min-width: 35px;">60%</span>
              </div>
              
              <div class="gee-layer-item">
                <input type="checkbox" id="layerPM25" class="gee-layer-checkbox">
                <label for="layerPM25" class="gee-layer-label">🌫️ PM₂.₅</label>
                <input type="range" id="opacityPM25" class="gee-opacity-slider" min="0" max="100" value="65" disabled>
                <span id="opacityValuePM25" style="font-size: 0.75rem; color: var(--text-muted); min-width: 35px;">65%</span>
              </div>
              
              <div class="gee-layer-item">
                <input type="checkbox" id="layerNDWI" class="gee-layer-checkbox">
                <label for="layerNDWI" class="gee-layer-label">💧 NDWI</label>
                <input type="range" id="opacityNDWI" class="gee-opacity-slider" min="0" max="100" value="70" disabled>
                <span id="opacityValueNDWI" style="font-size: 0.75rem; color: var(--text-muted); min-width: 35px;">70%</span>
              </div>
              
              <button type="button" id="updateGeeLayers" class="button-primary" style="width: 100%; margin-top: 6px; padding: 10px; font-size: 0.85rem;">
                🔄 Actualizar Capas
              </button>
            </div>
          </section>
          
          <!-- Info del MVP (colapsada) -->
          <section class="card" style="border-left: 4px solid #10b981;">
            <details style="cursor: pointer;">
              <summary style="font-weight: 700; font-size: 0.9rem; color: #10b981; display: flex; align-items: center; gap: 8px; user-select: none;">
                <span style="font-size: 1.3rem;">🎯</span>
                Acerca del MVP Ciudadano
              </summary>
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                <p style="margin: 0 0 12px; font-size: 0.85rem; line-height: 1.6; color: var(--text-muted);">
                  Reporta problemas ambientales en <strong>3 pasos simples</strong>: categoría → ubicación → enviar. 
                  Tus observaciones ayudan a <strong>calibrar y validar</strong> índices satelitales (NDVI, LST, PM₂.₅, NDWI).
                </p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                  <div style="background: rgba(59,130,246,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 4px;">📊</div>
                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--text);">Validación</div>
                  </div>
                  <div style="background: rgba(59,130,246,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 4px;">🗺️</div>
                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--text);">Georref.</div>
                  </div>
                  <div style="background: rgba(59,130,246,0.1); padding: 8px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 1.3rem; margin-bottom: 4px;">📸</div>
                    <div style="font-size: 0.7rem; font-weight: 600; color: var(--text);">Evidencia</div>
                  </div>
                </div>
              </div>
            </details>
          </section>                Reporta problemas ambientales en <strong>3 pasos simples</strong>: categoría → ubicación → enviar. 
                Tus observaciones ayudan a <strong>calibrar y validar</strong> índices satelitales (NDVI, LST, PM₂.₅, NDWI).
              </p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 16px;">
                <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; margin-bottom: 4px;">📊</div>
                  <div style="font-size: 0.75rem; font-weight: 600; color: var(--text);">Validación de modelos</div>
                </div>
                <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; margin-bottom: 4px;">🗺️</div>
                  <div style="font-size: 0.75rem; font-weight: 600; color: var(--text);">Datos georref.</div>
                </div>
                <div style="background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5rem; margin-bottom: 4px;">📸</div>
                  <div style="font-size: 0.75rem; font-weight: 600; color: var(--text);">Evidencia visual</div>
                </div>
              </div>
            </div>

            <div class="card" style="padding: 16px; margin-bottom: 20px; border-left: 4px solid #10b981;">
              <h3 style="margin: 0 0 10px; font-size: 0.9rem; color: #10b981; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">
                ✅ Datos capturados
              </h3>
              <div style="display: grid; gap: 6px; font-size: 0.8rem; color: var(--text-muted);">
                <div>• <strong>Ubicación:</strong> Lat/Lon, intersección espacial con barrios</div>
                <div>• <strong>Categoría:</strong> Árboles, Calor, Inundación, Basura, Olores, Aire</div>
                <div>• <strong>Evidencia:</strong> Foto opcional, descripción, severidad</div>
                <div>• <strong>Seguimiento:</strong> Estado (Recibido → Validado → Derivado → Resuelto)</div>
                <div>• <strong>Cruce automático:</strong> SEDAC SUHI, PM₂.₅, acceso a espacio público</div>
              </div>
            </div>
          </section>

          <section class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h2 class="section-title" style="margin: 0;">Reportes Recientes</h2>
              <button type="button" class="button-secondary" id="refreshCitizenReports" style="padding: 6px 12px; font-size: 0.8rem;">
                🔄 Actualizar
              </button>
            </div>
            
            <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
              <select id="citizenReportsFilterCategory" style="padding: 6px 10px; font-size: 0.8rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface);">
                <option value="">Todas las categorías</option>
                <option value="green">🌳 Áreas verdes</option>
                <option value="heat">🔥 Calor</option>
                <option value="flooding">💧 Inundación</option>
                <option value="waste">🗑️ Basura</option>
                <option value="air">🌫️ Aire</option>
                <option value="water">🚰 Agua</option>
                <option value="other">📌 Otro</option>
              </select>
              
              <select id="citizenReportsFilterStatus" style="padding: 6px 10px; font-size: 0.8rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface);">
                <option value="">Todos los estados</option>
                <option value="received">Recibido</option>
                <option value="validated">Validado</option>
                <option value="in_progress">En ejecución</option>
                <option value="resolved">Resuelto</option>
              </select>
            </div>

            <div id="citizenReportsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 16px;"></div>
            
            <div id="citizenReportsEmpty" class="row-subtext" style="margin-top: 12px; text-align: center; padding: 32px; background: rgba(148, 163, 184, 0.05); border-radius: 8px; display: none;">
              <div style="font-size: 3rem; margin-bottom: 12px;">�</div>
              <div style="font-size: 0.95rem; color: var(--text); font-weight: 600; margin-bottom: 6px;">No hay reportes aún</div>
              <div style="font-size: 0.8rem;">Presiona "➕ Reportar" para crear el primer reporte</div>
            </div>
            <ul id="citizenReportsList" style="margin: 0; padding: 0; list-style: none; display: flex; flex-direction: column; gap: 10px;"></ul>
          </section>
        </aside>
      </div>

      <section class="map-panel">
        <div id="map"></div>

        <div id="bloomSummarySection">
          <div class="summary-grid">
            <div class="card summary-card">
              <h3>Área máxima detectada</h3>
              <div class="value" id="areaMax">–</div>
              <small>km² durante el periodo analizado</small>
            </div>
            <div class="card summary-card">
              <h3>Bloom más reciente</h3>
              <div class="value" id="areaLast">–</div>
              <small>km² registrados en la última escena libre de nubes</small>
            </div>
            <div class="card summary-card">
              <h3>Clorofila media</h3>
              <div class="value" id="chlorMean">–</div>
              <small>mg/m³ promedio regional (MODIS Aqua)</small>
            </div>
            <div class="card summary-card">
              <h3>SST media</h3>
              <div class="value" id="sstMean">–</div>
              <small>°C promedio regional (NOAA OISST)</small>
            </div>
          </div>

          <div class="charts">
            <div class="card">
              <h3>Área con bloom (km²)</h3>
              <canvas id="areaChart"></canvas>
            </div>
            <div class="card">
              <h3>Clorofila-a regional (mg/m³)</h3>
              <canvas id="chlorChart"></canvas>
            </div>
            <div class="card">
              <h3>Temperatura superficial del mar (°C)</h3>
              <canvas id="sstChart"></canvas>
            </div>
          </div>
        </div>

        <div id="ecoSummarySection" class="hidden">
          <div class="summary-grid">
            <div class="card summary-card">
              <h3>NDVI medio</h3>
              <div class="value" id="ecoNdviMean">–</div>
              <small>Rango: <span id="ecoNdviRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>LST media</h3>
              <div class="value" id="ecoLstMean">–</div>
              <small>Rango: <span id="ecoLstRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Índice de calor</h3>
              <div class="value" id="ecoHeatMean">–</div>
              <small>Rango: <span id="ecoHeatRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>AOD media</h3>
              <div class="value" id="ecoAodMean">–</div>
              <small>Rango: <span id="ecoAodRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Calidad del aire</h3>
              <div class="value" id="ecoAirQualityMean">–</div>
              <small>Índice (0-1). Rango: <span id="ecoAirQualityRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>NO₂ promedio</h3>
              <div class="value" id="ecoNo2Mean">–</div>
              <small>µmol·m⁻² troposféricos</small>
            </div>
            <div class="card summary-card">
              <h3>PM₂.₅ promedio</h3>
              <div class="value" id="ecoPm25Mean">–</div>
              <small>µg·m⁻³ estimados</small>
            </div>
            <div class="card summary-card">
              <h3>NDWI medio</h3>
              <div class="value" id="ecoNdwiMean">–</div>
              <small>Rango: <span id="ecoNdwiRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Impermeabilización</h3>
              <div class="value" id="ecoImperviousMean">–</div>
              <small>Rango: <span id="ecoImperviousRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Riesgo hídrico</h3>
              <div class="value" id="ecoWaterRiskMean">–</div>
              <small>Rango: <span id="ecoWaterRiskRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Áreas verdes per cápita</h3>
              <div class="value" id="ecoGreenPerCapitaMean">–</div>
              <small>Rango: <span id="ecoGreenPerCapitaRange">–</span> | Total: <span id="ecoGreenAreaTotal">–</span> ha</small>
            </div>
            <div class="card summary-card">
              <h3>Densidad poblacional</h3>
              <div class="value" id="ecoPopulationMean">–</div>
              <small>Máx.: <span id="ecoPopulationMax">–</span> | Total: <span id="ecoPopulationTotal">–</span> hab</small>
            </div>
            <div class="card summary-card">
              <h3>Déficit de áreas verdes</h3>
              <div class="value" id="ecoGreenDeficitRatio">–</div>
              <small>Población por debajo de 9 m²/hab</small>
            </div>
          </div>

          <div class="charts">
            <div class="card">
              <h3>NDVI (promedio)</h3>
              <canvas id="ecoNdviChart"></canvas>
            </div>
            <div class="card">
              <h3>LST (°C)</h3>
              <canvas id="ecoLstChart"></canvas>
            </div>
            <div class="card">
              <h3>Aerosol Optical Depth</h3>
              <canvas id="ecoAodChart"></canvas>
            </div>
            <div class="card">
              <h3>NO₂ troposférico (µmol·m⁻²)</h3>
              <canvas id="ecoNo2Chart"></canvas>
            </div>
            <div class="card">
              <h3>PM₂.₅ (µg·m⁻³)</h3>
              <canvas id="ecoPm25Chart"></canvas>
            </div>
          </div>

          <div class="card" id="ecoBoundaryCard" hidden>
            <h3>Indicadores por distrito</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Distrito</th>
                    <th>NDVI medio</th>
                    <th>LST (°C)</th>
                    <th>Índice calor</th>
                    <th>Densidad</th>
                  </tr>
                </thead>
                <tbody id="ecoBoundaryBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    Construido con Google Earth Engine, Sentinel-2 SR, MODIS Aqua (L3SMI) y NOAA OISST V2. Ajusta parámetros por zona y valida con datos in situ.
  </footer>

  <div id="reportRunDetailsOverlay" class="modal-overlay" hidden tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="reportRunDetailsTitle">
  <button type="button" class="modal-close-button" id="closeReportRunDetails" data-action="close-report-run-details" aria-label="Cerrar detalles">×</button>
      <div class="modal-header">
        <div>
          <div class="modal-subtitle" id="reportRunDetailsJob">Job</div>
          <h3 class="modal-title" id="reportRunDetailsTitle">Detalle de ejecución</h3>
        </div>
        <span class="status-pill neutral" id="reportRunDetailsStatus">Estado</span>
      </div>
      <div class="modal-body" id="reportRunDetailsBody"></div>
      <div class="modal-footer">
        <button type="button" class="button-secondary" data-action="close-report-run-details">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal simplificado MVP para reportes ciudadanos -->
  <div id="newReportModal" class="modal-overlay" hidden tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" style="max-width: 520px;">
      <button type="button" class="modal-close-button" id="closeNewReportModal" aria-label="Cerrar">×</button>
      
      <div class="modal-header" style="border-bottom: 2px solid var(--border); padding-bottom: 16px;">
        <div>
          <h3 class="modal-title" style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.8rem;">📝</span>
            Nuevo Reporte
          </h3>
          <p style="margin: 6px 0 0; font-size: 0.85rem; color: var(--text-muted);">
            3 pasos simples para reportar
          </p>
        </div>
      </div>

      <div class="modal-body" style="padding: 24px 0;">
        <!-- Indicador de pasos -->
        <div id="reportStepsIndicator" style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
          <div class="step-indicator active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Categoría</div>
          </div>
          <div class="step-connector"></div>
          <div class="step-indicator" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Ubicación</div>
          </div>
          <div class="step-connector"></div>
          <div class="step-indicator" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Detalles</div>
          </div>
        </div>

        <form id="newReportForm">
          <!-- PASO 1: Categoría -->
          <div class="report-step" data-step="1">
            <h4 style="margin: 0 0 16px; font-size: 1.1rem; text-align: center; color: var(--text);">
              ¿Qué tipo de problema observas?
            </h4>
            <div id="categoryGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <button type="button" class="category-card" data-category="green">
                <span class="category-icon">🌳</span>
                <span class="category-name">Árboles / Áreas verdes</span>
              </button>
              <button type="button" class="category-card" data-category="heat">
                <span class="category-icon">🔥</span>
                <span class="category-name">Calor extremo</span>
              </button>
              <button type="button" class="category-card" data-category="flooding">
                <span class="category-icon">💧</span>
                <span class="category-name">Inundación</span>
              </button>
              <button type="button" class="category-card" data-category="waste">
                <span class="category-icon">🗑️</span>
                <span class="category-name">Basura</span>
              </button>
              <button type="button" class="category-card" data-category="air">
                <span class="category-icon">🌫️</span>
                <span class="category-name">Aire / Olores</span>
              </button>
              <button type="button" class="category-card" data-category="water">
                <span class="category-icon">🚰</span>
                <span class="category-name">Agua</span>
              </button>
            </div>
          </div>

          <!-- PASO 2: Ubicación -->
          <div class="report-step hidden" data-step="2">
            <h4 style="margin: 0 0 12px; font-size: 1.1rem; text-align: center; color: var(--text);">
              📍 ¿Dónde ocurre el problema?
            </h4>
            
            <!-- Mapa integrado -->
            <div class="modal-map-container">
              <div id="modalMapInstructions" class="modal-map-instructions" style="display: none;">
                👆 Haz clic en el mapa para marcar la ubicación
              </div>
              <div id="modalMap"></div>
            </div>

            <!-- Coordenadas manuales -->
            <div class="location-input-group">
              <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Latitud</label>
                <input type="number" id="modalLatitude" name="latitude" step="0.000001" placeholder="-12.046373" readonly style="cursor: pointer;">
              </div>
              <div>
                <label style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Longitud</label>
                <input type="number" id="modalLongitude" name="longitude" step="0.000001" placeholder="-77.042754" readonly style="cursor: pointer;">
              </div>
            </div>

            <!-- Botones de acción -->
            <div class="location-buttons">
              <button type="button" id="useMyLocationBtn" class="button-secondary">
                📍 Mi ubicación
              </button>
              <button type="button" id="centerMapBtn" class="button-secondary">
                🎯 Centrar Lima
              </button>
            </div>

            <div style="padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 0.8rem; color: var(--text-muted); text-align: center;">
              <strong style="color: #3b82f6;">💡 Tip:</strong> Usa zoom (+/-) y arrastra el mapa. Los datos se guardan automáticamente.
            </div>
          </div>

          <!-- PASO 3: Detalles -->
          <div class="report-step hidden" data-step="3">
            <h4 style="margin: 0 0 16px; font-size: 1.1rem; text-align: center; color: var(--text);">
              Agrega más información (opcional)
            </h4>

            <label style="display: block; margin-bottom: 16px;">
              <span style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem;">Descripción</span>
              <textarea name="description" id="modalDescription" rows="3" maxlength="500" placeholder="¿Qué observas? ¿Desde cuándo? ¿Qué tan grave es?" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; resize: vertical;"></textarea>
              <small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 0.75rem;">
                <span id="modalCharCount">0</span>/500 caracteres
              </small>
            </label>

            <label style="display: block; margin-bottom: 16px;">
              <span style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem;">📸 Foto (URL)</span>
              <input type="url" name="photoUrl" id="modalPhotoUrl" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem;">
              <small style="display: block; margin-top: 4px; color: var(--text-muted); font-size: 0.75rem;">
                Sube tu foto a imgur.com o similar y pega el enlace
              </small>
            </label>

            <label style="display: block; margin-bottom: 16px;">
              <span style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem;">Severidad</span>
              <select name="severity" id="modalSeverity" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem;">
                <option value="low">🟢 Baja - Molestia menor</option>
                <option value="medium" selected>🟡 Media - Problema recurrente</option>
                <option value="high">🔴 Alta - Urgente</option>
              </select>
            </label>

            <div style="background: rgba(59, 130, 246, 0.08); border-radius: 8px; padding: 12px; font-size: 0.8rem; color: var(--text-muted);">
              <strong style="color: #3b82f6;">🔐 Privacidad:</strong> Los reportes son anónimos. Solo guardamos ubicación, categoría y descripción para análisis.
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer" style="display: flex; gap: 10px; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 16px;">
        <button type="button" id="prevStepBtn" class="button-secondary" style="display: none;">
          ← Anterior
        </button>
        <div style="flex: 1;"></div>
        <button type="button" id="nextStepBtn" class="button-primary" disabled>
          Siguiente →
        </button>
        <button type="submit" form="newReportForm" id="submitReportBtn" class="button-primary" style="display: none;">
          📤 Enviar Reporte
        </button>
      </div>

      <div id="reportSuccess" style="display: none; text-align: center; padding: 32px;">
        <div style="font-size: 4rem; margin-bottom: 16px;">✅</div>
        <h3 style="margin: 0 0 8px; color: #10b981;">¡Reporte Enviado!</h3>
        <p style="margin: 0 0 16px; font-size: 0.9rem; color: var(--text-muted);">
          Código: <strong id="reportCode" style="font-family: monospace; color: var(--text);">-</strong>
        </p>
        <button type="button" id="closeSuccessBtn" class="button-primary">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script src="vendor/leaflet/leaflet.js"></script>
  <script src="vendor/leaflet-markercluster/leaflet.markercluster.js"></script>
  <script src="vendor/chart/chart.umd.js"></script>
  <script>
    const BLOOM_PRESETS_LOCAL = [
      {
        id: 'costa_metropolitana',
        label: 'Costa Metropolitana de Lima',
        type: 'mar',
        defaultBuffer: 400
      },
      {
        id: 'ancon',
        label: 'Bahía de Ancón',
        type: 'mar',
        defaultBuffer: 200
      },
      {
        id: 'pantanos',
        label: 'Pantanos de Villa',
        type: 'humedal',
        defaultBuffer: -200
      }
    ];

    const ECO_PRESETS_LOCAL = [
      {
        id: 'lima_metropolitana',
        label: 'Lima Metropolitana',
        type: 'urbano',
        defaultBuffer: 0
      },
      {
        id: 'lima_centro',
        label: 'Lima Centro',
        type: 'urbano',
        defaultBuffer: 0
      },
      {
        id: 'callao',
        label: 'Callao',
        type: 'urbano',
        defaultBuffer: 0
      }
    ];

    const baseLayers = {};
    let overlayLayers = {};
    let layerControl;
    let map;
    let areaChartInstance;
    let chlorChartInstance;
    let sstChartInstance;
  let ecoNdviChartInstance;
  let ecoLstChartInstance;
  let ecoAodChartInstance;
  let ecoNo2ChartInstance;
  let ecoPm25ChartInstance;
    let roiLayer;
    let contextLayer;
    let currentMode = 'bloom';
    let bloomInitialized = false;
    let ecoInitialized = false;
  let lastBloomResult = null;
  let lastEcoResult = null;

    const statusLogs = {
      bloom: document.getElementById('statusLog'),
      ecoplan: document.getElementById('ecoStatusLog')
    };
    const layerBadgesContainer = document.getElementById('layerBadges');
    const bloomRunButton = document.getElementById('runButton');
    const ecoRunButton = document.getElementById('ecoRunButton');
    const quickViewButton = document.getElementById('quickViewButton');
    const headerLoader = document.getElementById('headerLoader');
    const modeButtons = document.querySelectorAll('.mode-button');
    const bloomControls = document.getElementById('bloomControls');
    const ecoControls = document.getElementById('ecoControls');
    const bloomSummarySection = document.getElementById('bloomSummarySection');
    const ecoSummarySection = document.getElementById('ecoSummarySection');

    const ecoSummaryEls = {
      ndviMean: document.getElementById('ecoNdviMean'),
      ndviRange: document.getElementById('ecoNdviRange'),
      lstMean: document.getElementById('ecoLstMean'),
      lstRange: document.getElementById('ecoLstRange'),
      heatMean: document.getElementById('ecoHeatMean'),
      heatRange: document.getElementById('ecoHeatRange'),
      airQualityMean: document.getElementById('ecoAirQualityMean'),
      airQualityRange: document.getElementById('ecoAirQualityRange'),
      aodMean: document.getElementById('ecoAodMean'),
      aodRange: document.getElementById('ecoAodRange'),
      ndwiMean: document.getElementById('ecoNdwiMean'),
      ndwiRange: document.getElementById('ecoNdwiRange'),
      imperviousMean: document.getElementById('ecoImperviousMean'),
      imperviousRange: document.getElementById('ecoImperviousRange'),
      waterRiskMean: document.getElementById('ecoWaterRiskMean'),
      waterRiskRange: document.getElementById('ecoWaterRiskRange'),
      greenPerCapitaMean: document.getElementById('ecoGreenPerCapitaMean'),
      greenPerCapitaRange: document.getElementById('ecoGreenPerCapitaRange'),
      greenAreaTotal: document.getElementById('ecoGreenAreaTotal'),
      greenDeficitRatio: document.getElementById('ecoGreenDeficitRatio'),
      no2Mean: document.getElementById('ecoNo2Mean'),
      pm25Mean: document.getElementById('ecoPm25Mean'),
      populationMean: document.getElementById('ecoPopulationMean'),
      populationMax: document.getElementById('ecoPopulationMax'),
      populationTotal: document.getElementById('ecoPopulationTotal'),
      boundaryCard: document.getElementById('ecoBoundaryCard'),
      boundaryBody: document.getElementById('ecoBoundaryBody')
    };

  const ecoReportButtons = Array.from(document.querySelectorAll('[data-report-format]'));
  const reportRunsTableBody = document.getElementById('reportRunsTableBody');
  const reportRunsEmptyMessage = document.getElementById('reportRunsEmpty');
  const refreshReportRunsButton = document.getElementById('refreshReportRuns');
  const reportRunsJobFilter = document.getElementById('reportRunsJobFilter');
  const reportRunsStatusFilter = document.getElementById('reportRunsStatusFilter');
  const reportRunsAutoRefreshToggle = document.getElementById('reportRunsAutoRefreshToggle');
  const reportRunsAutoRefreshIntervalSelect = document.getElementById('reportRunsAutoRefreshInterval');
  const reportRunsAutoRefreshStatusEl = document.getElementById('reportRunsAutoRefreshStatus');
  const reportRunsSummary = document.getElementById('reportRunsSummary');
  const reportRunsTotalEl = document.getElementById('reportRunsTotal');
  const reportRunsRangeEl = document.getElementById('reportRunsRange');
  const reportRunsSuccessEl = document.getElementById('reportRunsSuccess');
  const reportRunsSuccessPctEl = document.getElementById('reportRunsSuccessPct');
  const reportRunsErrorsEl = document.getElementById('reportRunsErrors');
  const reportRunsErrorsPctEl = document.getElementById('reportRunsErrorsPct');
  const reportRunsLastStatusEl = document.getElementById('reportRunsLastStatus');
  const reportRunsLastWhenEl = document.getElementById('reportRunsLastWhen');
  const reportRunDetailsOverlay = document.getElementById('reportRunDetailsOverlay');
  const reportRunDetailsBody = document.getElementById('reportRunDetailsBody');
  const reportRunDetailsTitle = document.getElementById('reportRunDetailsTitle');
  const reportRunDetailsJob = document.getElementById('reportRunDetailsJob');
  const reportRunDetailsStatus = document.getElementById('reportRunDetailsStatus');
  const closeReportRunDetailsButton = document.getElementById('closeReportRunDetails');
  const citizenReportForm = document.getElementById('citizenReportForm');
  const citizenReportCategorySelect = document.getElementById('citizenReportCategory');
  const citizenReportDescriptionInput = document.getElementById('citizenReportDescription');
  const citizenReportLatitudeInput = document.getElementById('citizenReportLatitude');
  const citizenReportLongitudeInput = document.getElementById('citizenReportLongitude');
  const citizenReportPhotoUrlInput = document.getElementById('citizenReportPhotoUrl');
  const citizenReportContactNameInput = document.getElementById('citizenReportContactName');
  const citizenReportContactEmailInput = document.getElementById('citizenReportContactEmail');
  const citizenReportSelectOnMapButton = document.getElementById('citizenReportSelectOnMap');
  const citizenReportStatusEl = document.getElementById('citizenReportStatus');
  const citizenReportLocationHelp = document.getElementById('citizenReportLocationHelp');
  const citizenReportsList = document.getElementById('citizenReportsList');
  const citizenReportsEmptyMessage = document.getElementById('citizenReportsEmpty');
  const refreshCitizenReportsButton = document.getElementById('refreshCitizenReports');
  const citizenReportSubmitButton = document.getElementById('citizenReportSubmit');
  const refreshReportRunsDefaultText = refreshReportRunsButton ? refreshReportRunsButton.textContent : '';
  const defaultReportRunsEmptyText = reportRunsEmptyMessage ? reportRunsEmptyMessage.textContent : '';
  let reportRunsLoaded = false;
  let reportRunsLoading = false;
  let reportRunsFetchQueued = false;
  const REPORT_RUNS_LIMIT = 20;
  let reportRunsCurrentLimit = REPORT_RUNS_LIMIT;
  const reportRunsFilterState = { jobId: '', status: '' };
  const reportRunsJobLabels = new Map();
  const reportRunsStatusSet = new Set();
  let reportRunsLastResponse = [];
  const MODE_STORAGE_KEY = 'gee-dashboard-mode';
  const REPORT_RUNS_AUTO_REFRESH_STORAGE_KEY = 'ecoplan-report-runs-auto-refresh';
  const DEFAULT_AUTO_REFRESH_INTERVAL_MS = 300000;
  let reportRunsAutoRefreshEnabled = false;
  let reportRunsAutoRefreshIntervalMs = DEFAULT_AUTO_REFRESH_INTERVAL_MS;
  let reportRunsAutoRefreshTimer = null;
  let reportRunsLastUpdatedAt = null;
  let reportRunDetailsActiveId = null;
  let citizenReports = [];
  let citizenReportsLoaded = false;
  let citizenReportsLoading = false;
  let citizenReportCaptureMode = false;
  let citizenReportMarkersLayer = null;
  let citizenReportLocationMarker = null;
  let citizenReportSubmitting = false;
  const citizenReportCategoryDescriptors = {
    heat: { label: 'Calor extremo', color: '#f97316' },
    green: { label: 'Déficit de áreas verdes', color: '#16a34a' },
    flooding: { label: 'Inundación / aniego', color: '#0ea5e9' },
    water: { label: 'Calidad del agua', color: '#2563eb' },
    air: { label: 'Calidad del aire', color: '#8b5cf6' },
    waste: { label: 'Residuos / basura', color: '#6b7280' },
    other: { label: 'Otra incidencia', color: '#f59e0b' }
  };

  // Variables para el sistema "Explorar"
  let exploreMarkerCluster = null;
  let exploreFilters = {
    search: '',
    category: '',
    severity: '',
    dateFrom: '',
    dateTo: ''
  };
  let exploreFilteredReports = [];
  const exploreElements = {
    search: document.getElementById('exploreSearch'),
    filterCategory: document.getElementById('exploreFilterCategory'),
    filterSeverity: document.getElementById('exploreFilterSeverity'),
    filterDateFrom: document.getElementById('exploreFilterDateFrom'),
    filterDateTo: document.getElementById('exploreFilterDateTo'),
    resetFilters: document.getElementById('exploreResetFilters'),
    indicators: document.getElementById('exploreIndicators'),
    reportsList: document.getElementById('exploreReportsList'),
    reportsEmpty: document.getElementById('exploreReportsEmpty')
  };
  const geeLayerElements = {
    ndvi: { checkbox: document.getElementById('layerNDVI'), opacity: document.getElementById('opacityNDVI'), value: document.getElementById('opacityValueNDVI') },
    lst: { checkbox: document.getElementById('layerLST'), opacity: document.getElementById('opacityLST'), value: document.getElementById('opacityValueLST') },
    pm25: { checkbox: document.getElementById('layerPM25'), opacity: document.getElementById('opacityPM25'), value: document.getElementById('opacityValuePM25') },
    ndwi: { checkbox: document.getElementById('layerNDWI'), opacity: document.getElementById('opacityNDWI'), value: document.getElementById('opacityValueNDWI') }
  };
  let geeLayersVisible = { ndvi: false, lst: false, pm25: false, ndwi: false };
  let geeLayerObjects = { ndvi: null, lst: null, pm25: null, ndwi: null };

  // Variables para el mapa modal
  let modalMap = null;
  let modalMapMarker = null;
  let modalMapInitialized = false;


  // Variables para el nuevo modal MVP
  const newReportModal = document.getElementById('newReportModal');
  const openNewReportModalBtn = document.getElementById('openNewReportModal');
  const closeNewReportModalBtn = document.getElementById('closeNewReportModal');
  const newReportForm = document.getElementById('newReportForm');
  const prevStepBtn = document.getElementById('prevStepBtn');
  const nextStepBtn = document.getElementById('nextStepBtn');
  const submitReportBtn = document.getElementById('submitReportBtn');
  const modalSelectLocationBtn = document.getElementById('modalSelectLocation');
  const changeLocationBtn = document.getElementById('changeLocation');
  const locationPreview = document.getElementById('locationPreview');
  const reportSuccess = document.getElementById('reportSuccess');
  const closeSuccessBtn = document.getElementById('closeSuccessBtn');
  const modalDescriptionInput = document.getElementById('modalDescription');
  const modalCharCount = document.getElementById('modalCharCount');
  
  let currentStep = 1;
  let selectedCategory = null;
  let modalSelectedLocation = { lat: null, lon: null };
  let isSelectingLocationForModal = false;

    function varColor(name) {
      return getComputedStyle(document.body).getPropertyValue(name).trim();
    }

    function colorWithAlpha(color, alpha = 0.2) {
      if (!color) return `rgba(30, 123, 182, ${alpha})`;
      if (color.startsWith('rgba')) {
        const parts = color.split(',');
        parts[3] = ` ${alpha})`;
        return parts.join(',');
      }
      if (color.startsWith('rgb')) {
        return color.replace('rgb', 'rgba').replace(')', `, ${alpha})`);
      }
      if (color.startsWith('#')) {
        const hex = color.replace('#', '');
        const chunk = hex.length === 3 ? hex.split('').map((c) => c + c).join('') : hex;
        const intVal = parseInt(chunk, 16);
        const r = (intVal >> 16) & 255;
        const g = (intVal >> 8) & 255;
        const b = intVal & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      return `rgba(30, 123, 182, ${alpha})`;
    }

    function getFeatureArray(collectionOrArray) {
      if (!collectionOrArray) return [];
      if (Array.isArray(collectionOrArray)) return collectionOrArray;
      if (Array.isArray(collectionOrArray.features)) return collectionOrArray.features;
      return [];
    }

    function capitalize(word) {
      if (typeof word !== 'string' || !word.length) {
        return '';
      }
      return word.charAt(0).toUpperCase() + word.slice(1);
    }

    function averageNumeric(values) {
      const valid = values.filter((value) => typeof value === 'number' && !Number.isNaN(value));
      if (!valid.length) return null;
      return valid.reduce((sum, value) => sum + value, 0) / valid.length;
    }

    function logStatus(message, type = 'info', mode = currentMode) {
      const time = new Date().toLocaleTimeString('es-PE', { hour12: false });
      const line = document.createElement('div');
      const colors = {
        info: varColor('--text-muted'),
        success: varColor('--success'),
        warning: varColor('--warning'),
        error: varColor('--error')
      };
      line.style.color = colors[type] || colors.info;
      line.textContent = `[${time}] ${message}`;
      const container = statusLogs[mode];
      if (container) {
        container.prepend(line);
      }
    }

    function setLoading(isLoading, mode = currentMode) {
      if (mode === 'bloom') {
        if (bloomRunButton) bloomRunButton.disabled = isLoading;
      } else if (mode === 'ecoplan') {
        if (ecoRunButton) ecoRunButton.disabled = isLoading;
      }
      headerLoader.hidden = !isLoading;
      if (isLoading) {
        logStatus('Procesando solicitud...', 'info', mode);
      }
    }

    function formatDateTimeLabel(value) {
      if (!value) {
        return '—';
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return String(value);
      }
      try {
        return date.toLocaleString('es-PE', {
          dateStyle: 'medium',
          timeStyle: 'short'
        });
      } catch (error) {
        return date.toISOString();
      }
    }

    function formatDurationLabel(durationMs) {
      if (!Number.isFinite(durationMs) || durationMs <= 0) {
        return null;
      }
      const totalSeconds = Math.round(durationMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      const parts = [];
      if (hours) parts.push(`${hours}h`);
      if (minutes) parts.push(`${minutes}m`);
      if (seconds || parts.length === 0) parts.push(`${seconds}s`);
      return parts.join(' ');
    }

    function getStatusDescriptor(status) {
      const normalized = typeof status === 'string' ? status.toLowerCase() : '';
      switch (normalized) {
        case 'success':
          return { label: 'Completado', variant: 'success' };
        case 'partial':
          return { label: 'Parcial', variant: 'warning' };
        case 'error':
          return { label: 'Error', variant: 'error' };
        case 'running':
          return { label: 'En progreso', variant: 'neutral' };
        case 'queued':
          return { label: 'En cola', variant: 'neutral' };
        default:
          return { label: status ? status.toString() : 'Desconocido', variant: 'neutral' };
      }
    }

    function mapTagVariant(status) {
      const normalized = typeof status === 'string' ? status.toLowerCase() : '';
      if (normalized === 'success' || normalized === 'sent' || normalized === 'ok') {
        return 'success';
      }
      if (normalized === 'error' || normalized === 'failed') {
        return 'error';
      }
      if (normalized === 'partial' || normalized === 'warning' || normalized === 'pending') {
        return 'warning';
      }
      return 'neutral';
    }

    function renderReportRunsFilters() {
      if (reportRunsJobFilter) {
        const selectedJob = reportRunsFilterState.jobId || '';
        const jobEntries = Array.from(reportRunsJobLabels.entries())
          .map(([jobId, label]) => ({ jobId, label: label || jobId }))
          .sort((a, b) => a.label.localeCompare(b.label, 'es-PE', { sensitivity: 'base' }));

        reportRunsJobFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Todos los jobs';
        reportRunsJobFilter.appendChild(allOption);

        let hasCurrentJob = selectedJob === '';
        jobEntries.forEach(({ jobId, label }) => {
          const option = document.createElement('option');
          option.value = jobId;
          option.textContent = label;
          reportRunsJobFilter.appendChild(option);
          if (jobId === selectedJob) {
            hasCurrentJob = true;
          }
        });

        if (!hasCurrentJob && selectedJob) {
          const fallbackOption = document.createElement('option');
          fallbackOption.value = selectedJob;
          fallbackOption.textContent = selectedJob;
          fallbackOption.hidden = true;
          reportRunsJobFilter.appendChild(fallbackOption);
        }

        reportRunsJobFilter.value = selectedJob;
      }

      if (reportRunsStatusFilter) {
        const selectedStatus = reportRunsFilterState.status || '';
        const statuses = Array.from(reportRunsStatusSet)
          .filter(Boolean)
          .sort((a, b) => a.localeCompare(b, 'es-PE', { sensitivity: 'base' }));

        reportRunsStatusFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Todos los estados';
        reportRunsStatusFilter.appendChild(allOption);

        let hasCurrentStatus = selectedStatus === '';
        statuses.forEach((statusValue) => {
          const descriptor = getStatusDescriptor(statusValue);
          const option = document.createElement('option');
          option.value = statusValue;
          option.textContent = descriptor.label || statusValue;
          reportRunsStatusFilter.appendChild(option);
          if (statusValue === selectedStatus) {
            hasCurrentStatus = true;
          }
        });

        if (!hasCurrentStatus && selectedStatus) {
          const descriptor = getStatusDescriptor(selectedStatus);
          const fallbackOption = document.createElement('option');
          fallbackOption.value = selectedStatus;
          fallbackOption.textContent = descriptor.label || selectedStatus;
          fallbackOption.hidden = true;
          reportRunsStatusFilter.appendChild(fallbackOption);
        }

        reportRunsStatusFilter.value = selectedStatus;
      }
    }

    function updateReportRunsFilterOptions(runs) {
      if (!Array.isArray(runs)) {
        renderReportRunsFilters();
        return;
      }

      runs.forEach((run) => {
        if (run?.jobId) {
          const presetLabel = run?.presetName || run?.presetId;
          const displayLabel = presetLabel ? `${run.jobId} · ${presetLabel}` : run.jobId;
          const existingLabel = reportRunsJobLabels.get(run.jobId);
          if (!existingLabel || existingLabel === run.jobId) {
            reportRunsJobLabels.set(run.jobId, displayLabel);
          }
        }
        if (run?.status) {
          reportRunsStatusSet.add(run.status);
        }
      });

      renderReportRunsFilters();
    }

    function formatBytes(bytes) {
      const value = Number(bytes);
      if (!Number.isFinite(value) || value < 0) {
        return null;
      }
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = value;
      let index = 0;
      while (size >= 1024 && index < units.length - 1) {
        size /= 1024;
        index += 1;
      }
      const decimals = size < 10 && index > 0 ? 1 : 0;
      return `${size.toFixed(decimals)} ${units[index]}`;
    }

    function humanizeKey(key) {
      if (!key) {
        return '';
      }
      const withSpaces = key
        .toString()
        .replace(/[_-]+/g, ' ')
        .replace(/([a-z\d])([A-Z])/g, '$1 $2')
        .replace(/\s{2,}/g, ' ')
        .trim();
      return withSpaces.split(' ').map((word) => {
        if (!word.length) return word;
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
      }).join(' ');
    }

    function buildKeyValueGrid(entries = []) {
      const container = document.createElement('div');
      container.className = 'key-value-grid';
      entries.forEach(({ label, value }) => {
        if (value === undefined || value === null || value === '') {
          return;
        }
        const wrapper = document.createElement('div');
        const labelSpan = document.createElement('span');
        labelSpan.className = 'key-label';
        labelSpan.textContent = label;
        const valueSpan = document.createElement('span');
        valueSpan.className = 'key-value';
        valueSpan.textContent = value;
        wrapper.append(labelSpan, valueSpan);
        container.appendChild(wrapper);
      });
      return container;
    }

    function createEmptyMessage(text) {
      const paragraph = document.createElement('p');
      paragraph.className = 'row-subtext';
      paragraph.style.margin = '0';
      paragraph.textContent = text;
      return paragraph;
    }

    function createResultsList(results) {
      if (!Array.isArray(results) || !results.length) {
        return null;
      }

      const list = document.createElement('div');
      list.className = 'results-list';

      results.forEach((result) => {
        const item = document.createElement('div');
        item.className = 'result-item';

        const main = document.createElement('div');
        main.className = 'result-item-main';
        const title = document.createElement('div');
        title.style.fontWeight = '600';
  title.textContent = (result?.format || 'Formato').toString().toUpperCase();
        main.appendChild(title);

        const metaParts = [];
        const sizeLabel = formatBytes(result?.bytes);
        if (sizeLabel) {
          metaParts.push(sizeLabel);
        }
        if (result?.gcs?.bucket && result?.gcs?.path) {
          metaParts.push(`${result.gcs.bucket}/${result.gcs.path}`);
        }
        if (result?.error) {
          metaParts.push(`Error: ${result.error}`);
        }
        if (metaParts.length) {
          const subtitle = document.createElement('span');
          subtitle.className = 'row-subtext';
          subtitle.textContent = metaParts.join(' · ');
          main.appendChild(subtitle);
        }

        item.appendChild(main);

        const actions = document.createElement('div');
        actions.className = 'result-item-actions';
        const descriptor = getStatusDescriptor(result?.status);
        const statusTag = createTagElement(descriptor.label, mapTagVariant(result?.status));
        actions.appendChild(statusTag);
        if (result?.gcs?.publicUrl) {
          const link = document.createElement('a');
          link.href = result.gcs.publicUrl;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'Abrir';
          actions.appendChild(link);
        }
        item.appendChild(actions);

        list.appendChild(item);
      });

      return list;
    }

    function createNotificationsList(notifications) {
      if (!notifications || typeof notifications !== 'object' || !Object.keys(notifications).length) {
        return null;
      }

      const list = document.createElement('div');
      list.className = 'notifications-list';

      Object.entries(notifications).forEach(([channel, info]) => {
        const item = document.createElement('div');
        item.className = 'notification-item';

        const main = document.createElement('div');
        main.className = 'notification-item-main';
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.textContent = channel === 'email' ? 'Email' : channel === 'slack' ? 'Slack' : humanizeKey(channel);
        main.appendChild(title);

        const details = [];
        if (Array.isArray(info?.recipients) && info.recipients.length) {
          details.push(`Destinatarios: ${info.recipients.join(', ')}`);
        }
        if (info?.error) {
          details.push(`Error: ${info.error}`);
        } else if (info?.reason) {
          details.push(`Motivo: ${info.reason}`);
        }
        if (details.length) {
          const subtitle = document.createElement('span');
          subtitle.className = 'row-subtext';
          subtitle.textContent = details.join(' · ');
          main.appendChild(subtitle);
        }

        item.appendChild(main);

        const actions = document.createElement('div');
        actions.className = 'notification-item-actions';
        const statusTag = createTagElement(translateNotificationStatus(info?.status), mapTagVariant(info?.status));
        actions.appendChild(statusTag);
        item.appendChild(actions);

        list.appendChild(item);
      });

      return list;
    }

    function formatPercentage(part, total) {
      if (!Number.isFinite(part) || !Number.isFinite(total) || total <= 0) {
        return '0%';
      }
      const percentage = (part / total) * 100;
      return `${percentage.toFixed(percentage >= 99 || percentage === 0 ? 0 : 1)}%`;
    }

    function formatCoordinate(value) {
      if (!Number.isFinite(Number(value))) {
        return '—';
      }
      return Number(value).toFixed(4);
    }

    function getCitizenReportCategoryDescriptor(category) {
      const key = typeof category === 'string' ? category.toLowerCase() : '';
      return citizenReportCategoryDescriptors[key] || {
        label: key ? capitalize(key) : 'Incidencia',
        color: '#64748b'
      };
    }

    function updateCitizenReportStatus(message, type = 'info') {
      if (!citizenReportStatusEl) {
        return;
      }
      const palette = {
        info: varColor('--text-muted'),
        success: varColor('--success'),
        warning: varColor('--warning'),
        error: varColor('--error')
      };
      const resolvedType = type === 'idle' ? 'info' : type;
      citizenReportStatusEl.style.color = palette[resolvedType] || palette.info;
      citizenReportStatusEl.textContent = message || '';
    }

    function setCitizenReportCaptureMode(enabled) {
      citizenReportCaptureMode = Boolean(enabled);
      if (!citizenReportLocationHelp) {
        return;
      }
      if (citizenReportCaptureMode) {
        citizenReportLocationHelp.textContent = 'Haz click en el mapa para fijar la ubicación del reporte.';
        citizenReportLocationHelp.style.color = varColor('--warning');
      } else {
        citizenReportLocationHelp.textContent = 'Haz click en el mapa para fijar la ubicación.';
        citizenReportLocationHelp.style.color = varColor('--text-muted');
      }
    }

    function setCitizenReportLocation(lat, lng, { center = false } = {}) {
      if (!citizenReportLatitudeInput || !citizenReportLongitudeInput) {
        return;
      }
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
        return;
      }

      citizenReportLatitudeInput.value = Number(lat).toFixed(6);
      citizenReportLongitudeInput.value = Number(lng).toFixed(6);

      if (map) {
        if (!citizenReportLocationMarker) {
          citizenReportLocationMarker = L.circleMarker([lat, lng], {
            radius: 8,
            color: '#facc15',
            weight: 2,
            fillColor: '#facc15',
            fillOpacity: 0.35
          }).addTo(map);
        } else {
          citizenReportLocationMarker.setLatLng([lat, lng]);
        }

        if (center) {
          map.flyTo([lat, lng], Math.max(map.getZoom(), 15), { duration: 0.6 });
        }
      }

      setCitizenReportCaptureMode(false);
    }

    function focusCitizenReport(report) {
      if (!report || !map || !Number.isFinite(report.latitude) || !Number.isFinite(report.longitude)) {
        return;
      }
      const descriptor = getCitizenReportCategoryDescriptor(report.category);
      const latLng = [report.latitude, report.longitude];
      const targetZoom = Math.max(map.getZoom(), 15);
      map.flyTo(latLng, targetZoom, { duration: 0.7 });

      const popupContent = document.createElement('div');
      popupContent.style.maxWidth = '240px';
      const title = document.createElement('strong');
      title.textContent = descriptor.label;
      popupContent.appendChild(title);

      const body = document.createElement('div');
      body.style.marginTop = '6px';
      body.textContent = report.description;
      popupContent.appendChild(body);

      if (report.photoUrl) {
        const link = document.createElement('a');
        link.href = report.photoUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = 'Ver evidencia';
        link.style.display = 'inline-block';
        link.style.marginTop = '6px';
        popupContent.appendChild(link);
      }

      const time = document.createElement('div');
      time.className = 'row-subtext';
      time.style.marginTop = '6px';
      time.textContent = `Reportado: ${formatDateTimeLabel(report.createdAt)}`;
      popupContent.appendChild(time);

      L.popup({ maxWidth: 280 })
        .setLatLng(latLng)
        .setContent(popupContent)
        .openOn(map);
    }

    function renderCitizenReportMarkers(reports = []) {
      if (!map) {
        return;
      }
      if (!citizenReportMarkersLayer) {
        citizenReportMarkersLayer = L.layerGroup().addTo(map);
      } else {
        citizenReportMarkersLayer.clearLayers();
      }

      reports.forEach((report) => {
        if (!Number.isFinite(report?.latitude) || !Number.isFinite(report?.longitude)) {
          return;
        }
        const descriptor = getCitizenReportCategoryDescriptor(report.category);
        const marker = L.circleMarker([report.latitude, report.longitude], {
          radius: 6,
          color: descriptor.color,
          weight: 2,
          fillColor: descriptor.color,
          fillOpacity: 0.6
        });
        marker.on('click', () => focusCitizenReport(report));
  marker.bindTooltip(`${descriptor.label} · ${formatCoordinate(report.latitude)}, ${formatCoordinate(report.longitude)}`);
        citizenReportMarkersLayer.addLayer(marker);
      });
    }

    function createCitizenReportListItem(report) {
      const descriptor = getCitizenReportCategoryDescriptor(report.category);
      const item = document.createElement('li');
      item.style.display = 'flex';
      item.style.flexDirection = 'column';
      item.style.gap = '6px';
      item.style.padding = '10px 12px';
      item.style.border = `1px solid ${colorWithAlpha(descriptor.color, 0.35)}`;
      item.style.borderRadius = '8px';
      item.style.background = colorWithAlpha(descriptor.color, 0.12);

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';
      header.style.gap = '8px';

      const badge = document.createElement('span');
      badge.textContent = descriptor.label;
      badge.style.fontSize = '0.75rem';
      badge.style.fontWeight = '600';
      badge.style.padding = '4px 8px';
      badge.style.borderRadius = '999px';
      badge.style.background = colorWithAlpha(descriptor.color, 0.2);
      badge.style.color = descriptor.color;
      header.appendChild(badge);

      const coords = document.createElement('span');
      coords.className = 'row-subtext';
      coords.textContent = `${formatCoordinate(report.latitude)}, ${formatCoordinate(report.longitude)}`;
      header.appendChild(coords);

      item.appendChild(header);

      const description = document.createElement('div');
      description.style.fontSize = '0.85rem';
      description.style.lineHeight = '1.4';
      description.textContent = report.description;
      item.appendChild(description);

      if (report.contactName || report.contactEmail) {
        const contact = document.createElement('div');
        contact.className = 'row-subtext';
        const parts = [];
        if (report.contactName) {
          parts.push(report.contactName);
        }
        if (report.contactEmail) {
          parts.push(report.contactEmail);
        }
        contact.textContent = `Contacto: ${parts.join(' · ')}`;
        item.appendChild(contact);
      }

      const footer = document.createElement('div');
      footer.style.display = 'flex';
      footer.style.justifyContent = 'space-between';
      footer.style.alignItems = 'center';
      footer.style.gap = '8px';

      const time = document.createElement('span');
      time.className = 'row-subtext';
      time.textContent = formatDateTimeLabel(report.createdAt);
      footer.appendChild(time);

      const centerButton = document.createElement('button');
      centerButton.type = 'button';
      centerButton.className = 'button-secondary';
      centerButton.style.padding = '4px 10px';
      centerButton.style.fontSize = '0.75rem';
      centerButton.textContent = 'Ver en mapa';
      centerButton.addEventListener('click', () => focusCitizenReport(report));
      footer.appendChild(centerButton);

      item.appendChild(footer);

      return item;
    }

    // ========== FUNCIONES PARA EL SISTEMA "EXPLORAR" ==========
    
    function initializeExploreSystem() {
      // Crear cluster para markers
      if (typeof L.markerClusterGroup !== 'undefined') {
        exploreMarkerCluster = L.markerClusterGroup({
          chunkedLoading: true,
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true,
          maxClusterRadius: 50
        });
        map.addLayer(exploreMarkerCluster);
      }
      
      // Event listeners para filtros
      if (exploreElements.search) {
        exploreElements.search.addEventListener('input', debounce(() => {
          exploreFilters.search = exploreElements.search.value;
          applyExploreFilters();
        }, 300));
      }
      
      if (exploreElements.filterCategory) {
        exploreElements.filterCategory.addEventListener('change', () => {
          exploreFilters.category = exploreElements.filterCategory.value;
          applyExploreFilters();
        });
      }
      
      if (exploreElements.filterSeverity) {
        exploreElements.filterSeverity.addEventListener('change', () => {
          exploreFilters.severity = exploreElements.filterSeverity.value;
          applyExploreFilters();
        });
      }
      
      if (exploreElements.filterDateFrom) {
        exploreElements.filterDateFrom.addEventListener('change', () => {
          exploreFilters.dateFrom = exploreElements.filterDateFrom.value;
          applyExploreFilters();
        });
      }
      
      if (exploreElements.filterDateTo) {
        exploreElements.filterDateTo.addEventListener('change', () => {
          exploreFilters.dateTo = exploreElements.filterDateTo.value;
          applyExploreFilters();
        });
      }
      
      if (exploreElements.resetFilters) {
        exploreElements.resetFilters.addEventListener('click', resetExploreFilters);
      }
      
      // Event listeners para capas GEE
      Object.keys(geeLayerElements).forEach(layerKey => {
        const elements = geeLayerElements[layerKey];
        if (elements.checkbox) {
          elements.checkbox.addEventListener('change', () => {
            const checked = elements.checkbox.checked;
            geeLayersVisible[layerKey] = checked;
            if (elements.opacity) {
              elements.opacity.disabled = !checked;
            }
            if (checked) {
              loadGeeLayer(layerKey);
            } else {
              removeGeeLayer(layerKey);
            }
          });
        }
        
        if (elements.opacity) {
          elements.opacity.addEventListener('input', () => {
            const value = elements.opacity.value;
            if (elements.value) {
              elements.value.textContent = value + '%';
            }
            updateGeeLayerOpacity(layerKey, value / 100);
          });
        }
      });
      
      const updateGeeButton = document.getElementById('updateGeeLayers');
      if (updateGeeButton) {
        updateGeeButton.addEventListener('click', () => {
          Object.keys(geeLayersVisible).forEach(key => {
            if (geeLayersVisible[key]) {
              loadGeeLayer(key);
            }
          });
          logStatus('Capas GEE actualizadas', 'success', 'ecoplan');
        });
      }
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    function applyExploreFilters() {
      exploreFilteredReports = citizenReports.filter(report => {
        // Filtro de búsqueda
        if (exploreFilters.search) {
          const searchLower = exploreFilters.search.toLowerCase();
          const matchesSearch = 
            (report.description && report.description.toLowerCase().includes(searchLower)) ||
            (report.neighborhood && report.neighborhood.toLowerCase().includes(searchLower)) ||
            (report.category && report.category.toLowerCase().includes(searchLower));
          if (!matchesSearch) return false;
        }
        
        // Filtro de categoría
        if (exploreFilters.category && report.category !== exploreFilters.category) {
          return false;
        }
        
        // Filtro de severidad
        if (exploreFilters.severity && report.severity !== exploreFilters.severity) {
          return false;
        }
        
        // Filtro de fecha desde
        if (exploreFilters.dateFrom) {
          const reportDate = new Date(report.createdAt);
          const filterDate = new Date(exploreFilters.dateFrom);
          if (reportDate < filterDate) return false;
        }
        
        // Filtro de fecha hasta
        if (exploreFilters.dateTo) {
          const reportDate = new Date(report.createdAt);
          const filterDate = new Date(exploreFilters.dateTo);
          filterDate.setHours(23, 59, 59, 999); // Incluir todo el día
          if (reportDate > filterDate) return false;
        }
        
        return true;
      });
      
      renderExploreIndicators();
      renderExploreReportsList();
      renderExploreMarkers();
      
      logStatus(`Filtrados ${exploreFilteredReports.length} de ${citizenReports.length} reportes`, 'info', 'ecoplan');
    }
    
    function resetExploreFilters() {
      exploreFilters = {
        search: '',
        category: '',
        severity: '',
        dateFrom: '',
        dateTo: ''
      };
      
      if (exploreElements.search) exploreElements.search.value = '';
      if (exploreElements.filterCategory) exploreElements.filterCategory.value = '';
      if (exploreElements.filterSeverity) exploreElements.filterSeverity.value = '';
      if (exploreElements.filterDateFrom) exploreElements.filterDateFrom.value = '';
      if (exploreElements.filterDateTo) exploreElements.filterDateTo.value = '';
      
      applyExploreFilters();
    }
    
    function renderExploreIndicators() {
      if (!exploreElements.indicators) return;
      
      const reports = exploreFilteredReports.length > 0 ? exploreFilteredReports : citizenReports;
      
      // Calcular métricas
      const totalReports = reports.length;
      const categoryCounts = {};
      const severityCounts = { low: 0, medium: 0, high: 0 };
      const last7Days = reports.filter(r => {
        const date = new Date(r.createdAt);
        const now = new Date();
        const diff = now - date;
        return diff < 7 * 24 * 60 * 60 * 1000;
      }).length;
      
      reports.forEach(report => {
        categoryCounts[report.category] = (categoryCounts[report.category] || 0) + 1;
        if (report.severity && severityCounts.hasOwnProperty(report.severity)) {
          severityCounts[report.severity]++;
        }
      });
      
      const topCategory = Object.keys(categoryCounts).reduce((a, b) => 
        categoryCounts[a] > categoryCounts[b] ? a : b, 'other');
      
      const highSeverityCount = severityCounts.high;
      
      // Calcular tendencia (comparar últimos 7 días vs 7 días anteriores)
      const last14Days = reports.filter(r => {
        const date = new Date(r.createdAt);
        const now = new Date();
        const diff = now - date;
        return diff < 14 * 24 * 60 * 60 * 1000;
      }).length;
      const prev7Days = last14Days - last7Days;
      const trend = prev7Days > 0 ? ((last7Days - prev7Days) / prev7Days * 100).toFixed(0) : 0;
      const trendClass = trend > 0 ? 'positive' : trend < 0 ? 'negative' : '';
      const trendIcon = trend > 0 ? '📈' : trend < 0 ? '📉' : '➡️';
      
      exploreElements.indicators.innerHTML = `
        <div class="explore-indicator">
          <div class="explore-indicator-icon">📊</div>
          <div class="explore-indicator-value">${totalReports}</div>
          <div class="explore-indicator-label">Total Reportes</div>
        </div>
        
        <div class="explore-indicator">
          <div class="explore-indicator-icon">📅</div>
          <div class="explore-indicator-value">${last7Days}</div>
          <div class="explore-indicator-label">Últimos 7 días</div>
          <div class="explore-indicator-trend ${trendClass}">${trendIcon} ${Math.abs(trend)}%</div>
        </div>
        
        <div class="explore-indicator">
          <div class="explore-indicator-icon">${getCategoryIcon(topCategory)}</div>
          <div class="explore-indicator-value">${categoryCounts[topCategory] || 0}</div>
          <div class="explore-indicator-label">${getCategoryLabel(topCategory)}</div>
        </div>
        
        <div class="explore-indicator">
          <div class="explore-indicator-icon">🚨</div>
          <div class="explore-indicator-value">${highSeverityCount}</div>
          <div class="explore-indicator-label">Alta Severidad</div>
        </div>
      `;
    }
    
    function renderExploreReportsList() {
      if (!exploreElements.reportsList || !exploreElements.reportsEmpty) return;
      
      const reports = exploreFilteredReports.length > 0 ? exploreFilteredReports : citizenReports;
      
      exploreElements.reportsList.innerHTML = '';
      
      if (reports.length === 0) {
        exploreElements.reportsEmpty.style.display = 'block';
        exploreElements.reportsList.style.display = 'none';
        return;
      }
      
      exploreElements.reportsEmpty.style.display = 'none';
      exploreElements.reportsList.style.display = 'flex';
      
      // Ordenar por fecha (más recientes primero)
      const sortedReports = [...reports].sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
      );
      
      sortedReports.forEach(report => {
        const card = createReportCard(report);
        exploreElements.reportsList.appendChild(card);
      });
    }
    
    function createReportCard(report) {
      const card = document.createElement('div');
      card.className = 'report-card';
      card.dataset.reportId = report.id;
      
      const categoryIcon = getCategoryIcon(report.category);
      const categoryLabel = getCategoryLabel(report.category);
      const severityLabel = getSeverityLabel(report.severity);
      const severityClass = report.severity || 'low';
      
      const date = new Date(report.createdAt);
      const dateStr = formatDateTimeLabel(report.createdAt);
      
      card.innerHTML = `
        <div class="report-card-header">
          <div class="report-card-category">${categoryIcon} ${categoryLabel}</div>
          <div class="report-card-date">${dateStr}</div>
        </div>
        
        <div class="report-card-body">
          <div class="report-card-description">${report.description || 'Sin descripción'}</div>
          <div class="report-card-location">
            📍 ${report.latitude.toFixed(5)}, ${report.longitude.toFixed(5)}
            ${report.neighborhood ? ' · ' + report.neighborhood : ''}
          </div>
        </div>
        
        <div class="report-card-footer">
          <div class="report-card-severity ${severityClass}">
            ${getSeverityIcon(report.severity)} ${severityLabel}
          </div>
          <div class="report-card-actions">
            <button class="report-card-action" onclick="focusReportOnMap('${report.id}')">
              🗺️ Ver en mapa
            </button>
            ${report.photoUrl ? '<button class="report-card-action" onclick="viewReportPhoto(\'' + report.id + '\')">📸 Ver foto</button>' : ''}
          </div>
        </div>
      `;
      
      card.addEventListener('click', (e) => {
        if (!e.target.closest('.report-card-action')) {
          focusReportOnMap(report.id);
        }
      });
      
      return card;
    }
    
    function renderExploreMarkers() {
      if (!exploreMarkerCluster) return;
      
      exploreMarkerCluster.clearLayers();
      
      const reports = exploreFilteredReports.length > 0 ? exploreFilteredReports : citizenReports;
      
      reports.forEach(report => {
        const categoryIcon = getCategoryIcon(report.category);
        const marker = L.marker([report.latitude, report.longitude], {
          icon: L.divIcon({
            className: 'custom-marker-icon',
            html: `<div style="background: ${getCategoryColor(report.category)}; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${categoryIcon}</div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          })
        });
        
        const popupContent = `
          <div style="min-width: 200px;">
            <strong style="font-size: 1.1em;">${categoryIcon} ${getCategoryLabel(report.category)}</strong>
            <p style="margin: 8px 0;">${report.description || 'Sin descripción'}</p>
            <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">${formatDateTimeLabel(report.createdAt)}</div>
            <div style="font-size: 0.85em; color: #666;">Severidad: ${getSeverityLabel(report.severity)}</div>
            ${report.photoUrl ? '<div style="margin-top: 8px;"><img src="' + report.photoUrl + '" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 4px;" onerror="this.style.display=\'none\'"/></div>' : ''}
          </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.reportData = report;
        exploreMarkerCluster.addLayer(marker);
      });
    }
    
    function getCategoryIcon(category) {
      const icons = {
        green: '🌳',
        heat: '🔥',
        flooding: '💧',
        waste: '🗑️',
        air: '🌫️',
        water: '🚰',
        other: '📌'
      };
      return icons[category] || '📌';
    }
    
    function getCategoryLabel(category) {
      const labels = {
        green: 'Áreas verdes',
        heat: 'Calor',
        flooding: 'Inundación',
        waste: 'Basura',
        air: 'Aire',
        water: 'Agua',
        other: 'Otro'
      };
      return labels[category] || 'Otro';
    }
    
    function getCategoryColor(category) {
      const colors = {
        green: '#22c55e',
        heat: '#f97316',
        flooding: '#0ea5e9',
        waste: '#6b7280',
        air: '#8b5cf6',
        water: '#2563eb',
        other: '#f59e0b'
      };
      return colors[category] || '#f59e0b';
    }
    
    function getSeverityIcon(severity) {
      const icons = {
        low: '✅',
        medium: '⚠️',
        high: '🚨'
      };
      return icons[severity] || '✅';
    }
    
    function getSeverityLabel(severity) {
      const labels = {
        low: 'Baja',
        medium: 'Media',
        high: 'Alta'
      };
      return labels[severity] || 'Baja';
    }
    
    function focusReportOnMap(reportId) {
      const report = citizenReports.find(r => r.id === reportId);
      if (!report) return;
      
      map.setView([report.latitude, report.longitude], 16);
      
      // Encontrar el marker y abrir su popup
      if (exploreMarkerCluster) {
        exploreMarkerCluster.eachLayer(layer => {
          if (layer.reportData && layer.reportData.id === reportId) {
            exploreMarkerCluster.zoomToShowLayer(layer, () => {
              layer.openPopup();
            });
          }
        });
      }
      
      logStatus(`Enfocando reporte: ${getCategoryLabel(report.category)}`, 'info', 'ecoplan');
    }
    
    function viewReportPhoto(reportId) {
      const report = citizenReports.find(r => r.id === reportId);
      if (!report || !report.photoUrl) return;
      
      window.open(report.photoUrl, '_blank');
    }
    
    // Funciones para capas GEE
    async function loadGeeLayer(layerKey) {
      // Nota: Esta es una implementación básica. En producción, necesitarías
      // endpoints en tu servidor que generen tiles de GEE para cada capa
      
      removeGeeLayer(layerKey);
      
      const layerConfigs = {
        ndvi: {
          name: 'NDVI',
          endpoint: '/api/gee/ndvi-tiles',
          attribution: 'NDVI - Google Earth Engine'
        },
        lst: {
          name: 'LST',
          endpoint: '/api/gee/lst-tiles',
          attribution: 'LST - Google Earth Engine'
        },
        pm25: {
          name: 'PM2.5',
          endpoint: '/api/gee/pm25-tiles',
          attribution: 'PM2.5 - Google Earth Engine'
        },
        ndwi: {
          name: 'NDWI',
          endpoint: '/api/gee/ndwi-tiles',
          attribution: 'NDWI - Google Earth Engine'
        }
      };
      
      const config = layerConfigs[layerKey];
      if (!config) return;
      
      try {
        // Por ahora, mostrar un placeholder
        // En producción, esto haría fetch al endpoint y agregaría el layer real
        logStatus(`Capa ${config.name} cargada (demo)`, 'info', 'ecoplan');
        
        // Placeholder: Agregar un layer de ejemplo
        // En producción reemplazarías esto con:
        // const response = await fetch(config.endpoint + '?bounds=...');
        // const tileUrl = await response.json();
        // const layer = L.tileLayer(tileUrl, { ...options });
        
      } catch (error) {
        console.error(`Error cargando capa ${layerKey}:`, error);
        logStatus(`Error cargando capa ${config.name}`, 'error', 'ecoplan');
      }
    }
    
    function removeGeeLayer(layerKey) {
      if (geeLayerObjects[layerKey]) {
        map.removeLayer(geeLayerObjects[layerKey]);
        geeLayerObjects[layerKey] = null;
      }
    }
    
    function updateGeeLayerOpacity(layerKey, opacity) {
      if (geeLayerObjects[layerKey] && geeLayerObjects[layerKey].setOpacity) {
        geeLayerObjects[layerKey].setOpacity(opacity);
      }
    }
    
    // Función auxiliar para hacer funciones globales accesibles desde onclick
    window.focusReportOnMap = focusReportOnMap;
    window.viewReportPhoto = viewReportPhoto;

    // ========== FUNCIONES PARA MAPA MODAL ==========
    
    function initializeModalMap() {
      if (modalMapInitialized || !document.getElementById('modalMap')) {
        return;
      }

      try {
        // Crear mapa centrado en Lima
        modalMap = L.map('modalMap', {
          center: [-12.046374, -77.042793], // Lima, Perú
          zoom: 13,
          zoomControl: true,
          scrollWheelZoom: true
        });

        // Agregar capa base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap',
          maxZoom: 19
        }).addTo(modalMap);

        // Cargar ubicación guardada o intentar geolocalización
        const savedLocation = loadLocationFromStorage();
        if (savedLocation) {
          modalMap.setView([savedLocation.lat, savedLocation.lon], 16);
          setModalLocationOnMap(savedLocation.lat, savedLocation.lon);
        } else {
          tryGeolocation();
        }

        // Evento de click en el mapa
        modalMap.on('click', function(e) {
          const lat = e.latlng.lat;
          const lon = e.latlng.lng;
          setModalLocationOnMap(lat, lon);
        });

        modalMapInitialized = true;
        
        // Mostrar instrucciones
        const instructions = document.getElementById('modalMapInstructions');
        if (instructions) {
          instructions.style.display = 'block';
          setTimeout(() => {
            instructions.style.display = 'none';
          }, 5000);
        }

        // Forzar resize del mapa después de un momento
        setTimeout(() => {
          if (modalMap) {
            modalMap.invalidateSize();
          }
        }, 300);

        console.log('✅ Mapa modal inicializado correctamente');
      } catch (error) {
        console.error('❌ Error al inicializar mapa modal:', error);
      }
    }

    function setModalLocationOnMap(lat, lon) {
      if (!modalMap) return;

      // Actualizar o crear marker
      if (modalMapMarker) {
        modalMapMarker.setLatLng([lat, lon]);
      } else {
        modalMapMarker = L.marker([lat, lon], {
          icon: L.divIcon({
            className: 'modal-location-marker',
            iconSize: [40, 40],
            iconAnchor: [20, 40]
          })
        }).addTo(modalMap);
      }

      // Actualizar inputs
      const latInput = document.getElementById('modalLatitude');
      const lonInput = document.getElementById('modalLongitude');
      if (latInput) latInput.value = lat.toFixed(6);
      if (lonInput) lonInput.value = lon.toFixed(6);

      // Guardar en localStorage
      saveLocationToStorage(lat, lon);

      // Actualizar estado
      modalSelectedLocation = { lat, lon };
      updateNavigationButtons();

      console.log(`📍 Ubicación seleccionada: ${lat.toFixed(6)}, ${lon.toFixed(6)}`);
    }

    function saveLocationToStorage(lat, lon) {
      try {
        const locationData = {
          lat: lat,
          lon: lon,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('gee-last-report-location', JSON.stringify(locationData));
        console.log('💾 Ubicación guardada en localStorage');
      } catch (error) {
        console.error('Error al guardar ubicación:', error);
      }
    }

    function loadLocationFromStorage() {
      try {
        const stored = localStorage.getItem('gee-last-report-location');
        if (stored) {
          const data = JSON.parse(stored);
          console.log('📂 Ubicación cargada desde localStorage');
          return { lat: data.lat, lon: data.lon };
        }
      } catch (error) {
        console.error('Error al cargar ubicación:', error);
      }
      return null;
    }

    function tryGeolocation() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            if (modalMap) {
              modalMap.setView([lat, lon], 16);
              setModalLocationOnMap(lat, lon);
              logStatus('📍 Ubicación detectada automáticamente', 'success', 'ecoplan');
            }
          },
          function(error) {
            console.log('No se pudo obtener ubicación automática:', error.message);
          },
          {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          }
        );
      }
    }

    function centerModalMapOnLima() {
      if (modalMap) {
        modalMap.setView([-12.046374, -77.042793], 13);
        logStatus('🎯 Mapa centrado en Lima', 'info', 'ecoplan');
      }
    }

    function useMyLocation() {
      if ('geolocation' in navigator) {
        logStatus('🔍 Obteniendo tu ubicación...', 'info', 'ecoplan');
        navigator.geolocation.getCurrentPosition(
          function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            if (modalMap) {
              modalMap.setView([lat, lon], 17);
              setModalLocationOnMap(lat, lon);
              logStatus('✅ Ubicación obtenida correctamente', 'success', 'ecoplan');
            }
          },
          function(error) {
            let message = 'No se pudo obtener tu ubicación';
            if (error.code === 1) {
              message = 'Permiso de ubicación denegado. Haz clic en el mapa manualmente.';
            } else if (error.code === 2) {
              message = 'Ubicación no disponible. Usa el mapa manualmente.';
            }
            logStatus(message, 'warning', 'ecoplan');
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      } else {
        logStatus('Tu navegador no soporta geolocalización', 'warning', 'ecoplan');
      }
    }

    // ========== FIN FUNCIONES MAPA MODAL ==========

    // ========== FIN FUNCIONES EXPLORAR ==========

    function renderCitizenReportsList(reports = []) {
      if (!citizenReportsList || !citizenReportsEmptyMessage) {
        return;
      }

      citizenReportsList.innerHTML = '';

      if (!Array.isArray(reports) || !reports.length) {
        citizenReportsEmptyMessage.hidden = false;
        return;
      }

      citizenReportsEmptyMessage.hidden = true;
      reports.slice(0, 8).forEach((report) => {
        citizenReportsList.appendChild(createCitizenReportListItem(report));
      });
    }

    function ensureCitizenReportsLoaded() {
      if (!citizenReportsLoaded && !citizenReportsLoading) {
        fetchCitizenReports({ announce: false });
      }
    }

    async function fetchCitizenReports({ announce = true } = {}) {
      if (citizenReportsLoading) {
        return;
      }
      citizenReportsLoading = true;
      if (announce) {
        logStatus('Cargando reportes ciudadanos...', 'info', 'ecoplan');
      }
      updateCitizenReportStatus('Cargando reportes ciudadanos…', 'info');

      try {
        const response = await fetch('/api/citizen-reports?limit=200', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }
        const data = await response.json();
        const reports = Array.isArray(data?.reports) ? data.reports : [];
        citizenReports = reports;
        citizenReportsLoaded = true;
        renderCitizenReportsList(reports);
        renderCitizenReportMarkers(reports);
        
        // Actualizar sistema Explorar
        exploreFilteredReports = [...reports];
        renderExploreIndicators();
        renderExploreReportsList();
        renderExploreMarkers();
        
        updateCitizenReportStatus('', 'idle');
        if (announce) {
          logStatus(`Reportes ciudadanos actualizados (${reports.length}).`, 'success', 'ecoplan');
        }
      } catch (error) {
        console.error('No se pudo cargar el listado de reportes ciudadanos:', error);
        updateCitizenReportStatus(`Error al cargar reportes: ${error.message}`, 'error');
        if (announce) {
          logStatus(`No se pudieron cargar los reportes ciudadanos: ${error.message}`, 'error', 'ecoplan');
        }
      } finally {
        citizenReportsLoading = false;
      }
    }

    async function submitCitizenReport(event) {
      event?.preventDefault();
      if (citizenReportSubmitting) {
        return;
      }
      if (!citizenReportForm) {
        return;
      }

      const formData = new FormData(citizenReportForm);
      const payload = {
        category: formData.get('category'),
        description: formData.get('description'),
        latitude: formData.get('latitude'),
        longitude: formData.get('longitude'),
        photoUrl: formData.get('photoUrl') || undefined,
        contactName: formData.get('contactName') || undefined,
        contactEmail: formData.get('contactEmail') || undefined
      };

      citizenReportSubmitting = true;
      if (citizenReportSubmitButton) citizenReportSubmitButton.disabled = true;
      updateCitizenReportStatus('Enviando reporte…', 'info');

      try {
        const response = await fetch('/api/citizen-reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.status === 400) {
          const data = await response.json();
          const message = Array.isArray(data?.errors) && data.errors.length
            ? data.errors.join(' ') : 'Datos inválidos.';
          updateCitizenReportStatus(message, 'error');
          return;
        }

        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }

        const data = await response.json();
        updateCitizenReportStatus('Reporte registrado. ¡Gracias por el aporte comunitario!', 'success');
        logStatus('Reporte ciudadano registrado correctamente.', 'success', 'ecoplan');
        citizenReportForm.reset();
        if (citizenReportLocationMarker) {
          citizenReportLocationMarker.remove();
          citizenReportLocationMarker = null;
        }
        setCitizenReportCaptureMode(false);
        setTimeout(() => updateCitizenReportStatus('', 'idle'), 4000);
        await fetchCitizenReports({ announce: false });
      } catch (error) {
        console.error('No se pudo registrar el reporte ciudadano:', error);
        updateCitizenReportStatus(`Error al registrar reporte: ${error.message}`, 'error');
        logStatus(`Error al registrar reporte ciudadano: ${error.message}`, 'error', 'ecoplan');
      } finally {
        citizenReportSubmitting = false;
        if (citizenReportSubmitButton) citizenReportSubmitButton.disabled = false;
      }
    }

    // ========== FUNCIONES PARA EL NUEVO MODAL MVP ==========
    
    function openNewReportModal() {
      if (!newReportModal) return;
      currentStep = 1;
      selectedCategory = null;
      modalSelectedLocation = { lat: null, lon: null };
      isSelectingLocationForModal = false;
      
      // Reset form
      if (newReportForm) newReportForm.reset();
      document.querySelectorAll('.category-card').forEach(card => card.classList.remove('selected'));
      if (locationPreview) locationPreview.style.display = 'none';
      
      // Reset inputs del mapa
      const latInput = document.getElementById('modalLatitude');
      const lonInput = document.getElementById('modalLongitude');
      if (latInput) latInput.value = '';
      if (lonInput) lonInput.value = '';
      
      // Limpiar marker del modal si existe
      if (modalMapMarker && modalMap) {
        modalMap.removeLayer(modalMapMarker);
        modalMapMarker = null;
      }
      
      // Mostrar el modal y el paso 1
      newReportModal.hidden = false;
      newReportModal.removeAttribute('aria-hidden');
      newReportModal.style.display = 'flex';
      document.body.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      
      showReportStep(1);
      updateNavigationButtons();
      
      // Inicializar el mapa modal cuando se muestra el modal
      // Se inicializa después para asegurarnos que el contenedor esté visible
      if (!modalMapInitialized) {
        setTimeout(() => {
          initializeModalMap();
        }, 100);
      } else if (modalMap) {
        // Si ya está inicializado, solo hacer resize por si acaso
        setTimeout(() => {
          modalMap.invalidateSize();
        }, 100);
      }
    }
    
    function closeNewReportModal() {
      if (!newReportModal) return;
      newReportModal.hidden = true;
      newReportModal.setAttribute('aria-hidden', 'true');
      newReportModal.style.display = 'none';
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      isSelectingLocationForModal = false;
      
      // Ocultar éxito si está visible
      if (reportSuccess) reportSuccess.style.display = 'none';
      document.querySelectorAll('.report-step').forEach(step => {
        step.classList.remove('hidden');
      });
    }
    
    function showReportStep(step) {
      currentStep = step;
      
      // Actualizar indicadores de pasos
      document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
        const stepNum = index + 1;
        indicator.classList.remove('active', 'completed');
        if (stepNum < currentStep) {
          indicator.classList.add('completed');
        } else if (stepNum === currentStep) {
          indicator.classList.add('active');
        }
      });
      
      // Mostrar/ocultar pasos
      document.querySelectorAll('.report-step').forEach(stepEl => {
        const stepNum = parseInt(stepEl.dataset.step);
        stepEl.classList.toggle('hidden', stepNum !== currentStep);
      });
      
      // Si estamos en el paso 2 (mapa), inicializar o hacer resize del mapa
      if (step === 2) {
        if (!modalMapInitialized) {
          setTimeout(() => {
            initializeModalMap();
          }, 100);
        } else if (modalMap) {
          setTimeout(() => {
            modalMap.invalidateSize();
            // Mostrar instrucciones brevemente
            const instructions = document.getElementById('modalMapInstructions');
            if (instructions) {
              instructions.style.display = 'block';
              setTimeout(() => {
                instructions.style.display = 'none';
              }, 3000);
            }
          }, 100);
        }
      }
      
      updateNavigationButtons();
    }
    
    function updateNavigationButtons() {
      if (!prevStepBtn || !nextStepBtn || !submitReportBtn) return;
      
      // Botón anterior
      prevStepBtn.style.display = currentStep > 1 ? 'block' : 'none';
      
      // Validar si se puede avanzar
      let canAdvance = false;
      if (currentStep === 1) {
        canAdvance = selectedCategory !== null;
      } else if (currentStep === 2) {
        canAdvance = modalSelectedLocation.lat !== null && modalSelectedLocation.lon !== null;
      } else if (currentStep === 3) {
        canAdvance = true; // El paso 3 es opcional
      }
      
      if (currentStep < 3) {
        nextStepBtn.style.display = 'block';
        nextStepBtn.disabled = !canAdvance;
        submitReportBtn.style.display = 'none';
      } else {
        nextStepBtn.style.display = 'none';
        submitReportBtn.style.display = 'block';
        submitReportBtn.disabled = !canAdvance;
      }
    }
    
    function selectCategory(category) {
      selectedCategory = category;
      document.querySelectorAll('.category-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.category === category);
      });
      updateNavigationButtons();
    }
    
    // ========== MAPA INTEGRADO EN MODAL ==========
    
    function initializeModalMap() {
      if (modalMap) return; // Ya inicializado
      
      const modalMapDiv = document.getElementById('modalMap');
      if (!modalMapDiv) return;
      
      // Crear mapa centrado en Lima
      modalMap = L.map('modalMap', {
        center: [-12.046373, -77.042754], // Lima, Perú
        zoom: 13,
        zoomControl: true,
        scrollWheelZoom: true
      });
      
      // Agregar capa base
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(modalMap);
      
      // Event listener para clicks en el mapa
      modalMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        setModalLocation(lat, lon);
        hideModalMapInstructions();
      });
      
      // Ajustar tamaño después de un momento
      setTimeout(() => {
        if (modalMap) modalMap.invalidateSize();
      }, 300);
      
      // Cargar última ubicación guardada
      loadSavedLocation();
    }
    
    function showModalMapInstructions() {
      const instructions = document.getElementById('modalMapInstructions');
      if (instructions) {
        instructions.style.display = 'block';
        setTimeout(() => {
          instructions.style.display = 'none';
        }, 3000);
      }
    }
    
    function hideModalMapInstructions() {
      const instructions = document.getElementById('modalMapInstructions');
      if (instructions) {
        instructions.style.display = 'none';
      }
    }
    
    function setModalLocation(lat, lon) {
      modalSelectedLocation = { lat, lon };
      
      // Actualizar inputs
      document.getElementById('modalLatitude').value = lat.toFixed(6);
      document.getElementById('modalLongitude').value = lon.toFixed(6);
      
      // Guardar en localStorage
      saveLocationToLocalStorage(lat, lon);
      
      // Actualizar marker en el mapa del modal
      if (modalMap) {
        if (!modalMapMarker) {
          modalMapMarker = L.marker([lat, lon], {
            icon: L.divIcon({
              className: 'custom-modal-marker',
              html: '<div style="background: #3b82f6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          }).addTo(modalMap);
          
          modalMapMarker.bindPopup('📍 Ubicación del reporte');
        } else {
          modalMapMarker.setLatLng([lat, lon]);
        }
        
        // Centrar mapa en la ubicación
        modalMap.setView([lat, lon], modalMap.getZoom());
      }
      
      // También actualizar marker en el mapa principal
      if (map) {
        if (!citizenReportLocationMarker) {
          citizenReportLocationMarker = L.circleMarker([lat, lon], {
            radius: 10,
            color: '#3b82f6',
            weight: 3,
            fillColor: '#3b82f6',
            fillOpacity: 0.5
          }).addTo(map);
        } else {
          citizenReportLocationMarker.setLatLng([lat, lon]);
        }
        map.setView([lat, lon], 15);
      }
      
      updateNavigationButtons();
      
      // Reabrir el modal
      if (isSelectingLocationForModal) {
        isSelectingLocationForModal = false;
        setTimeout(() => {
          openNewReportModal();
          showReportStep(2);
        }, 300);
      }
    }
    
    // ========== FUNCIONES DE LOCALSTORAGE Y GEOLOCALIZACION ==========
    
    function saveLocationToLocalStorage(lat, lon) {
      try {
        const data = {
          latitude: lat,
          longitude: lon,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem(LOCALSTORAGE_KEY_PREFIX + 'last_location', JSON.stringify(data));
      } catch (error) {
        console.warn('No se pudo guardar la ubicación en localStorage:', error);
      }
    }
    
    function loadSavedLocation() {
      try {
        const saved = localStorage.getItem(LOCALSTORAGE_KEY_PREFIX + 'last_location');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.latitude && data.longitude) {
            // Silenciosamente cargar pero no aplicar
            console.log('Ubicación anterior disponible:', data);
          }
        }
      } catch (error) {
        console.warn('No se pudo cargar la ubicación guardada:', error);
      }
    }
    
    function useMyLocation() {
      if (!navigator.geolocation) {
        logStatus('Tu navegador no soporta geolocalización', 'warning', 'ecoplan');
        return;
      }
      
      const btn = document.getElementById('useMyLocationBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = '⏳ Obteniendo...';
      }
      
      logStatus('Obteniendo tu ubicación...', 'info', 'ecoplan');
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          setModalLocation(lat, lon);
          
          if (modalMap) {
            modalMap.setView([lat, lon], 16); // Zoom más cercano
          }
          
          logStatus('✓ Ubicación obtenida', 'success', 'ecoplan');
          if (btn) {
            btn.disabled = false;
            btn.textContent = '📍 Mi ubicación';
          }
        },
        (error) => {
          let message = 'No se pudo obtener tu ubicación';
          if (error.code === 1) {
            message = 'Permiso de ubicación denegado';
          } else if (error.code === 2) {
            message = 'Ubicación no disponible';
          } else if (error.code === 3) {
            message = 'Tiempo de espera agotado';
          }
          logStatus(message, 'warning', 'ecoplan');
          if (btn) {
            btn.disabled = false;
            btn.textContent = '📍 Mi ubicación';
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }
    
    function centerMapOnLima() {
      if (modalMap) {
        modalMap.setView([-12.046373, -77.042754], 13);
        showModalMapInstructions();
        logStatus('Mapa centrado en Lima', 'info', 'ecoplan');
      }
    }
    
    async function submitNewReport(event) {
      event.preventDefault();
      
      if (!selectedCategory || !modalSelectedLocation.lat || !modalSelectedLocation.lon) {
        alert('Por favor completa todos los pasos requeridos.');
        return;
      }
      
      const formData = new FormData(newReportForm);
      const payload = {
        category: selectedCategory,
        latitude: modalSelectedLocation.lat,
        longitude: modalSelectedLocation.lon,
        description: formData.get('description') || '',
        photoUrl: formData.get('photoUrl') || undefined,
        severity: formData.get('severity') || 'medium'
      };
      
      submitReportBtn.disabled = true;
      submitReportBtn.textContent = '⏳ Enviando...';
      
      try {
        const response = await fetch('/api/citizen-reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error al enviar el reporte');
        }
        
        const data = await response.json();
        
        // Mostrar éxito
        document.querySelectorAll('.report-step').forEach(step => step.classList.add('hidden'));
        document.querySelector('.modal-header').style.display = 'none';
        document.querySelector('.modal-footer').style.display = 'none';
        reportSuccess.style.display = 'block';
        document.getElementById('reportCode').textContent = data.report?.id || 'N/A';
        
        // Actualizar lista de reportes
        await fetchCitizenReports({ announce: false });
        
        logStatus('Reporte enviado correctamente.', 'success', 'ecoplan');
      } catch (error) {
        console.error('Error al enviar reporte:', error);
        alert('Error al enviar el reporte: ' + error.message);
        submitReportBtn.disabled = false;
        submitReportBtn.textContent = '📤 Enviar Reporte';
      }
    }

    function parseAutoRefreshInterval(value) {
      const parsed = Number(value);
      if (!Number.isFinite(parsed)) {
        return DEFAULT_AUTO_REFRESH_INTERVAL_MS;
      }
      return Math.min(Math.max(parsed, 60000), 3600000);
    }

    function loadModePreference() {
      if (typeof window === 'undefined' || !window.localStorage) {
        return null;
      }
      try {
        const stored = window.localStorage.getItem(MODE_STORAGE_KEY);
        if (stored === 'bloom' || stored === 'ecoplan') {
          return stored;
        }
      } catch (error) {
        console.warn('No se pudo cargar el modo preferido:', error);
      }
      return null;
    }

    function persistModePreference(mode) {
      if (typeof window === 'undefined' || !window.localStorage) {
        return;
      }
      try {
        window.localStorage.setItem(MODE_STORAGE_KEY, mode);
      } catch (error) {
        console.warn('No se pudo guardar el modo preferido:', error);
      }
    }

    function loadReportRunsAutoRefreshSettings() {
      if (typeof window === 'undefined' || !window.localStorage) {
        return;
      }
      try {
        const raw = window.localStorage.getItem(REPORT_RUNS_AUTO_REFRESH_STORAGE_KEY);
        if (!raw) {
          return;
        }
        const parsed = JSON.parse(raw);
        if (typeof parsed === 'object' && parsed) {
          if (typeof parsed.enabled === 'boolean') {
            reportRunsAutoRefreshEnabled = parsed.enabled;
          }
          if (parsed.interval !== undefined) {
            reportRunsAutoRefreshIntervalMs = parseAutoRefreshInterval(parsed.interval);
          }
        }
      } catch (error) {
        console.warn('No se pudo cargar la configuración de auto-actualización:', error);
      }
    }

    function persistReportRunsAutoRefreshSettings() {
      if (typeof window === 'undefined' || !window.localStorage) {
        return;
      }
      try {
        window.localStorage.setItem(REPORT_RUNS_AUTO_REFRESH_STORAGE_KEY, JSON.stringify({
          enabled: reportRunsAutoRefreshEnabled,
          interval: reportRunsAutoRefreshIntervalMs
        }));
      } catch (error) {
        console.warn('No se pudo guardar la configuración de auto-actualización:', error);
      }
    }

    function applyReportRunsAutoRefreshDomState() {
      if (reportRunsAutoRefreshToggle) {
        reportRunsAutoRefreshToggle.checked = reportRunsAutoRefreshEnabled;
      }
      if (reportRunsAutoRefreshIntervalSelect) {
        reportRunsAutoRefreshIntervalSelect.value = reportRunsAutoRefreshIntervalMs.toString();
      }
      updateReportRunsAutoRefreshStatusLabel();
    }

    function updateReportRunsAutoRefreshStatusLabel() {
      if (!reportRunsAutoRefreshStatusEl) {
        return;
      }
      const documentHidden = typeof document !== 'undefined' && document.hidden;
      const activeNow = reportRunsAutoRefreshEnabled && currentMode === 'ecoplan' && !documentHidden;
      let modeLabel = 'Actualización manual';
      if (reportRunsAutoRefreshEnabled) {
        modeLabel = activeNow ? 'Auto-actualización activa' : 'Auto-actualización pausada';
        if (!activeNow && currentMode !== 'ecoplan') {
          modeLabel = 'Auto-actualización en espera (modo Bloom)';
        } else if (!activeNow && documentHidden) {
          modeLabel = 'Auto-actualización pausada (pestaña inactiva)';
        }
      }

      if (!reportRunsLastUpdatedAt) {
        reportRunsAutoRefreshStatusEl.textContent = `${modeLabel}.`;
        return;
      }

      reportRunsAutoRefreshStatusEl.textContent = `${modeLabel}. Última actualización: ${formatDateTimeLabel(reportRunsLastUpdatedAt)}`;
    }

    function clearReportRunsAutoRefreshTimer() {
      if (reportRunsAutoRefreshTimer) {
        clearInterval(reportRunsAutoRefreshTimer);
        reportRunsAutoRefreshTimer = null;
      }
      updateReportRunsAutoRefreshStatusLabel();
    }

    function scheduleReportRunsAutoRefresh({ fetchImmediately = false } = {}) {
      clearReportRunsAutoRefreshTimer();

      if (!reportRunsAutoRefreshEnabled || currentMode !== 'ecoplan') {
        return;
      }

      if (typeof document !== 'undefined' && document.hidden) {
        return;
      }

      reportRunsAutoRefreshTimer = setInterval(() => {
        fetchReportRuns({ announce: false });
      }, reportRunsAutoRefreshIntervalMs);

      if (fetchImmediately) {
        fetchReportRuns({ announce: false });
      }

      updateReportRunsAutoRefreshStatusLabel();
    }

    function handleVisibilityChange() {
      if (!reportRunsAutoRefreshEnabled) {
        return;
      }
      if (document.hidden) {
        clearReportRunsAutoRefreshTimer();
      } else {
        scheduleReportRunsAutoRefresh();
      }
      updateReportRunsAutoRefreshStatusLabel();
    }

  function updateReportRunsSummary(runs = []) {
      if (!reportRunsSummary) {
        return;
      }

      if (!Array.isArray(runs) || !runs.length) {
        reportRunsSummary.hidden = true;
        if (reportRunsTotalEl) reportRunsTotalEl.textContent = '0';
        if (reportRunsRangeEl) reportRunsRangeEl.textContent = '–';
        if (reportRunsSuccessEl) reportRunsSuccessEl.textContent = '0';
        if (reportRunsSuccessPctEl) reportRunsSuccessPctEl.textContent = '0%';
        if (reportRunsErrorsEl) reportRunsErrorsEl.textContent = '0';
        if (reportRunsErrorsPctEl) reportRunsErrorsPctEl.textContent = '0%';
        if (reportRunsLastStatusEl) reportRunsLastStatusEl.textContent = '–';
        if (reportRunsLastWhenEl) reportRunsLastWhenEl.textContent = '–';
        return;
      }

      const total = runs.length;
      const successCount = runs.filter((run) => run?.status === 'success').length;
      const errorCount = runs.filter((run) => run?.status === 'error').length;

      if (reportRunsTotalEl) {
        reportRunsTotalEl.textContent = String(total);
      }

      if (reportRunsSuccessEl) {
        reportRunsSuccessEl.textContent = String(successCount);
      }
      if (reportRunsSuccessPctEl) {
        reportRunsSuccessPctEl.textContent = formatPercentage(successCount, total);
      }

      if (reportRunsErrorsEl) {
        reportRunsErrorsEl.textContent = String(errorCount);
      }
      if (reportRunsErrorsPctEl) {
        reportRunsErrorsPctEl.textContent = formatPercentage(errorCount, total);
      }

      const latest = runs[0];
      const earliest = runs[runs.length - 1];

      if (reportRunsRangeEl) {
        const startLabel = earliest ? formatDateTimeLabel(earliest.generatedAt || earliest.completedAt || earliest.startedAt) : null;
        const endLabel = latest ? formatDateTimeLabel(latest.generatedAt || latest.completedAt || latest.startedAt) : null;
        if (startLabel && endLabel && startLabel !== endLabel) {
          reportRunsRangeEl.textContent = `${startLabel} → ${endLabel}`;
        } else {
          reportRunsRangeEl.textContent = endLabel || startLabel || '–';
        }
      }

      if (reportRunsLastStatusEl || reportRunsLastWhenEl) {
        const descriptor = getStatusDescriptor(latest?.status);
        if (reportRunsLastStatusEl) {
          reportRunsLastStatusEl.textContent = descriptor.label;
        }
        if (reportRunsLastWhenEl) {
          const lastInstant = latest?.generatedAt || latest?.completedAt || latest?.startedAt;
          reportRunsLastWhenEl.textContent = lastInstant ? formatDateTimeLabel(lastInstant) : '–';
        }
      }

      reportRunsSummary.hidden = false;
    }

    function createMetricsSection(metrics) {
      if (!metrics || typeof metrics !== 'object') {
        return null;
      }
      const entries = Object.entries(metrics).filter(([, value]) => value !== null && value !== undefined);
      if (!entries.length) {
        return null;
      }

      const section = document.createElement('div');
      section.className = 'modal-section';
      const heading = document.createElement('h4');
      heading.textContent = 'Indicadores clave';
      section.appendChild(heading);

      const grid = document.createElement('div');
      grid.className = 'metrics-grid';

      entries.forEach(([key, value]) => {
        const card = document.createElement('div');
        card.className = 'metrics-card';
        const title = document.createElement('h5');
        title.textContent = humanizeKey(key);
        const metricValue = document.createElement('div');
        metricValue.className = 'metric-value';
        if (typeof value === 'number' && Number.isFinite(value)) {
          const decimals = Math.abs(value) >= 100 ? 0 : 2;
          metricValue.textContent = formatNumber(value, decimals);
        } else {
          metricValue.textContent = String(value);
        }
        card.append(title, metricValue);
        grid.appendChild(card);
      });

      section.appendChild(grid);
      return section;
    }

    function createJsonBlock(data) {
      const pre = document.createElement('pre');
      pre.className = 'json-block';
      try {
        if (typeof data === 'string') {
          pre.textContent = data;
        } else {
          pre.textContent = JSON.stringify(data, null, 2);
        }
      } catch (error) {
        pre.textContent = String(data);
      }
      return pre;
    }

    function closeReportRunDetails({ silent = false } = {}) {
      if (!reportRunDetailsOverlay) {
        return;
      }
      
      try {
        reportRunDetailsActiveId = null;
        reportRunDetailsOverlay.hidden = true;
        reportRunDetailsOverlay.setAttribute('aria-hidden', 'true');
        reportRunDetailsOverlay.style.display = 'none';
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        
        // Remover foco del modal
        if (document.activeElement && reportRunDetailsOverlay.contains(document.activeElement)) {
          document.activeElement.blur();
        }
        
        if (reportRunDetailsBody) {
          reportRunDetailsBody.innerHTML = '';
        }
        
        if (!silent) {
          logStatus('Detalle cerrado.', 'info', 'ecoplan');
        }
      } catch (error) {
        console.error('Error al cerrar modal:', error);
        // Forzar cierre
        if (reportRunDetailsOverlay) {
          reportRunDetailsOverlay.style.display = 'none';
        }
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
      }
    }

    if (closeReportRunDetailsButton) {
      closeReportRunDetailsButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        closeReportRunDetails();
      });
    }

    if (reportRunDetailsOverlay) {
      reportRunDetailsOverlay.addEventListener('click', (event) => {
        if (event.target === reportRunDetailsOverlay) {
          event.preventDefault();
          event.stopPropagation();
          closeReportRunDetails({ silent: true });
        }
      });
      
      // Agregar doble-click en cualquier parte del overlay para cerrar
      reportRunDetailsOverlay.addEventListener('dblclick', (event) => {
        event.preventDefault();
        event.stopPropagation();
        closeReportRunDetails({ silent: true });
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && reportRunDetailsOverlay && !reportRunDetailsOverlay.hidden) {
        closeReportRunDetails({ silent: true });
      }
    });

    document.addEventListener('click', (event) => {
      const closeTrigger = event.target.closest('[data-action="close-report-run-details"]');
      if (closeTrigger) {
        event.preventDefault();
        event.stopImmediatePropagation();
        closeReportRunDetails();
      }
    }, true);

    function openReportRunDetails(run) {
      if (!run || !reportRunDetailsOverlay || !reportRunDetailsBody) {
        logStatus('No hay detalles disponibles para esta ejecución.', 'warning', 'ecoplan');
        return;
      }

      reportRunDetailsActiveId = run.id || null;

      const jobParts = [];
      if (run.jobId) {
        jobParts.push(run.jobId);
      }
      if (run.presetName) {
        jobParts.push(run.presetName);
      } else if (run.presetId) {
        jobParts.push(run.presetId);
      }
      if (reportRunDetailsJob) {
        reportRunDetailsJob.textContent = jobParts.length ? jobParts.join(' · ') : 'Ejecución EcoPlan';
      }

      if (reportRunDetailsTitle) {
        const presetLabel = run.presetName || run.presetId || 'Detalle de ejecución';
        reportRunDetailsTitle.textContent = `EcoPlan · ${presetLabel}`;
      }

      if (reportRunDetailsStatus) {
        const descriptor = getStatusDescriptor(run.status);
        reportRunDetailsStatus.textContent = descriptor.label;
        reportRunDetailsStatus.className = `status-pill ${descriptor.variant}`;
      }

      const sections = [];
      const timelineItems = [];
      if (run.startedAt) {
        timelineItems.push({ label: 'Inicio', value: formatDateTimeLabel(run.startedAt) });
      }
      if (run.completedAt) {
        timelineItems.push({ label: 'Fin', value: formatDateTimeLabel(run.completedAt) });
      }
      if (run.generatedAt) {
        timelineItems.push({ label: 'Generado', value: formatDateTimeLabel(run.generatedAt) });
      }
      const durationLabel = formatDurationLabel(run.durationMs);
      if (durationLabel) {
        timelineItems.push({ label: 'Duración', value: durationLabel });
      }
      if (run.trigger) {
        timelineItems.push({ label: 'Disparador', value: humanizeKey(run.trigger) });
      }
      if (run.hash) {
        timelineItems.push({ label: 'Hash', value: run.hash });
      }
      if (run.id) {
        timelineItems.push({ label: 'ID interno', value: run.id });
      }

      if (timelineItems.length) {
        const timelineSection = document.createElement('div');
        timelineSection.className = 'modal-section';
        const timelineHeading = document.createElement('h4');
        timelineHeading.textContent = 'Cronología';
        timelineSection.appendChild(timelineHeading);
        timelineSection.appendChild(buildKeyValueGrid(timelineItems));
        sections.push(timelineSection);
      }

      const resultsSection = document.createElement('div');
      resultsSection.className = 'modal-section';
      const resultsHeading = document.createElement('h4');
      resultsHeading.textContent = 'Archivos generados';
      resultsSection.appendChild(resultsHeading);
      const resultsList = createResultsList(run.results);
      if (resultsList) {
        resultsSection.appendChild(resultsList);
      } else {
        const message = run.status === 'running'
          ? 'Los formatos aún se están generando.'
          : 'No se registraron formatos para esta ejecución.';
        resultsSection.appendChild(createEmptyMessage(message));
      }
      sections.push(resultsSection);

      const notificationsSection = document.createElement('div');
      notificationsSection.className = 'modal-section';
      const notificationsHeading = document.createElement('h4');
      notificationsHeading.textContent = 'Notificaciones';
      notificationsSection.appendChild(notificationsHeading);
      const notificationsList = createNotificationsList(run.notifications);
      if (notificationsList) {
        notificationsSection.appendChild(notificationsList);
      } else {
        notificationsSection.appendChild(createEmptyMessage('No se registraron notificaciones para esta ejecución.'));
      }
      sections.push(notificationsSection);

      const metricsSection = createMetricsSection(run.metrics);
      if (metricsSection) {
        sections.push(metricsSection);
      }

      if (run.delivery && Object.keys(run.delivery).length) {
        const deliverySection = document.createElement('div');
        deliverySection.className = 'modal-section';
        const heading = document.createElement('h4');
        heading.textContent = 'Entrega';
        deliverySection.appendChild(heading);
        deliverySection.appendChild(createJsonBlock(run.delivery));
        sections.push(deliverySection);
      }

      if (run.request && Object.keys(run.request).length) {
        const requestSection = document.createElement('div');
        requestSection.className = 'modal-section';
        const heading = document.createElement('h4');
        heading.textContent = 'Payload efectivo';
        requestSection.appendChild(heading);
        requestSection.appendChild(createJsonBlock(run.request));
        sections.push(requestSection);
      }

      if (run.error && (run.error.message || run.error.stack)) {
        const errorSection = document.createElement('div');
        errorSection.className = 'modal-section';
        const heading = document.createElement('h4');
        heading.textContent = 'Errores reportados';
        errorSection.appendChild(heading);
        const errorText = [];
        if (run.error.message) {
          errorText.push(`Mensaje: ${run.error.message}`);
        }
        if (run.error.stack) {
          errorText.push(run.error.stack);
        }
        errorSection.appendChild(createJsonBlock(errorText.join('\n')));
        sections.push(errorSection);
      }

      reportRunDetailsBody.replaceChildren(...sections);

      reportRunDetailsOverlay.hidden = false;
      reportRunDetailsOverlay.removeAttribute('aria-hidden');
      reportRunDetailsOverlay.style.display = 'flex';
      document.body.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      
      // Usar setTimeout para asegurar que el DOM se actualice antes de enfocar
      setTimeout(() => {
        if (closeReportRunDetailsButton) {
          closeReportRunDetailsButton.focus();
        }
      }, 100);

      const descriptor = getStatusDescriptor(run.status);
      logStatus(`Detalles listos · ${run.jobId || 'job'} (${descriptor.label})`, 'info', 'ecoplan');
    }

    function translateNotificationStatus(status) {
      const normalized = typeof status === 'string' ? status.toLowerCase() : '';
      switch (normalized) {
        case 'sent':
          return 'OK';
        case 'skipped':
          return 'Omitido';
        case 'error':
          return 'Error';
        case 'pending':
          return 'Pendiente';
        case 'queued':
          return 'En cola';
        default:
          return status ? status.toString() : '—';
      }
    }

    function createTagElement(label, variant = 'neutral', href = null, tooltip = '') {
      const element = href ? document.createElement('a') : document.createElement('span');
      element.className = `tag ${variant}`;
      element.textContent = label;
      if (href) {
        element.href = href;
        element.target = '_blank';
        element.rel = 'noopener noreferrer';
      }
      if (tooltip) {
        element.title = tooltip;
      }
      return element;
    }

    function renderFormatsCell(cell, run) {
      cell.textContent = '';
      const results = Array.isArray(run?.results) ? run.results : [];
      if (!results.length) {
        cell.textContent = run?.status === 'running' ? 'Procesando…' : '—';
        return;
      }

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '6px';

      results.forEach((result) => {
        const formatLabel = (result?.format || '').toString().toUpperCase() || 'FORMATO';
        const href = result?.gcs?.publicUrl || null;
        const variant = mapTagVariant(result?.status);
        const tooltipParts = [];
        if (href) {
          tooltipParts.push('Abrir en pestaña nueva');
        } else if (result?.status === 'success') {
          tooltipParts.push('Generado localmente');
        }
        if (result?.error) {
          tooltipParts.push(`Error: ${result.error}`);
        }
        const tooltip = tooltipParts.join(' · ');
        const tag = createTagElement(formatLabel, variant, href, tooltip);
        container.appendChild(tag);
      });

      cell.appendChild(container);
    }

    function renderNotificationsCell(cell, run) {
      cell.textContent = '';
      const notifications = run?.notifications;
      if (!notifications || typeof notifications !== 'object' || !Object.keys(notifications).length) {
        cell.textContent = run?.status === 'running' ? 'Pendiente' : '—';
        return;
      }

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '6px';

      Object.entries(notifications).forEach(([channel, info]) => {
        const baseLabel = channel === 'email' ? 'Email' : channel === 'slack' ? 'Slack' : channel;
        const statusLabel = translateNotificationStatus(info?.status);
        const text = `${baseLabel}${statusLabel ? ` · ${statusLabel}` : ''}`;
        const tooltipParts = [];
        if (Array.isArray(info?.recipients) && info.recipients.length) {
          tooltipParts.push(`Destinatarios: ${info.recipients.join(', ')}`);
        }
        if (info?.reason) {
          tooltipParts.push(`Motivo: ${info.reason}`);
        }
        if (info?.error) {
          tooltipParts.push(`Error: ${info.error}`);
        }
        const tooltip = tooltipParts.join(' | ');
        const variant = mapTagVariant(info?.status);
        const tag = createTagElement(text, variant, null, tooltip);
        container.appendChild(tag);
      });

      cell.appendChild(container);
    }

    function renderReportRunsTable(runs = []) {
      if (!reportRunsTableBody) {
        return;
      }

      reportRunsTableBody.innerHTML = '';

      if (!Array.isArray(runs) || !runs.length) {
        if (reportRunsEmptyMessage) {
          const filtersApplied = Boolean(reportRunsFilterState.jobId || reportRunsFilterState.status);
          reportRunsEmptyMessage.hidden = false;
          reportRunsEmptyMessage.textContent = filtersApplied
            ? 'No hay ejecuciones que coincidan con los filtros seleccionados.'
            : (defaultReportRunsEmptyText || 'Sin ejecuciones registradas.');
        }
        updateReportRunsSummary([]);
        return;
      }

      if (reportRunsEmptyMessage) {
        reportRunsEmptyMessage.hidden = true;
        reportRunsEmptyMessage.textContent = defaultReportRunsEmptyText;
      }

      runs.forEach((run) => {
        const row = document.createElement('tr');
        row.classList.add('clickable-row');
        row.tabIndex = 0;
        row.setAttribute('role', 'button');
        row.setAttribute('aria-label', `Ver detalles de ${run?.jobId || run?.presetName || 'la ejecución'}`);
        row.addEventListener('click', () => {
          openReportRunDetails(run);
        });
        row.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openReportRunDetails(run);
          }
        });

        const dateCell = document.createElement('td');
        const datePrimary = document.createElement('div');
        datePrimary.textContent = formatDateTimeLabel(run?.generatedAt || run?.completedAt || run?.startedAt);
        dateCell.appendChild(datePrimary);
        const metaParts = [];
        if (run?.trigger) {
          metaParts.push(`Trigger: ${run.trigger}`);
        }
        const durationLabel = formatDurationLabel(run?.durationMs);
        if (durationLabel) {
          metaParts.push(`Duración: ${durationLabel}`);
        }
        if (metaParts.length) {
          const metaSpan = document.createElement('span');
          metaSpan.className = 'row-subtext';
          metaSpan.textContent = metaParts.join(' · ');
          dateCell.appendChild(metaSpan);
        }
        row.appendChild(dateCell);

        const jobCell = document.createElement('td');
        const jobTitle = document.createElement('div');
        jobTitle.textContent = run?.jobId || '—';
        jobTitle.style.fontWeight = '600';
        jobCell.appendChild(jobTitle);
        const presetLabel = run?.presetName || run?.presetId;
        if (presetLabel) {
          const presetSpan = document.createElement('span');
          presetSpan.className = 'row-subtext';
          presetSpan.textContent = presetLabel;
          jobCell.appendChild(presetSpan);
        }
        const periodStart = run?.request?.start;
        const periodEnd = run?.request?.end;
        if (periodStart || periodEnd) {
          const periodSpan = document.createElement('span');
          periodSpan.className = 'row-subtext';
          if (periodStart && periodEnd) {
            periodSpan.textContent = `${periodStart} → ${periodEnd}`;
          } else if (periodStart) {
            periodSpan.textContent = `Desde ${periodStart}`;
          } else {
            periodSpan.textContent = `Hasta ${periodEnd}`;
          }
          jobCell.appendChild(periodSpan);
        }
        row.appendChild(jobCell);

        const statusCell = document.createElement('td');
        const descriptor = getStatusDescriptor(run?.status);
        const statusPill = document.createElement('span');
        statusPill.className = `status-pill ${descriptor.variant}`;
        statusPill.textContent = descriptor.label;
        statusCell.appendChild(statusPill);
        if (run?.error?.message) {
          const errorSpan = document.createElement('span');
          errorSpan.className = 'row-subtext';
          errorSpan.textContent = run.error.message;
          statusCell.appendChild(errorSpan);
        }
        row.appendChild(statusCell);

        const formatsCell = document.createElement('td');
        renderFormatsCell(formatsCell, run);
        row.appendChild(formatsCell);

        const notificationsCell = document.createElement('td');
        renderNotificationsCell(notificationsCell, run);
        row.appendChild(notificationsCell);

        reportRunsTableBody.appendChild(row);
      });

      updateReportRunsSummary(runs);
    }

    function setReportRunsLoadingState(isLoading) {
      reportRunsLoading = isLoading;
      if (!refreshReportRunsButton) {
        return;
      }
      refreshReportRunsButton.disabled = isLoading;
      refreshReportRunsButton.textContent = isLoading
        ? 'Actualizando…'
        : (refreshReportRunsDefaultText || 'Actualizar');
    }

    async function fetchReportRuns({ announce = true, limit = REPORT_RUNS_LIMIT } = {}) {
      if (!reportRunsTableBody) {
        return;
      }

      const safeLimit = Math.max(1, Math.min(200, Number(limit) || REPORT_RUNS_LIMIT));
      reportRunsCurrentLimit = safeLimit;

      if (reportRunsLoading) {
        reportRunsFetchQueued = true;
        return;
      }

      setReportRunsLoadingState(true);

      if (announce) {
        logStatus('Consultando historial de reportes...', 'info', 'ecoplan');
      }

      try {
        const params = new URLSearchParams();
        params.set('limit', safeLimit.toString());
        if (reportRunsFilterState.jobId) {
          params.set('jobId', reportRunsFilterState.jobId);
        }
        if (reportRunsFilterState.status) {
          params.set('status', reportRunsFilterState.status);
        }

        const response = await fetch(`/api/reports/history?${params.toString()}`, { cache: 'no-store' });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || response.statusText || 'Error desconocido');
        }
        const data = await response.json();
        const runs = Array.isArray(data?.runs) ? data.runs : [];
        reportRunsLastResponse = runs;
        if (runs.length) {
          updateReportRunsFilterOptions(runs);
        } else {
          renderReportRunsFilters();
        }
        renderReportRunsTable(runs);
        reportRunsLastUpdatedAt = new Date().toISOString();
        updateReportRunsAutoRefreshStatusLabel();
        reportRunsLoaded = true;
        if (announce) {
          const appliedFilters = [];
          if (reportRunsFilterState.jobId) {
            appliedFilters.push(`job ${reportRunsFilterState.jobId}`);
          }
          if (reportRunsFilterState.status) {
            const statusDescriptor = getStatusDescriptor(reportRunsFilterState.status);
            appliedFilters.push(`estado ${statusDescriptor.label}`);
          }
          const filtersText = appliedFilters.length ? ` (${appliedFilters.join(', ')})` : '';
          logStatus(`Historial actualizado (${runs.length})${filtersText}.`, 'success', 'ecoplan');
        }
      } catch (error) {
        console.error('No se pudo cargar el historial de reportes:', error);
        reportRunsLoaded = false;
        if (reportRunsEmptyMessage) {
          reportRunsEmptyMessage.hidden = false;
          reportRunsEmptyMessage.textContent = `Error al cargar historial: ${error.message}`;
        }
        if (announce) {
          logStatus(`No se pudo cargar el historial: ${error.message}`, 'error', 'ecoplan');
        }
      } finally {
        setReportRunsLoadingState(false);
        if (reportRunsFetchQueued) {
          reportRunsFetchQueued = false;
          fetchReportRuns({ announce: false, limit: reportRunsCurrentLimit });
        }
        updateReportRunsAutoRefreshStatusLabel();
      }
    }

    function ensureReportRunsLoaded() {
      if (!reportRunsLoaded && !reportRunsLoading) {
        fetchReportRuns({ announce: false });
      }
    }

    function formatNumber(value, decimals = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) return '–';
      return Number(value).toLocaleString('es-PE', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    function buildRangeText(min, max, decimals = 2) {
      const minText = formatNumber(min, decimals);
      const maxText = formatNumber(max, decimals);
      if (minText === '–' || maxText === '–') {
        return '–';
      }
      return `${minText} – ${maxText}`;
    }

    function setDefaultDates(startId = 'startDate', endId = 'endDate') {
      const startInput = document.getElementById(startId);
      const endInput = document.getElementById(endId);
      if (!startInput || !endInput) return;

      const today = new Date();
      const endValue = today.toISOString().split('T')[0];
      const start = new Date(today);
      start.setDate(start.getDate() - 30);
      const startValue = start.toISOString().split('T')[0];

      if (!startInput.value) {
        startInput.value = startValue;
      }
      if (!endInput.value) {
        endInput.value = endValue;
      }
    }

    async function applyBloomPresetList(presets, {
      preserveSelection = true,
      triggerRun = true
    } = {}) {
      const select = document.getElementById('presetSelect');
      if (!select || !Array.isArray(presets) || !presets.length) {
        return false;
      }

      const previousValue = preserveSelection ? select.value : null;
      const shouldKeepPrevious = previousValue && presets.some((preset) => preset.id === previousValue);

      select.innerHTML = '';
      presets.forEach((preset) => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = `${preset.label} (${preset.type})`;
        option.dataset.defaultBuffer = preset.defaultBuffer ?? 0;
        select.appendChild(option);
      });

      if (shouldKeepPrevious) {
        select.value = previousValue;
      } else if (presets[0]) {
        select.value = presets[0].id;
      }

      if (bloomRunButton) bloomRunButton.disabled = false;
      updateBufferPlaceholder();
      setDefaultDates();

      if (!bloomInitialized && triggerRun) {
        bloomInitialized = true;
        try {
          await runBloomAnalysis();
        } catch (error) {
          console.error('Error al ejecutar el análisis automático:', error);
        }
      }

      return true;
    }

    async function fetchBloomPresets() {
      const select = document.getElementById('presetSelect');
      if (!select) {
        logStatus('No se encontró el selector de presets en el DOM.', 'error', 'bloom');
        return;
      }

      const hasLocalPresets = Array.isArray(BLOOM_PRESETS_LOCAL) && BLOOM_PRESETS_LOCAL.length > 0;

      if (hasLocalPresets) {
        logStatus('Presets locales disponibles inmediatamente.', 'info', 'bloom');
        await applyBloomPresetList(BLOOM_PRESETS_LOCAL, { triggerRun: false });
      }

      logStatus('Solicitando presets de ROI a la API...', 'info', 'bloom');

      try {
        const response = await fetch('/api/bloom/presets', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }
        const data = await response.json();
        const presets = Array.isArray(data?.presets) ? data.presets : [];
        if (!presets.length) {
          throw new Error('Respuesta sin presets');
        }

        await applyBloomPresetList(presets, { preserveSelection: true, triggerRun: true });
        logStatus(`Presets de ROI cargados desde la API (${presets.length}).`, 'success', 'bloom');
      } catch (error) {
        const message = error?.message || 'Error desconocido';
        if (hasLocalPresets) {
          logStatus(`No se pudo cargar presets desde la API (${message}). Se mantiene la lista local.`, 'warning', 'bloom');
          await applyBloomPresetList(BLOOM_PRESETS_LOCAL, { preserveSelection: true, triggerRun: !bloomInitialized });
        } else {
          select.innerHTML = '';
          const option = document.createElement('option');
          option.value = '';
          option.disabled = true;
          option.selected = true;
          option.textContent = 'No se pudieron cargar los presets';
          select.appendChild(option);
          if (bloomRunButton) bloomRunButton.disabled = true;
          logStatus(`Error al cargar presets: ${message}`, 'error', 'bloom');
        }
      }
    }

    async function applyEcoPresetList(presets, {
      preserveSelection = true,
      triggerRun = false
    } = {}) {
      const select = document.getElementById('ecoPresetSelect');
      if (!select || !Array.isArray(presets) || !presets.length) {
        return false;
      }

      const previousValue = preserveSelection ? select.value : null;
      const keepPrevious = previousValue && presets.some((preset) => preset.id === previousValue);

      select.innerHTML = '';
      presets.forEach((preset) => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = `${preset.label} (${preset.type})`;
        option.dataset.defaultBuffer = preset.defaultBuffer ?? 0;
        select.appendChild(option);
      });

      if (keepPrevious) {
        select.value = previousValue;
      } else if (presets[0]) {
        select.value = presets[0].id;
      }

      if (ecoRunButton) ecoRunButton.disabled = false;
      setDefaultDates('ecoStartDate', 'ecoEndDate');
      updateEcoBufferPlaceholder();

      if (triggerRun && !ecoInitialized) {
        ecoInitialized = true;
        try {
          await runEcoPlanAnalysis();
        } catch (error) {
          console.error('Error al ejecutar análisis EcoPlan automático:', error);
        }
      }

      return true;
    }

    async function fetchEcoPresets() {
      const select = document.getElementById('ecoPresetSelect');
      if (!select) {
        logStatus('No se encontró el selector de presets EcoPlan en el DOM.', 'error', 'ecoplan');
        return;
      }

      const hasLocalPresets = Array.isArray(ECO_PRESETS_LOCAL) && ECO_PRESETS_LOCAL.length > 0;

      if (hasLocalPresets) {
        logStatus('Presets urbanos disponibles localmente.', 'info', 'ecoplan');
        await applyEcoPresetList(ECO_PRESETS_LOCAL, { triggerRun: false });
      }

      logStatus('Solicitando presets EcoPlan a la API...', 'info', 'ecoplan');

      try {
        const response = await fetch('/api/ecoplan/presets', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }
        const data = await response.json();
        const presets = Array.isArray(data?.presets) ? data.presets : [];
        if (!presets.length) {
          throw new Error('Respuesta sin presets');
        }

        await applyEcoPresetList(presets, { preserveSelection: true, triggerRun: true });
        logStatus(`Presets EcoPlan cargados (${presets.length}).`, 'success', 'ecoplan');
      } catch (error) {
        const message = error?.message || 'Error desconocido';
        if (hasLocalPresets) {
          logStatus(`No se pudo actualizar presets EcoPlan (${message}). Se usan locales.`, 'warning', 'ecoplan');
          await applyEcoPresetList(ECO_PRESETS_LOCAL, { preserveSelection: true, triggerRun: false });
        } else {
          select.innerHTML = '';
          const option = document.createElement('option');
          option.value = '';
          option.disabled = true;
          option.selected = true;
          option.textContent = 'No se pudieron cargar los presets';
          select.appendChild(option);
          if (ecoRunButton) ecoRunButton.disabled = true;
          logStatus(`Error al cargar presets EcoPlan: ${message}`, 'error', 'ecoplan');
        }
      }
    }

    function createMap() {
      map = L.map('map', { zoomControl: false }).setView([-12.05, -77.05], 10);

      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const esri = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, GIS User Community'
      });

      baseLayers['OpenStreetMap'] = osm;
      baseLayers['ESRI Imagery'] = esri;
      layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);
      L.control.scale({ metric: true }).addTo(map);
      L.control.zoom({ position: 'topright' }).addTo(map);

      map.on('click', (event) => {
        const { lat, lng } = event.latlng;
        
        // Si estamos seleccionando ubicación para el modal MVP
        if (isSelectingLocationForModal) {
          setModalLocation(lat, lng);
          return;
        }
        
        // Modo antiguo de captura para formulario legacy
        if (!citizenReportCaptureMode || (currentMode !== 'ecoplan' && currentMode !== 'citizen')) {
          return;
        }
        
        setCitizenReportLocation(lat, lng, { center: false });
        updateCitizenReportStatus('Ubicación capturada. Completa el formulario para enviar.', 'success');
      });
    }

    async function loadGeeBasemap() {
      try {
        const response = await fetch('/api/map/info', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }

        const mapInfo = await response.json();
        const url = resolveTileUrl(mapInfo);
        if (!url) {
          logStatus('No se pudo construir la URL de la capa base de GEE.', 'warning', 'bloom');
          return;
        }

        const label = mapInfo.description ? `GEE – ${mapInfo.description}` : 'GEE Landsat 8 True Color';
        const geeLayer = L.tileLayer(url, {
          attribution: 'Google Earth Engine (Landsat 8 True Color)',
          maxZoom: mapInfo.maxZoom ?? 18,
          opacity: 1
        });

        baseLayers[label] = geeLayer;
        geeLayer.addTo(map);
        if (baseLayers['OpenStreetMap'] && map.hasLayer(baseLayers['OpenStreetMap'])) {
          map.removeLayer(baseLayers['OpenStreetMap']);
        }
        rebuildLayerControl();
        logStatus('Capa base satelital de GEE cargada.', 'success', 'bloom');
      } catch (error) {
        console.error('No se pudo cargar el mapa base de GEE:', error);
        logStatus(`No se pudo cargar la capa base de GEE: ${error.message}`, 'warning', 'bloom');
      }
    }

    function rebuildLayerControl() {
      if (layerControl) {
        layerControl.remove();
      }
      layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);
    }

    function clearOverlays() {
      Object.values(overlayLayers).forEach((layer) => {
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });
      overlayLayers = {};
      if (roiLayer && map.hasLayer(roiLayer)) {
        map.removeLayer(roiLayer);
      }
      if (contextLayer && map.hasLayer(contextLayer)) {
        map.removeLayer(contextLayer);
      }
      roiLayer = null;
      contextLayer = null;
      rebuildLayerControl();
      layerBadgesContainer.innerHTML = '';
    }

    function addBadge(label) {
      const badge = document.createElement('span');
      badge.className = 'layer-badge';
      badge.textContent = label;
      layerBadgesContainer.appendChild(badge);
    }

    function resolveTileUrl(mapInfo) {
      if (!mapInfo) return null;
      const candidates = [
        mapInfo.tileUrl,
        mapInfo.urlFormat,
        mapInfo.url,
        mapInfo.v1TileUrl,
        mapInfo.legacyTileUrl
      ];

      for (const value of candidates) {
        if (typeof value === 'string' && value.includes('{z}') && value.includes('{x}') && value.includes('{y}')) {
          return value;
        }
      }

      const rawMapId = mapInfo.legacyMapId || mapInfo.mapid;
      if (rawMapId) {
        const hasPath = rawMapId.includes('/');
        const legacyId = hasPath && rawMapId.includes('/maps/') ? rawMapId.split('/maps/')[1] : rawMapId;
        if (legacyId) {
          const suffix = mapInfo.token ? `?token=${mapInfo.token}` : '';
          return `https://earthengine.googleapis.com/map/${legacyId}/{z}/{x}/{y}${suffix}`;
        }
      }

      return null;
    }

    function addOverlayLayer(label, mapInfo, options = {}, mode = currentMode) {
      const url = resolveTileUrl(mapInfo);
      if (!url) {
        logStatus(`No se pudo construir la URL de tiles para ${label}.`, 'error', mode);
        return;
      }

      const layer = L.tileLayer(url, {
        attribution: 'Google Earth Engine',
        opacity: options.opacity ?? mapInfo.opacity ?? 0.85,
        maxZoom: options.maxZoom ?? mapInfo.maxZoom ?? 18
      });
      overlayLayers[label] = layer;
      const shouldShow = options.visible ?? mapInfo.visible ?? false;
      if (shouldShow) {
        layer.addTo(map);
      }
      addBadge(label);
    }

    function updateMapLayers(layers, roiGeometry, contextGeometry, { mode = currentMode } = {}) {
      clearOverlays();

      if (roiLayer) {
        map.removeLayer(roiLayer);
      }
      if (contextLayer) {
        map.removeLayer(contextLayer);
      }

      if (roiGeometry) {
        roiLayer = L.geoJSON(roiGeometry, {
          style: {
            color: '#22d3ee',
            weight: 2,
            dashArray: '6 3',
            fill: false
          }
        }).addTo(map);
        try {
          const bounds = roiLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds.pad(0.25));
          }
        } catch (error) {
          console.warn('No se pudo ajustar el mapa al ROI:', error);
        }
      }

      if (contextGeometry) {
        contextLayer = L.geoJSON(contextGeometry, {
          style: {
            color: '#fbbf24',
            weight: 1.2,
            dashArray: '4 4',
            fill: false
          }
        }).addTo(map);
      }

      if (layers) {
        const entries = Object.entries(layers);
        entries.forEach(([key, layerConfig], index) => {
          const label = layerConfig.name || key;
          let visibleDefault = index === 0;
          if (mode === 'bloom') {
            if (key === 'bloom') visibleDefault = true;
            if (key === 'trueColor') visibleDefault = false;
          }
          if (mode === 'ecoplan') {
            visibleDefault = key === 'heat';
          }
          const defaultOpacity = (mode === 'bloom' && key === 'bloom') ? 0.75 : (layerConfig.opacity ?? 0.85);
          const options = {
            visible: layerConfig.visible ?? visibleDefault,
            opacity: defaultOpacity,
            maxZoom: layerConfig.maxZoom
          };
          addOverlayLayer(label, layerConfig, options, mode);
        });
      }

      rebuildLayerControl();
    }

    function updateContextLayers(contextLayers) {
      if (!contextLayers) return;
      if (contextLayers.chlorophyll) {
        addOverlayLayer('Clorofila MODIS', contextLayers.chlorophyll, { visible: false }, 'bloom');
      }
      if (contextLayers.sst) {
        addOverlayLayer('SST NOAA', contextLayers.sst, { visible: false }, 'bloom');
      }
      rebuildLayerControl();
    }

    function ensureChart(chartRef, canvasId, config) {
      if (chartRef) {
        chartRef.data = config.data;
        chartRef.options = config.options;
        chartRef.update();
        return chartRef;
      }
      const ctx = document.getElementById(canvasId);
      if (!ctx) return null;
      return new Chart(ctx, config);
    }

    function buildLineChartConfig(labels, datasetLabel, data, color) {
      return {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: datasetLabel,
              data,
              borderColor: color,
              backgroundColor: colorWithAlpha(color, 0.18),
              borderWidth: 2,
              pointRadius: 2,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              ticks: { maxRotation: 0, autoSkip: true, color: varColor('--text-muted') },
              grid: { display: false }
            },
            y: {
              ticks: { color: varColor('--text-muted') },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            }
          }
        }
      };
    }

    function updateAreaSummary(areaData) {
      const areaFeatures = getFeatureArray(areaData);
      if (!areaFeatures.length) {
        document.getElementById('areaMax').textContent = '–';
        document.getElementById('areaLast').textContent = '–';
        areaChartInstance = ensureChart(areaChartInstance, 'areaChart', buildLineChartConfig([], 'Área (km²)', [], '#f97316'));
        return;
      }
      const areas = areaFeatures.map((f) => Number(f.properties.area_km2 || 0));
      const dates = areaFeatures.map((f) => f.properties.date);
      const maxArea = Math.max(...areas);
      const lastNonNullIndex = [...areas].reverse().findIndex((value) => value > 0);
      const lastIndex = lastNonNullIndex === -1 ? areas.length - 1 : areas.length - 1 - lastNonNullIndex;
      const lastArea = areas[lastIndex];
      const lastDate = dates[lastIndex];

      document.getElementById('areaMax').textContent = `${formatNumber(maxArea)} km²`;
      document.getElementById('areaLast').textContent = `${formatNumber(lastArea)} km² (${lastDate})`;

      areaChartInstance = ensureChart(areaChartInstance, 'areaChart', buildLineChartConfig(
        dates,
        'Área (km²)',
        areas,
        '#f97316'
      ));
    }

    function updateContextCharts(seriesData, summaryData) {
      const chlorFeatures = getFeatureArray(seriesData?.chlorophyll);
      const chlorLabels = chlorFeatures.map((f) => f.properties?.date);
      const chlorValues = chlorFeatures.map((f) => Number(f.properties?.chlor_a ?? f.properties?.value ?? NaN));

      chlorChartInstance = ensureChart(chlorChartInstance, 'chlorChart', buildLineChartConfig(
        chlorLabels,
        'Clorofila-a (mg/m³)',
        chlorValues,
        '#22d3ee'
      ));

      const sstFeatures = getFeatureArray(seriesData?.sst);
      const sstLabels = sstFeatures.map((f) => f.properties?.date);
      const sstValues = sstFeatures.map((f) => {
        const raw = Number(f.properties?.sst ?? f.properties?.value ?? NaN);
        if (!Number.isFinite(raw)) return NaN;
        return raw > 150 ? raw - 273.15 : raw;
      });

      sstChartInstance = ensureChart(sstChartInstance, 'sstChart', buildLineChartConfig(
        sstLabels,
        'SST (°C)',
        sstValues,
        '#ef4444'
      ));

      let chlorMean = Number(summaryData?.chlor_mean ?? NaN);
      if (!Number.isFinite(chlorMean)) {
        chlorMean = averageNumeric(chlorValues.filter((value) => Number.isFinite(value)));
      }

      let sstMean = Number(summaryData?.sst_mean ?? NaN);
      if (Number.isFinite(sstMean) && sstMean > 150) {
        sstMean -= 273.15;
      } else if (!Number.isFinite(sstMean)) {
        sstMean = averageNumeric(sstValues.filter((value) => Number.isFinite(value)));
      }

      document.getElementById('chlorMean').textContent = formatNumber(chlorMean, 2);
      document.getElementById('sstMean').textContent = formatNumber(sstMean, 2);
    }

    function getSummaryNumber(summary, key) {
      if (!summary || summary[key] === null || summary[key] === undefined) {
        return NaN;
      }
      const value = Number(summary[key]);
      return Number.isFinite(value) ? value : NaN;
    }

    function updateEcoSummary(summary) {
      const s = summary || {};
      const ndviMean = getSummaryNumber(s, 'ndvi_mean');
      const ndviMin = getSummaryNumber(s, 'ndvi_min');
      const ndviMax = getSummaryNumber(s, 'ndvi_max');

      const lstMean = getSummaryNumber(s, 'lst_mean');
      const lstMin = getSummaryNumber(s, 'lst_min');
      const lstMax = getSummaryNumber(s, 'lst_max');

      const heatMean = getSummaryNumber(s, 'heat_mean');
      const heatMin = getSummaryNumber(s, 'heat_min');
      const heatMax = getSummaryNumber(s, 'heat_max');

      const ndwiMean = getSummaryNumber(s, 'ndwi_mean');
      const ndwiMin = getSummaryNumber(s, 'ndwi_min');
      const ndwiMax = getSummaryNumber(s, 'ndwi_max');

      const aodMean = getSummaryNumber(s, 'aod_mean');
      const aodMin = getSummaryNumber(s, 'aod_min');
      const aodMax = getSummaryNumber(s, 'aod_max');

      const airQualityMean = getSummaryNumber(s, 'air_quality_mean');
      const airQualityMin = getSummaryNumber(s, 'air_quality_min');
      const airQualityMax = getSummaryNumber(s, 'air_quality_max');

      const no2Mean = getSummaryNumber(s, 'no2_mean');
      const pm25Mean = getSummaryNumber(s, 'pm25_mean');

      const imperviousMean = getSummaryNumber(s, 'impervious_mean');
      const imperviousMin = getSummaryNumber(s, 'impervious_min');
      const imperviousMax = getSummaryNumber(s, 'impervious_max');

      const waterRiskMean = getSummaryNumber(s, 'water_risk_mean');
      const waterRiskMin = getSummaryNumber(s, 'water_risk_min');
      const waterRiskMax = getSummaryNumber(s, 'water_risk_max');

  const greenPerCapitaMean = getSummaryNumber(s, 'green_per_capita_mean');
  const greenPerCapitaMin = getSummaryNumber(s, 'green_per_capita_min');
  const greenPerCapitaMax = getSummaryNumber(s, 'green_per_capita_max');
  const greenAreaM2 = getSummaryNumber(s, 'green_area_m2');
  const greenAreaHa = Number.isFinite(greenAreaM2) ? greenAreaM2 / 10000 : NaN;
  const greenDeficitRatio = getSummaryNumber(s, 'green_deficit_ratio');

  const populationMean = getSummaryNumber(s, 'population_mean');
  const populationMax = getSummaryNumber(s, 'population_max');
  const populationTotal = getSummaryNumber(s, 'population_total');

      if (ecoSummaryEls.ndviMean) ecoSummaryEls.ndviMean.textContent = formatNumber(ndviMean, 3);
      if (ecoSummaryEls.ndviRange) ecoSummaryEls.ndviRange.textContent = buildRangeText(ndviMin, ndviMax, 3);

      if (ecoSummaryEls.lstMean) ecoSummaryEls.lstMean.textContent = formatNumber(lstMean, 2);
      if (ecoSummaryEls.lstRange) ecoSummaryEls.lstRange.textContent = buildRangeText(lstMin, lstMax, 2);

      if (ecoSummaryEls.heatMean) ecoSummaryEls.heatMean.textContent = formatNumber(heatMean, 2);
      if (ecoSummaryEls.heatRange) ecoSummaryEls.heatRange.textContent = buildRangeText(heatMin, heatMax, 2);

      if (ecoSummaryEls.aodMean) ecoSummaryEls.aodMean.textContent = formatNumber(aodMean, 3);
      if (ecoSummaryEls.aodRange) ecoSummaryEls.aodRange.textContent = buildRangeText(aodMin, aodMax, 3);

      if (ecoSummaryEls.airQualityMean) ecoSummaryEls.airQualityMean.textContent = formatNumber(airQualityMean, 2);
      if (ecoSummaryEls.airQualityRange) ecoSummaryEls.airQualityRange.textContent = buildRangeText(airQualityMin, airQualityMax, 2);

      if (ecoSummaryEls.no2Mean) {
        const no2Micro = Number.isFinite(no2Mean) ? no2Mean * 1e6 : NaN;
        ecoSummaryEls.no2Mean.textContent = formatNumber(no2Micro, 1);
      }

      if (ecoSummaryEls.pm25Mean) ecoSummaryEls.pm25Mean.textContent = formatNumber(pm25Mean, 1);

      if (ecoSummaryEls.ndwiMean) ecoSummaryEls.ndwiMean.textContent = formatNumber(ndwiMean, 3);
      if (ecoSummaryEls.ndwiRange) ecoSummaryEls.ndwiRange.textContent = buildRangeText(ndwiMin, ndwiMax, 3);

      if (ecoSummaryEls.imperviousMean) ecoSummaryEls.imperviousMean.textContent = formatNumber(imperviousMean, 3);
      if (ecoSummaryEls.imperviousRange) ecoSummaryEls.imperviousRange.textContent = buildRangeText(imperviousMin, imperviousMax, 3);

      if (ecoSummaryEls.waterRiskMean) ecoSummaryEls.waterRiskMean.textContent = formatNumber(waterRiskMean, 2);
      if (ecoSummaryEls.waterRiskRange) ecoSummaryEls.waterRiskRange.textContent = buildRangeText(waterRiskMin, waterRiskMax, 2);

      if (ecoSummaryEls.greenPerCapitaMean) ecoSummaryEls.greenPerCapitaMean.textContent = formatNumber(greenPerCapitaMean, 1);
      if (ecoSummaryEls.greenPerCapitaRange) ecoSummaryEls.greenPerCapitaRange.textContent = buildRangeText(greenPerCapitaMin, greenPerCapitaMax, 1);
      if (ecoSummaryEls.greenAreaTotal) ecoSummaryEls.greenAreaTotal.textContent = formatNumber(greenAreaHa, 1);

      if (ecoSummaryEls.greenDeficitRatio) {
        if (Number.isFinite(greenDeficitRatio)) {
          ecoSummaryEls.greenDeficitRatio.textContent = `${formatNumber(greenDeficitRatio * 100, 1)} %`;
        } else {
          ecoSummaryEls.greenDeficitRatio.textContent = '–';
        }
      }

      if (ecoSummaryEls.populationMean) ecoSummaryEls.populationMean.textContent = formatNumber(populationMean, 0);
      if (ecoSummaryEls.populationMax) ecoSummaryEls.populationMax.textContent = formatNumber(populationMax, 0);
      if (ecoSummaryEls.populationTotal) ecoSummaryEls.populationTotal.textContent = formatNumber(populationTotal, 0);
    }

    function updateEcoCharts(seriesData) {
      const ndviFeatures = getFeatureArray(seriesData?.ndvi);
      const ndviLabels = ndviFeatures.map((f) => f.properties?.date);
      const ndviValues = ndviFeatures.map((f) => Number(f.properties?.ndvi ?? f.properties?.value ?? NaN));
      ecoNdviChartInstance = ensureChart(ecoNdviChartInstance, 'ecoNdviChart', buildLineChartConfig(
        ndviLabels,
        'NDVI promedio',
        ndviValues,
        '#16a34a'
      ));

      const lstFeatures = getFeatureArray(seriesData?.lst);
      const lstLabels = lstFeatures.map((f) => f.properties?.date);
      const lstValues = lstFeatures.map((f) => Number(f.properties?.lst_c ?? f.properties?.value ?? NaN));
      ecoLstChartInstance = ensureChart(ecoLstChartInstance, 'ecoLstChart', buildLineChartConfig(
        lstLabels,
        'LST (°C)',
        lstValues,
        '#f97316'
      ));

      const aodFeatures = getFeatureArray(seriesData?.aod);
      const aodLabels = aodFeatures.map((f) => f.properties?.date);
      const aodValues = aodFeatures.map((f) => Number(f.properties?.aod ?? f.properties?.value ?? NaN));
      ecoAodChartInstance = ensureChart(ecoAodChartInstance, 'ecoAodChart', buildLineChartConfig(
        aodLabels,
        'AOD promedio',
        aodValues,
        '#9333ea'
      ));

      const no2Features = getFeatureArray(seriesData?.no2);
      const no2Labels = no2Features.map((f) => f.properties?.date);
      const no2Values = no2Features.map((f) => {
        const raw = Number(f.properties?.no2 ?? f.properties?.value ?? NaN);
        return Number.isFinite(raw) ? raw * 1e6 : NaN;
      });
      ecoNo2ChartInstance = ensureChart(ecoNo2ChartInstance, 'ecoNo2Chart', buildLineChartConfig(
        no2Labels,
        'NO₂ (µmol·m⁻²)',
        no2Values,
        '#2563eb'
      ));

      const pm25Features = getFeatureArray(seriesData?.pm25);
      const pm25Labels = pm25Features.map((f) => f.properties?.date);
      const pm25Values = pm25Features.map((f) => Number(f.properties?.pm25 ?? f.properties?.value ?? NaN));
      ecoPm25ChartInstance = ensureChart(ecoPm25ChartInstance, 'ecoPm25Chart', buildLineChartConfig(
        pm25Labels,
        'PM₂.₅ (µg·m⁻³)',
        pm25Values,
        '#dc2626'
      ));
    }

    function resolveDistrictName(properties = {}, fallbackIndex) {
      const nameKeys = ['name', 'NAME', 'NAM', 'NOMBRE', 'NOM_DIST', 'distrito', 'DISTRITO', 'DIST', 'DIST_NAME', 'Provincia', 'provincia'];
      for (const key of nameKeys) {
        if (properties[key]) {
          return properties[key];
        }
      }
      if (fallbackIndex !== undefined) {
        return `Área ${fallbackIndex + 1}`;
      }
      return 'Área';
    }

    function updateEcoBoundaryTable(boundaryStats) {
      if (!ecoSummaryEls.boundaryBody || !ecoSummaryEls.boundaryCard) {
        return;
      }

      ecoSummaryEls.boundaryBody.innerHTML = '';

      const features = getFeatureArray(boundaryStats);
      if (!features.length) {
        ecoSummaryEls.boundaryCard.hidden = true;
        return;
      }

      features.slice(0, 25).forEach((feature, index) => {
        const props = feature.properties || {};
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${resolveDistrictName(props, index)}</td>
          <td>${formatNumber(props.NDVI_mean, 3)}</td>
          <td>${formatNumber(props.LST_C_mean, 2)}</td>
          <td>${formatNumber(props.HeatVulnerability_mean, 2)}</td>
          <td>${formatNumber(props.population_density_mean, 0)}</td>
        `;
        ecoSummaryEls.boundaryBody.appendChild(row);
      });

      ecoSummaryEls.boundaryCard.hidden = false;
    }

    function renderBloomResult(result, { silent = false } = {}) {
      if (!result) return;
      lastBloomResult = result;

      if (currentMode !== 'bloom') {
        if (!silent) {
          logStatus('Resultado de floraciones listo. Cambia a su modo para visualizarlo.', 'info', 'bloom');
        }
        return;
      }
      const { mapData, statsData, contextData } = result;
      const thresholds = mapData?.thresholds || mapData?.thresholdsEvaluated;
      const contextGeometry = contextData?.contextGeometry || contextData?.contextRoi || null;

      if (thresholds) {
        updateThresholdCard(thresholds);
      }

      updateMapLayers(mapData?.layers || {}, mapData?.roi, contextGeometry, { mode: 'bloom' });
      if (contextData?.layers) {
        updateContextLayers(contextData.layers);
      }
      updateAreaSummary(statsData?.areaSeries);
      updateContextCharts(contextData?.series, contextData?.summary);

      if (!silent) {
        logStatus('Capas actualizadas correctamente.', 'success', 'bloom');
        if (mapData?.presetMeta?.label) {
          logStatus(`ROI analizado: ${mapData.presetMeta.label}`, 'success', 'bloom');
        }
      }
    }

    function renderEcoResult(result, { silent = false } = {}) {
      if (!result) return;

      lastEcoResult = result;

      if (currentMode !== 'ecoplan') {
        if (!silent) {
          logStatus('Indicadores EcoPlan listos. Cambia al modo EcoPlan para verlos.', 'info', 'ecoplan');
        }
        return;
      }

      updateMapLayers(result.layers || {}, result.roi, null, { mode: 'ecoplan' });
      updateEcoSummary(result.summary);
      updateEcoCharts(result.series);
      updateEcoBoundaryTable(result.boundaryStats);

      if (!silent) {
        logStatus('Indicadores EcoPlan actualizados.', 'success', 'ecoplan');
        if (result.presetMeta?.label) {
          logStatus(`Área analizada: ${result.presetMeta.label}`, 'success', 'ecoplan');
        }
      }
    }

    function setMode(mode, { reRender = true, silent = false } = {}) {
      const validModes = ['bloom', 'ecoplan', 'citizen'];
      const normalized = validModes.includes(mode) ? mode : 'bloom';
      currentMode = normalized;

      modeButtons.forEach((button) => {
        const isActive = button.dataset.mode === normalized;
        button.classList.toggle('active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });

      const isBloom = normalized === 'bloom';
      const isEcoplan = normalized === 'ecoplan';
      const isCitizen = normalized === 'citizen';
      
      bloomControls.classList.toggle('hidden', !isBloom);
      bloomSummarySection.classList.toggle('hidden', !isBloom);
      ecoControls.classList.toggle('hidden', !isEcoplan);
      ecoSummarySection.classList.toggle('hidden', !isEcoplan);
      
      const citizenControls = document.getElementById('citizenControls');
      if (citizenControls) {
        citizenControls.classList.toggle('hidden', !isCitizen);
      }

      if (normalized === 'ecoplan') {
        ensureReportRunsLoaded();
        ensureCitizenReportsLoaded();
        scheduleReportRunsAutoRefresh({ fetchImmediately: reportRunsAutoRefreshEnabled });
        setCitizenReportCaptureMode(false);
      } else if (normalized === 'citizen') {
        ensureCitizenReportsLoaded();
        clearReportRunsAutoRefreshTimer();
        // Activar modo de captura automáticamente en la pestaña de ciudadanos
        setCitizenReportCaptureMode(true);
      } else {
        clearReportRunsAutoRefreshTimer();
        setCitizenReportCaptureMode(false);
      }

      persistModePreference(normalized);
      updateReportRunsAutoRefreshStatusLabel();

      if (!reRender) {
        return;
      }

      if (normalized === 'bloom') {
        if (lastBloomResult) {
          renderBloomResult(lastBloomResult, { silent: true });
        } else if (!silent) {
          logStatus('Configura los parámetros y ejecuta el análisis de floraciones.', 'info', 'bloom');
        }
      } else if (normalized === 'ecoplan') {
        if (lastEcoResult) {
          renderEcoResult(lastEcoResult, { silent: true });
        } else if (!silent) {
          logStatus('Completa el formulario EcoPlan para obtener indicadores urbanos.', 'info', 'ecoplan');
        }
      } else if (normalized === 'citizen') {
        if (!silent) {
          logStatus('Haz clic en el mapa para marcar la ubicación de tu reporte.', 'info', 'ecoplan');
        }
      }
    }

    function updateThresholdCard(thresholds) {
      document.getElementById('thresholdNdci').textContent = formatNumber(thresholds?.ndci, 3);
      document.getElementById('thresholdFai').textContent = formatNumber(thresholds?.fai, 3);
      document.getElementById('thresholdFaiAlt').textContent = formatNumber(thresholds?.faiAlt, 3);
    }
    function updateBufferPlaceholder() {
      const select = document.getElementById('presetSelect');
      const bufferInput = document.getElementById('buffer');
      if (!select || !bufferInput || !select.selectedOptions.length) return;
      const selectedOption = select.selectedOptions[0];
      const hasBuffer = selectedOption && selectedOption.dataset.defaultBuffer !== undefined;
      if (hasBuffer) {
        const value = Number(selectedOption.dataset.defaultBuffer);
        bufferInput.placeholder = Number.isFinite(value) && value !== 0 ? `Sugerencia: ${value} m` : 'Opcional';
      } else {
        bufferInput.placeholder = 'Opcional';
      }
    }

    function updateEcoBufferPlaceholder() {
      const select = document.getElementById('ecoPresetSelect');
      const bufferInput = document.getElementById('ecoBuffer');
      if (!select || !bufferInput || !select.selectedOptions.length) return;
      const selectedOption = select.selectedOptions[0];
      const hasBuffer = selectedOption && selectedOption.dataset.defaultBuffer !== undefined;
      if (hasBuffer) {
        const value = Number(selectedOption.dataset.defaultBuffer);
        bufferInput.placeholder = Number.isFinite(value) && value !== 0 ? `Sugerencia: ${value} m` : 'Opcional';
      } else {
        bufferInput.placeholder = 'Opcional';
      }
    }

    function collectEcoPayload() {
      const form = document.getElementById('ecoForm');
      if (!form) {
        return null;
      }
      const formData = new FormData(form);
      return {
        preset: formData.get('preset'),
        start: formData.get('start'),
        end: formData.get('end'),
        cloudPercentage: Number(formData.get('cloudPercentage')) || 20,
        populationYear: Number(formData.get('populationYear')) || 2020,
        buffer: formData.get('buffer') ? Number(formData.get('buffer')) : undefined,
        districtsAsset: formData.get('districtsAsset') || undefined
      };
    }

    function setReportButtonsDisabled(disabled) {
      ecoReportButtons.forEach((button) => {
        button.disabled = disabled;
      });
    }

    function sanitizeFilename(base, fallback = 'ecoplan-report') {
      const value = (base || fallback).toString().trim();
      return value.replace(/[^a-z0-9-_]+/gi, '_').replace(/_{2,}/g, '_');
    }

    function getFilenameFromDisposition(disposition, fallback) {
      if (!disposition) {
        return fallback;
      }
      const encodedMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
      if (encodedMatch && encodedMatch[1]) {
        try {
          return decodeURIComponent(encodedMatch[1]);
        } catch (error) {
          // ignore decoding error and continue
        }
      }
      const plainMatch = disposition.match(/filename="?([^";]+)"?/i);
      if (plainMatch && plainMatch[1]) {
        return plainMatch[1];
      }
      return fallback;
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    async function downloadEcoPlanReport(format) {
      const payload = collectEcoPayload();
      if (!payload) {
        logStatus('No se pudo leer el formulario EcoPlan.', 'error', 'ecoplan');
        return;
      }

      const normalizedFormat = (format || 'pdf').toLowerCase();
      const requestBody = { ...payload, format: normalizedFormat };
      const queryFormat = encodeURIComponent(normalizedFormat);
      const presetSlug = sanitizeFilename(payload.preset || 'urbano');
      const defaultFilename = `${presetSlug}.${normalizedFormat === 'html' ? 'html' : normalizedFormat}`;

      setLoading(true, 'ecoplan');
      setReportButtonsDisabled(true);

      try {
        logStatus(`Generando reporte EcoPlan (${normalizedFormat.toUpperCase()})...`, 'info', 'ecoplan');
        const response = await fetch(`/api/reports/generate?format=${queryFormat}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || response.statusText || 'Error desconocido');
        }

        if (normalizedFormat === 'html') {
          const htmlText = await response.text();
          const blob = new Blob([htmlText], { type: 'text/html;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
          setTimeout(() => URL.revokeObjectURL(url), 120000);
          logStatus('Reporte HTML abierto en una nueva pestaña.', 'success', 'ecoplan');
          return;
        }

        const contentType = response.headers.get('Content-Type') || '';
        if (contentType.includes('application/json')) {
          const errorJson = await response.json();
          throw new Error(errorJson?.message || 'Error inesperado al generar el reporte.');
        }

        const blob = await response.blob();
        const disposition = response.headers.get('Content-Disposition');
        const filename = getFilenameFromDisposition(disposition, defaultFilename);
        downloadBlob(blob, filename);
        logStatus(`Reporte ${normalizedFormat.toUpperCase()} descargado correctamente.`, 'success', 'ecoplan');
      } catch (error) {
        console.error(error);
        logStatus(`No se pudo generar el reporte: ${error.message}`, 'error', 'ecoplan');
      } finally {
        setLoading(false, 'ecoplan');
        setReportButtonsDisabled(false);
      }
    }

    async function loadQuickView() {
      setLoading(true, 'bloom');

      try {
        logStatus('Solicitando imagen Landsat 8 True Color...', 'info', 'bloom');
        const response = await fetch('/api/map/info', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }

        const data = await response.json();

        clearOverlays();
        if (roiLayer) {
          map.removeLayer(roiLayer);
          roiLayer = null;
        }
        if (contextLayer) {
          map.removeLayer(contextLayer);
          contextLayer = null;
        }

        addOverlayLayer('Landsat 8 – True Color', {
          ...data,
          name: 'Landsat 8 True Color'
        }, { visible: true, opacity: 1 });

        logStatus('Imagen básica cargada correctamente.', 'success', 'bloom');
      } catch (error) {
        console.error(error);
        logStatus(`No se pudo cargar la imagen simple: ${error.message}`, 'error', 'bloom');
      } finally {
        setLoading(false, 'bloom');
      }
    }

    async function runBloomAnalysis(event) {
      event?.preventDefault();
      setLoading(true, 'bloom');

      try {
        const formData = new FormData(document.getElementById('controlForm'));
        const payload = {
          preset: formData.get('preset'),
          start: formData.get('start'),
          end: formData.get('end'),
          cloudPercentage: Number(formData.get('cloudPercentage')) || 35,
          ndciThreshold: Number(formData.get('ndciThreshold')) || 0.1,
          faiThreshold: Number(formData.get('faiThreshold')) || 0.005,
          adaptiveThreshold: formData.get('adaptiveThreshold') === 'on',
          minPixelsClean: Number(formData.get('minPixelsClean')) || 12,
          buffer: formData.get('buffer') ? Number(formData.get('buffer')) : undefined
        };

        const contextBufferKm = Number(formData.get('contextBufferKm')) || 5;
        const contextPayload = { ...payload, contextBuffer: contextBufferKm * 1000 };

        logStatus('Solicitando datos de bloom a la API...', 'info', 'bloom');

        const [mapResponse, statsResponse, contextResponse] = await Promise.all([
          fetch('/api/bloom/map', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }),
          fetch('/api/bloom/stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }),
          fetch('/api/bloom/context', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(contextPayload)
          })
        ]);

        if (!mapResponse.ok) {
          const errorText = await mapResponse.text();
          throw new Error(`Mapa bloom: ${errorText || mapResponse.statusText}`);
        }
        if (!statsResponse.ok) {
          const errorText = await statsResponse.text();
          throw new Error(`Estadísticas bloom: ${errorText || statsResponse.statusText}`);
        }
        if (!contextResponse.ok) {
          const errorText = await contextResponse.text();
          throw new Error(`Contexto regional: ${errorText || contextResponse.statusText}`);
        }

        const [mapData, statsData, contextData] = await Promise.all([
          mapResponse.json(),
          statsResponse.json(),
          contextResponse.json()
        ]);

        renderBloomResult({
          mapData,
          statsData,
          contextData
        });
      } catch (error) {
        console.error(error);
        logStatus(`Error al ejecutar análisis: ${error.message}`, 'error', 'bloom');
      } finally {
        setLoading(false, 'bloom');
      }
    }

    async function runEcoPlanAnalysis(event) {
      event?.preventDefault();
      setLoading(true, 'ecoplan');
      setReportButtonsDisabled(true);

      try {
        const payload = collectEcoPayload();
        if (!payload) {
          throw new Error('No se pudo leer el formulario EcoPlan.');
        }

        logStatus('Solicitando análisis EcoPlan Urbano...', 'info', 'ecoplan');

        const response = await fetch('/api/ecoplan/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || response.statusText || 'Error desconocido');
        }

        const result = await response.json();
        renderEcoResult(result);
      } catch (error) {
        console.error(error);
        logStatus(`Error EcoPlan: ${error.message}`, 'error', 'ecoplan');
      } finally {
        setLoading(false, 'ecoplan');
        setReportButtonsDisabled(false);
      }
    }

    async function fetchPresets() {
      await fetchBloomPresets();
      await fetchEcoPresets();
    }

    document.addEventListener('DOMContentLoaded', () => {
      createMap();
      loadGeeBasemap();
      fetchPresets();
      loadReportRunsAutoRefreshSettings();
      applyReportRunsAutoRefreshDomState();
      
      // Inicializar sistema Explorar
      initializeExploreSystem();
      
      const savedModePreference = loadModePreference();
      if (savedModePreference && savedModePreference !== currentMode) {
        currentMode = savedModePreference;
      }

      document.getElementById('controlForm').addEventListener('submit', runBloomAnalysis);
      document.getElementById('presetSelect').addEventListener('change', updateBufferPlaceholder);
      document.getElementById('ecoForm').addEventListener('submit', runEcoPlanAnalysis);
      document.getElementById('ecoPresetSelect').addEventListener('change', updateEcoBufferPlaceholder);
      modeButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const targetMode = button.dataset.mode;
          if (targetMode) {
            setMode(targetMode);
          }
        });
      });
      ecoReportButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const format = button.dataset.reportFormat;
          if (format) {
            downloadEcoPlanReport(format);
          }
        });
      });
      if (refreshReportRunsButton) {
        refreshReportRunsButton.addEventListener('click', () => {
          fetchReportRuns({ announce: true });
        });
      }
      if (reportRunsJobFilter) {
        reportRunsJobFilter.addEventListener('change', () => {
          reportRunsFilterState.jobId = reportRunsJobFilter.value;
          fetchReportRuns({ announce: true });
        });
      }
      if (reportRunsStatusFilter) {
        reportRunsStatusFilter.addEventListener('change', () => {
          reportRunsFilterState.status = reportRunsStatusFilter.value;
          fetchReportRuns({ announce: true });
        });
      }
      if (reportRunsAutoRefreshToggle) {
        reportRunsAutoRefreshToggle.addEventListener('change', () => {
          reportRunsAutoRefreshEnabled = reportRunsAutoRefreshToggle.checked;
          persistReportRunsAutoRefreshSettings();
          scheduleReportRunsAutoRefresh({ fetchImmediately: reportRunsAutoRefreshEnabled && currentMode === 'ecoplan' });
          updateReportRunsAutoRefreshStatusLabel();
        });
      }
      if (reportRunsAutoRefreshIntervalSelect) {
        reportRunsAutoRefreshIntervalSelect.addEventListener('change', () => {
          reportRunsAutoRefreshIntervalMs = parseAutoRefreshInterval(reportRunsAutoRefreshIntervalSelect.value);
          persistReportRunsAutoRefreshSettings();
          scheduleReportRunsAutoRefresh({ fetchImmediately: reportRunsAutoRefreshEnabled && currentMode === 'ecoplan' });
        });
      }
      if (citizenReportForm) {
        citizenReportForm.addEventListener('submit', submitCitizenReport);
      }
      if (citizenReportSelectOnMapButton) {
        citizenReportSelectOnMapButton.addEventListener('click', () => {
          if (currentMode !== 'citizen' && currentMode !== 'ecoplan') {
            setMode('citizen');
          }
          setCitizenReportCaptureMode(true);
          updateCitizenReportStatus('Haz clic en el mapa para marcar la ubicación.', 'info');
          logStatus('Haz clic en el mapa para fijar la ubicación del reporte ciudadano.', 'info', 'ecoplan');
        });
      }
      if (refreshCitizenReportsButton) {
        refreshCitizenReportsButton.addEventListener('click', () => {
          fetchCitizenReports({ announce: true });
        });
      }
      
      // Contador de caracteres para la descripción
      if (citizenReportDescriptionInput) {
        const charCountEl = document.getElementById('charCount');
        if (charCountEl) {
          citizenReportDescriptionInput.addEventListener('input', () => {
            const count = citizenReportDescriptionInput.value.length;
            charCountEl.textContent = count;
            if (count > 1900) {
              charCountEl.style.color = '#ef4444';
            } else if (count > 1500) {
              charCountEl.style.color = '#f59e0b';
            } else {
              charCountEl.style.color = 'var(--text-muted)';
            }
          });
        }
      }
      
      if (citizenReportLatitudeInput && citizenReportLongitudeInput) {
        const handleManualLocationUpdate = () => {
          const lat = Number(citizenReportLatitudeInput.value);
          const lng = Number(citizenReportLongitudeInput.value);
          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            setCitizenReportLocation(lat, lng, { center: false });
          }
        };
        citizenReportLatitudeInput.addEventListener('change', handleManualLocationUpdate);
        citizenReportLongitudeInput.addEventListener('change', handleManualLocationUpdate);
      }
      
      // ========== EVENT LISTENERS PARA EL NUEVO MODAL MVP ==========
      if (openNewReportModalBtn) {
        openNewReportModalBtn.addEventListener('click', openNewReportModal);
      }
      
      if (closeNewReportModalBtn) {
        closeNewReportModalBtn.addEventListener('click', closeNewReportModal);
      }
      
      if (newReportModal) {
        newReportModal.addEventListener('click', (event) => {
          if (event.target === newReportModal) {
            closeNewReportModal();
          }
        });
      }
      
      // Selección de categoría
      document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', () => {
          selectCategory(card.dataset.category);
        });
      });
      
      // Navegación entre pasos
      if (prevStepBtn) {
        prevStepBtn.addEventListener('click', () => {
          if (currentStep > 1) {
            showReportStep(currentStep - 1);
          }
        });
      }
      
      if (nextStepBtn) {
        nextStepBtn.addEventListener('click', () => {
          if (currentStep < 3) {
            const nextStep = currentStep + 1;
            showReportStep(nextStep);
            
            // Si pasamos al paso 2, inicializar el mapa
            if (nextStep === 2) {
              setTimeout(() => {
                initializeModalMap();
                showModalMapInstructions();
              }, 100);
            }
          }
        });
      }
      
      // Botón para usar mi ubicación
      const useMyLocationBtn = document.getElementById('useMyLocationBtn');
      if (useMyLocationBtn) {
        useMyLocationBtn.addEventListener('click', useMyLocation);
      }
      
      // Botón para centrar en Lima
      const centerMapBtn = document.getElementById('centerMapBtn');
      if (centerMapBtn) {
        centerMapBtn.addEventListener('click', centerMapOnLima);
      }
      
      // Submit del formulario
      if (newReportForm) {
        newReportForm.addEventListener('submit', submitNewReport);
      }
      
      // Contador de caracteres en el modal
      if (modalDescriptionInput && modalCharCount) {
        modalDescriptionInput.addEventListener('input', () => {
          const count = modalDescriptionInput.value.length;
          modalCharCount.textContent = count;
          if (count > 450) {
            modalCharCount.style.color = '#ef4444';
          } else if (count > 350) {
            modalCharCount.style.color = '#f59e0b';
          } else {
            modalCharCount.style.color = 'var(--text-muted)';
          }
        });
      }
      
      // Botón de cerrar después de éxito
      if (closeSuccessBtn) {
        closeSuccessBtn.addEventListener('click', () => {
          closeNewReportModal();
          // Resetear el modal
          document.querySelector('.modal-header').style.display = '';
          document.querySelector('.modal-footer').style.display = '';
          reportSuccess.style.display = 'none';
          submitReportBtn.disabled = false;
          submitReportBtn.textContent = '📤 Enviar Reporte';
        });
      }
      
      document.addEventListener('visibilitychange', handleVisibilityChange);
  setCitizenReportCaptureMode(false);
      setMode(currentMode, { reRender: false, silent: true });
      if (quickViewButton) {
        quickViewButton.addEventListener('click', loadQuickView);
      }
      logStatus('Interfaz lista. Usa "Ver imagen satelital simple" para probar rápidamente.', 'info');
    });
  </script>
</body>
</html>