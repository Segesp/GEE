<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Monitoreo de floraciones algales y EcoPlan Urbano para Lima.">
  <title>EcoPlan Urbano &amp; Bloom Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-sA+4psJ1BLwh7QJHsQ6bUaz2+miFjCwXTlzAIXazhbugzuDUFcPRl1b/HFB70dNFuPuE6iu+/g9A5lH0p9fQ==" crossorigin="">
  <style>
    :root {
      --bg: #0b1120;
      --surface: #0f172a;
      --surface-muted: rgba(15, 23, 42, 0.6);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.24);
      --primary: #2563eb;
      --success: #16a34a;
      --warning: #eab308;
      --error: #f87171;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.12), transparent 40%), #020617;
      color: var(--text);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 32px clamp(16px, 5vw, 48px) 24px;
      gap: 24px;
    }

    header h1 {
      font-size: clamp(1.8rem, 2.5vw, 2.4rem);
      margin: 0 0 8px;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      line-height: 1.5;
    }

    main {
      padding: 0 clamp(16px, 5vw, 48px) 48px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(320px, 360px) 1fr;
      gap: 24px;
      align-items: start;
    }

    @media (max-width: 1100px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .view-switcher {
      display: inline-flex;
      gap: 10px;
      background: var(--surface);
      border-radius: 999px;
      padding: 6px;
      border: 1px solid var(--border);
      align-self: flex-start;
      margin-bottom: 24px;
    }

    body.modal-open {
      overflow: hidden;
    }
    .mode-button {
      border: none;
      background: transparent;
      padding: 8px 20px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-muted);
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.78);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(16px, 5vw, 32px);
      z-index: 999;
      backdrop-filter: blur(6px);
    }
    .modal-dialog {
      width: min(780px, 100%);
      max-height: 90vh;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
      padding: clamp(20px, 4vw, 28px);
      position: relative;
    }
    .modal-close-button {
      position: absolute;
      top: 14px;
      right: 14px;
      background: rgba(15, 23, 42, 0.4);
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 999px;
      width: 36px;
      height: 36px;
      font-size: 1.4rem;
      font-weight: 700;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .modal-close-button:hover {
      color: var(--text);
      border-color: rgba(148, 163, 184, 0.8);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 18px;
    }
    .modal-subtitle {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .modal-title {
      margin: 0;
      font-size: 1.35rem;
    }
    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .modal-section h4 {
      margin: 0 0 8px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .key-value-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px 18px;
    }
    .key-value-grid .key-label {
      display: block;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .key-value-grid .key-value {
      font-size: 0.95rem;
      font-weight: 600;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .metrics-card {
      background: rgba(15, 23, 42, 0.25);
      border: 1px solid rgba(148, 163, 184, 0.24);
      border-radius: 12px;
      padding: 12px;
    }
    .metrics-card h5 {
      margin: 0 0 6px;
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .metrics-card .metric-value {
      font-size: 1rem;
      font-weight: 600;
    }
    .json-block {
      background: rgba(15, 23, 42, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 12px;
      padding: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 240px;
    }
    .results-list,
    .notifications-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .result-item,
    .notification-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      background: rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 12px;
      padding: 10px 14px;
    }
    .result-item-main,
    .notification-item-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .result-item-actions,
    .notification-item-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .result-item-actions a {
      color: var(--primary);
      font-size: 0.8rem;
      text-decoration: none;
    }
    .result-item-actions a:hover {
      text-decoration: underline;
    }
    .clickable-row {
      cursor: pointer;
    }
    .clickable-row:focus {
      outline: 2px solid var(--primary);
      outline-offset: -2px;
    }

    .mode-button.active {
      background: linear-gradient(120deg, #2563eb, #0ea5e9);
      color: #fff;
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
    }

    .hidden {
      display: none !important;
    }

    .card {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
      padding: 18px 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .controls form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    input[type="number"],
    input[type="date"],
    select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.03);
      color: inherit;
      font-size: 0.95rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 123, 182, 0.2);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      background: linear-gradient(120deg, #2563eb, #0ea5e9);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.3);
    }

    .button-secondary {
      background: rgba(37, 99, 235, 0.18);
      color: var(--text);
      border: 1px solid rgba(37, 99, 235, 0.35);
    }

    .button-secondary:hover {
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.35);
      transform: translateY(-2px);
    }

    .download-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .download-buttons button {
      flex: 1 1 140px;
    }

    .history-filters {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .history-filters label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .history-filters select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.12);
      color: inherit;
      font-size: 0.82rem;
    }

    .history-controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    .history-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.22);
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--text-muted);
      user-select: none;
      transition: border 0.2s ease, background 0.2s ease;
    }

    .history-toggle input {
      accent-color: var(--primary);
    }

    .history-toggle:hover {
      border-color: rgba(148, 163, 184, 0.4);
    }

    .history-controls select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.12);
      color: inherit;
      font-size: 0.82rem;
    }

    .map-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #map {
      width: 100%;
      min-height: 520px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .summary-card h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-muted);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .summary-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 8px 0 4px;
    }

    .summary-card small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    canvas {
      width: 100% !important;
      height: 280px !important;
    }

    .status-log {
      max-height: 140px;
      overflow-y: auto;
      padding-right: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
    }

    .history-summary {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .summary-pill {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-pill .summary-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .summary-pill .summary-value {
      font-size: 1.4rem;
      font-weight: 700;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      color: var(--text);
    }

    table thead {
      background: rgba(15, 23, 42, 0.05);
    }

    table th,
    table td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    table tbody tr:hover {
      background: rgba(30, 123, 182, 0.08);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(15, 23, 42, 0.45);
      color: var(--text-muted);
      text-decoration: none;
    }

    .tag.success {
      background: rgba(22, 163, 74, 0.22);
      color: #bbf7d0;
    }

    .tag.error {
      background: rgba(248, 113, 113, 0.22);
      color: #fecaca;
    }

    .tag.warning {
      background: rgba(234, 179, 8, 0.2);
      color: #fef08a;
    }

    .tag.neutral {
      background: rgba(148, 163, 184, 0.25);
      color: var(--text-muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .status-pill.success {
      background: rgba(22, 163, 74, 0.18);
      color: #bbf7d0;
    }

    .status-pill.warning {
      background: rgba(234, 179, 8, 0.2);
      color: #fef08a;
    }

    .status-pill.error {
      background: rgba(248, 113, 113, 0.22);
      color: #fecaca;
    }

    .status-pill.neutral {
      background: rgba(148, 163, 184, 0.22);
      color: var(--text-muted);
    }

    .row-subtext {
      display: block;
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .layer-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.75rem;
      margin-top: 12px;
    }

    .layer-badge {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(30, 123, 182, 0.12);
      color: #0f172a;
      font-weight: 600;
    }

    footer {
      padding: 14px 24px 32px;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
    }
      .modal-dialog {
        padding: 18px;
      }

      .result-item,
      .notification-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .result-item-actions,
      .notification-item-actions {
        width: 100%;
        justify-content: flex-start;
      }

    .loader {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--primary);
      font-weight: 600;
    }

    .loader span {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(120deg, #2563eb, #38bdf8);
      animation: pulse 1s infinite ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    a {
      color: inherit;
      text-decoration: underline dashed;
    }

    @media (max-width: 640px) {
      footer {
        padding: 18px 20px 28px;
        font-size: 0.8rem;
      }

      .modal-dialog {
        padding: 18px;
      }

      .result-item,
      .notification-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .result-item-actions,
      .notification-item-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Monitoreo de Floraciones – Lima, Perú</h1>
      <p>Integra Sentinel-2 (NDCI/FAI), contexto regional MODIS (clorofila) y NOAA OISST (temperatura superficial) para analizar blooms costeros en tiempo casi real.</p>
    </div>
    <div class="loader" id="headerLoader" hidden>
      <span></span>
      <span></span>
      <span></span>
      Procesando solicitud...
    </div>
  </header>

  <main>
    <div class="view-switcher">
      <button type="button" class="mode-button active" data-mode="bloom">Floraciones algales</button>
      <button type="button" class="mode-button" data-mode="ecoplan">EcoPlan Urbano</button>
    </div>

    <div class="dashboard-grid">
      <div id="controlColumn">
        <aside class="controls" id="bloomControls">
          <section class="card">
            <h2 class="section-title">Configuración del análisis</h2>
            <form id="controlForm">
              <label>
                Zona (ROI preset)
                <select name="preset" id="presetSelect" required>
                  <option value="" disabled selected>Cargando presets...</option>
                  <option value="costa_metropolitana" data-default-buffer="400">Costa Metropolitana de Lima (mar)</option>
                  <option value="ancon" data-default-buffer="200">Bahía de Ancón (mar)</option>
                  <option value="pantanos" data-default-buffer="-200">Pantanos de Villa (humedal)</option>
                </select>
              </label>

              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  Fecha inicio
                  <input type="date" name="start" id="startDate" required>
                </label>
                <label>
                  Fecha fin
                  <input type="date" name="end" id="endDate" required>
                </label>
              </div>

              <label>
                Porcentaje máximo de nubosidad (%)
                <input type="number" name="cloudPercentage" id="cloudPercentage" min="0" max="100" step="1" value="35">
              </label>

              <div class="section-title">Umbrales (se combinan con adaptativos)</div>
              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  NDCI threshold
                  <input type="number" name="ndciThreshold" id="ndciThreshold" step="0.01" value="0.1">
                </label>
                <label>
                  FAI threshold
                  <input type="number" name="faiThreshold" id="faiThreshold" step="0.001" value="0.005">
                </label>
              </div>

              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  Limpieza (pixeles conectados)
                  <input type="number" name="minPixelsClean" id="minPixelsClean" step="1" min="1" value="12">
                </label>
                <label>
                  Buffer ROI (m)
                  <input type="number" name="buffer" id="buffer" step="50" value="">
                </label>
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="adaptiveThreshold" name="adaptiveThreshold" checked>
                <label for="adaptiveThreshold" style="margin: 0; flex: 1;">Calcular percentiles adaptativos</label>
              </div>

              <div class="section-title">Contexto regional</div>
              <label>
                Buffer regional (km)
                <input type="number" name="contextBufferKm" id="contextBufferKm" step="1" value="5">
              </label>

              <button type="submit" id="runButton">Actualizar análisis</button>
            </form>
          </section>

          <section class="card">
            <h2 class="section-title">Prueba rápida</h2>
            <p style="margin-top: 0; font-size: 0.85rem; color: var(--text-muted);">
              Carga una imagen de referencia (Landsat 8 True Color) para comprobar que la conexión con Earth Engine funciona
              aun sin ejecutar el análisis completo de bloom.
            </p>
            <button type="button" id="quickViewButton">Ver imagen satelital simple</button>
          </section>

          <section class="card">
            <h2 class="section-title">Estado</h2>
            <div class="status-log" id="statusLog"></div>
            <div class="layer-badges" id="layerBadges"></div>
          </section>

          <section class="card" id="thresholdCard">
            <h2 class="section-title">Umbrales efectivos</h2>
            <div><strong>NDCI:</strong> <span id="thresholdNdci">–</span></div>
            <div><strong>FAI:</strong> <span id="thresholdFai">–</span></div>
            <div><strong>FAI (B8A):</strong> <span id="thresholdFaiAlt">–</span></div>
            <small>Los umbrales adaptativos se combinan con los manuales usando el máximo.</small>
          </section>
        </aside>

        <aside class="controls hidden" id="ecoControls">
          <section class="card">
            <h2 class="section-title">Parámetros EcoPlan</h2>
            <form id="ecoForm">
              <label>
                Área de trabajo
                <select name="preset" id="ecoPresetSelect" required>
                  <option value="" disabled selected>Cargando presets...</option>
                  <option value="lima_metropolitana">Lima Metropolitana (urbano)</option>
                  <option value="lima_centro">Lima Centro (urbano)</option>
                  <option value="callao">Callao (urbano)</option>
                </select>
              </label>

              <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px;">
                <label>
                  Fecha inicio
                  <input type="date" name="start" id="ecoStartDate" required>
                </label>
                <label>
                  Fecha fin
                  <input type="date" name="end" id="ecoEndDate" required>
                </label>
              </div>

              <label>
                Porcentaje máximo de nubosidad (%)
                <input type="number" name="cloudPercentage" id="ecoCloudPercentage" min="0" max="100" step="1" value="20">
              </label>

              <label>
                Año de densidad poblacional
                <select name="populationYear" id="ecoPopulationYear">
                  <option value="2020" selected>2020</option>
                  <option value="2015">2015</option>
                  <option value="2010">2010</option>
                </select>
              </label>

              <label>
                Buffer ROI (m)
                <input type="number" name="buffer" id="ecoBuffer" step="50" placeholder="Opcional">
              </label>

              <label>
                Asset de límites (opcional)
                <input type="text" name="districtsAsset" id="ecoDistrictsAsset" placeholder="users/tu_usuario/distritos_lima">
              </label>

              <button type="submit" id="ecoRunButton">Calcular EcoPlan</button>
            </form>
          </section>

          <section class="card">
            <h2 class="section-title">Estado EcoPlan</h2>
            <div class="status-log" id="ecoStatusLog"></div>
          </section>

          <section class="card">
            <h2 class="section-title">Notas rápidas</h2>
            <ul style="margin: 0; padding-left: 18px; color: var(--text-muted); font-size: 0.85rem;">
              <li>NDVI se obtiene de Sentinel-2 SR (calidad armonizada).</li>
              <li>LST proviene de Landsat 8/9 L2 y se expresa en °C.</li>
              <li>Índice de calor combina LST, NDVI y densidad poblacional.</li>
              <li>AOD usa MODIS MOD08_M3 para contaminación atmosférica.</li>
            </ul>
          </section>

          <section class="card">
            <h2 class="section-title">Descargar reporte</h2>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem;">Genera un reporte EcoPlan con los parámetros actuales en distintos formatos listos para compartir.</p>
            <div class="download-buttons">
              <button type="button" class="button-secondary" data-report-format="pdf">Descargar PDF</button>
              <button type="button" class="button-secondary" data-report-format="html">Abrir HTML</button>
              <button type="button" class="button-secondary" data-report-format="csv">Descargar CSV</button>
            </div>
            <small style="color: var(--text-muted); display: block; margin-top: 8px;">Los reportes se generan usando Google Earth Engine y pueden tardar algunos segundos.</small>
          </section>

          <section class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
              <h2 class="section-title" style="margin-bottom: 0;">Historial de reportes</h2>
              <button type="button" class="button-secondary" id="refreshReportRuns" style="padding: 8px 14px; font-size: 0.8rem;">Actualizar</button>
            </div>
            <p style="margin: 8px 0 0; color: var(--text-muted); font-size: 0.8rem;">Últimas ejecuciones del scheduler (máx. 20). Los enlaces aparecen cuando los archivos están disponibles en Cloud Storage.</p>
            <div class="history-filters" aria-label="Filtros historial reportes">
              <label>
                Job
                <select id="reportRunsJobFilter">
                  <option value="">Todos los jobs</option>
                </select>
              </label>
              <label>
                Estado
                <select id="reportRunsStatusFilter">
                  <option value="">Todos los estados</option>
                </select>
              </label>
            </div>
            <div class="history-controls" aria-label="Controles de actualización">
              <label class="history-toggle">
                <input type="checkbox" id="reportRunsAutoRefreshToggle">
                <span>Auto-actualizar</span>
              </label>
              <label style="display: flex; flex-direction: column; gap: 6px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);">
                Frecuencia
                <select id="reportRunsAutoRefreshInterval">
                  <option value="60000">1 minuto</option>
                  <option value="180000">3 minutos</option>
                  <option value="300000" selected>5 minutos</option>
                  <option value="600000">10 minutos</option>
                </select>
              </label>
              <span class="row-subtext" id="reportRunsAutoRefreshStatus">Actualización manual.</span>
            </div>
            <div class="history-summary" id="reportRunsSummary" hidden>
              <div class="summary-pill">
                <span class="summary-label">Total runs</span>
                <span class="summary-value" id="reportRunsTotal">0</span>
                <span class="row-subtext" id="reportRunsRange">–</span>
              </div>
              <div class="summary-pill">
                <span class="summary-label">Éxitos</span>
                <span class="summary-value" id="reportRunsSuccess">0</span>
                <span class="row-subtext" id="reportRunsSuccessPct">0%</span>
              </div>
              <div class="summary-pill">
                <span class="summary-label">Fallos</span>
                <span class="summary-value" id="reportRunsErrors">0</span>
                <span class="row-subtext" id="reportRunsErrorsPct">0%</span>
              </div>
              <div class="summary-pill">
                <span class="summary-label">Último estado</span>
                <span class="summary-value" id="reportRunsLastStatus">–</span>
                <span class="row-subtext" id="reportRunsLastWhen">–</span>
              </div>
            </div>
            <div class="table-wrapper" style="margin-top: 12px; max-height: 240px;">
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Job / Preset</th>
                    <th>Estado</th>
                    <th>Formatos</th>
                    <th>Notifs.</th>
                  </tr>
                </thead>
                <tbody id="reportRunsTableBody"></tbody>
              </table>
            </div>
            <p id="reportRunsEmpty" style="margin: 12px 0 0; font-size: 0.8rem; color: var(--text-muted);" hidden>Usa el botón «Actualizar» para cargar ejecuciones recientes.</p>
          </section>
        </aside>
      </div>

      <section class="map-panel">
        <div id="map"></div>

        <div id="bloomSummarySection">
          <div class="summary-grid">
            <div class="card summary-card">
              <h3>Área máxima detectada</h3>
              <div class="value" id="areaMax">–</div>
              <small>km² durante el periodo analizado</small>
            </div>
            <div class="card summary-card">
              <h3>Bloom más reciente</h3>
              <div class="value" id="areaLast">–</div>
              <small>km² registrados en la última escena libre de nubes</small>
            </div>
            <div class="card summary-card">
              <h3>Clorofila media</h3>
              <div class="value" id="chlorMean">–</div>
              <small>mg/m³ promedio regional (MODIS Aqua)</small>
            </div>
            <div class="card summary-card">
              <h3>SST media</h3>
              <div class="value" id="sstMean">–</div>
              <small>°C promedio regional (NOAA OISST)</small>
            </div>
          </div>

          <div class="charts">
            <div class="card">
              <h3>Área con bloom (km²)</h3>
              <canvas id="areaChart"></canvas>
            </div>
            <div class="card">
              <h3>Clorofila-a regional (mg/m³)</h3>
              <canvas id="chlorChart"></canvas>
            </div>
            <div class="card">
              <h3>Temperatura superficial del mar (°C)</h3>
              <canvas id="sstChart"></canvas>
            </div>
          </div>
        </div>

        <div id="ecoSummarySection" class="hidden">
          <div class="summary-grid">
            <div class="card summary-card">
              <h3>NDVI medio</h3>
              <div class="value" id="ecoNdviMean">–</div>
              <small>Rango: <span id="ecoNdviRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>LST media</h3>
              <div class="value" id="ecoLstMean">–</div>
              <small>Rango: <span id="ecoLstRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Índice de calor</h3>
              <div class="value" id="ecoHeatMean">–</div>
              <small>Rango: <span id="ecoHeatRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>AOD media</h3>
              <div class="value" id="ecoAodMean">–</div>
              <small>Rango: <span id="ecoAodRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Calidad del aire</h3>
              <div class="value" id="ecoAirQualityMean">–</div>
              <small>Índice (0-1). Rango: <span id="ecoAirQualityRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>NO₂ promedio</h3>
              <div class="value" id="ecoNo2Mean">–</div>
              <small>µmol·m⁻² troposféricos</small>
            </div>
            <div class="card summary-card">
              <h3>PM₂.₅ promedio</h3>
              <div class="value" id="ecoPm25Mean">–</div>
              <small>µg·m⁻³ estimados</small>
            </div>
            <div class="card summary-card">
              <h3>NDWI medio</h3>
              <div class="value" id="ecoNdwiMean">–</div>
              <small>Rango: <span id="ecoNdwiRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Impermeabilización</h3>
              <div class="value" id="ecoImperviousMean">–</div>
              <small>Rango: <span id="ecoImperviousRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Riesgo hídrico</h3>
              <div class="value" id="ecoWaterRiskMean">–</div>
              <small>Rango: <span id="ecoWaterRiskRange">–</span></small>
            </div>
            <div class="card summary-card">
              <h3>Áreas verdes per cápita</h3>
              <div class="value" id="ecoGreenPerCapitaMean">–</div>
              <small>Rango: <span id="ecoGreenPerCapitaRange">–</span> | Total: <span id="ecoGreenAreaTotal">–</span> ha</small>
            </div>
            <div class="card summary-card">
              <h3>Densidad poblacional</h3>
              <div class="value" id="ecoPopulationMean">–</div>
              <small>Máx.: <span id="ecoPopulationMax">–</span> | Total: <span id="ecoPopulationTotal">–</span> hab</small>
            </div>
            <div class="card summary-card">
              <h3>Déficit de áreas verdes</h3>
              <div class="value" id="ecoGreenDeficitRatio">–</div>
              <small>Población por debajo de 9 m²/hab</small>
            </div>
          </div>

          <div class="charts">
            <div class="card">
              <h3>NDVI (promedio)</h3>
              <canvas id="ecoNdviChart"></canvas>
            </div>
            <div class="card">
              <h3>LST (°C)</h3>
              <canvas id="ecoLstChart"></canvas>
            </div>
            <div class="card">
              <h3>Aerosol Optical Depth</h3>
              <canvas id="ecoAodChart"></canvas>
            </div>
            <div class="card">
              <h3>NO₂ troposférico (µmol·m⁻²)</h3>
              <canvas id="ecoNo2Chart"></canvas>
            </div>
            <div class="card">
              <h3>PM₂.₅ (µg·m⁻³)</h3>
              <canvas id="ecoPm25Chart"></canvas>
            </div>
          </div>

          <div class="card" id="ecoBoundaryCard" hidden>
            <h3>Indicadores por distrito</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Distrito</th>
                    <th>NDVI medio</th>
                    <th>LST (°C)</th>
                    <th>Índice calor</th>
                    <th>Densidad</th>
                  </tr>
                </thead>
                <tbody id="ecoBoundaryBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    Construido con Google Earth Engine, Sentinel-2 SR, MODIS Aqua (L3SMI) y NOAA OISST V2. Ajusta parámetros por zona y valida con datos in situ.
  </footer>

  <div id="reportRunDetailsOverlay" class="modal-overlay" hidden tabindex="-1" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="reportRunDetailsTitle">
      <button type="button" class="modal-close-button" id="closeReportRunDetails" aria-label="Cerrar detalles">×</button>
      <div class="modal-header">
        <div>
          <div class="modal-subtitle" id="reportRunDetailsJob">Job</div>
          <h3 class="modal-title" id="reportRunDetailsTitle">Detalle de ejecución</h3>
        </div>
        <span class="status-pill neutral" id="reportRunDetailsStatus">Estado</span>
      </div>
      <div class="modal-body" id="reportRunDetailsBody"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-vmI1Qy1SgdWzxjaUoil58x2oylZMhUlCT3VkOITkkpFmS6r30YIOCwVDDDeWGPA7eGRIDcH+xM3aMc1hQE8fkw==" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script>
    const BLOOM_PRESETS_LOCAL = [
      {
        id: 'costa_metropolitana',
        label: 'Costa Metropolitana de Lima',
        type: 'mar',
        defaultBuffer: 400
      },
      {
        id: 'ancon',
        label: 'Bahía de Ancón',
        type: 'mar',
        defaultBuffer: 200
      },
      {
        id: 'pantanos',
        label: 'Pantanos de Villa',
        type: 'humedal',
        defaultBuffer: -200
      }
    ];

    const ECO_PRESETS_LOCAL = [
      {
        id: 'lima_metropolitana',
        label: 'Lima Metropolitana',
        type: 'urbano',
        defaultBuffer: 0
      },
      {
        id: 'lima_centro',
        label: 'Lima Centro',
        type: 'urbano',
        defaultBuffer: 0
      },
      {
        id: 'callao',
        label: 'Callao',
        type: 'urbano',
        defaultBuffer: 0
      }
    ];

    const baseLayers = {};
    let overlayLayers = {};
    let layerControl;
    let map;
    let areaChartInstance;
    let chlorChartInstance;
    let sstChartInstance;
  let ecoNdviChartInstance;
  let ecoLstChartInstance;
  let ecoAodChartInstance;
  let ecoNo2ChartInstance;
  let ecoPm25ChartInstance;
    let roiLayer;
    let contextLayer;
    let currentMode = 'bloom';
    let bloomInitialized = false;
    let ecoInitialized = false;
  let lastBloomResult = null;
  let lastEcoResult = null;

    const statusLogs = {
      bloom: document.getElementById('statusLog'),
      ecoplan: document.getElementById('ecoStatusLog')
    };
    const layerBadgesContainer = document.getElementById('layerBadges');
    const bloomRunButton = document.getElementById('runButton');
    const ecoRunButton = document.getElementById('ecoRunButton');
    const quickViewButton = document.getElementById('quickViewButton');
    const headerLoader = document.getElementById('headerLoader');
    const modeButtons = document.querySelectorAll('.mode-button');
    const bloomControls = document.getElementById('bloomControls');
    const ecoControls = document.getElementById('ecoControls');
    const bloomSummarySection = document.getElementById('bloomSummarySection');
    const ecoSummarySection = document.getElementById('ecoSummarySection');

    const ecoSummaryEls = {
      ndviMean: document.getElementById('ecoNdviMean'),
      ndviRange: document.getElementById('ecoNdviRange'),
      lstMean: document.getElementById('ecoLstMean'),
      lstRange: document.getElementById('ecoLstRange'),
      heatMean: document.getElementById('ecoHeatMean'),
      heatRange: document.getElementById('ecoHeatRange'),
      airQualityMean: document.getElementById('ecoAirQualityMean'),
      airQualityRange: document.getElementById('ecoAirQualityRange'),
      aodMean: document.getElementById('ecoAodMean'),
      aodRange: document.getElementById('ecoAodRange'),
      ndwiMean: document.getElementById('ecoNdwiMean'),
      ndwiRange: document.getElementById('ecoNdwiRange'),
      imperviousMean: document.getElementById('ecoImperviousMean'),
      imperviousRange: document.getElementById('ecoImperviousRange'),
      waterRiskMean: document.getElementById('ecoWaterRiskMean'),
      waterRiskRange: document.getElementById('ecoWaterRiskRange'),
      greenPerCapitaMean: document.getElementById('ecoGreenPerCapitaMean'),
      greenPerCapitaRange: document.getElementById('ecoGreenPerCapitaRange'),
      greenAreaTotal: document.getElementById('ecoGreenAreaTotal'),
      greenDeficitRatio: document.getElementById('ecoGreenDeficitRatio'),
      no2Mean: document.getElementById('ecoNo2Mean'),
      pm25Mean: document.getElementById('ecoPm25Mean'),
      populationMean: document.getElementById('ecoPopulationMean'),
      populationMax: document.getElementById('ecoPopulationMax'),
      populationTotal: document.getElementById('ecoPopulationTotal'),
      boundaryCard: document.getElementById('ecoBoundaryCard'),
      boundaryBody: document.getElementById('ecoBoundaryBody')
    };

  const ecoReportButtons = Array.from(document.querySelectorAll('[data-report-format]'));
  const reportRunsTableBody = document.getElementById('reportRunsTableBody');
  const reportRunsEmptyMessage = document.getElementById('reportRunsEmpty');
  const refreshReportRunsButton = document.getElementById('refreshReportRuns');
  const reportRunsJobFilter = document.getElementById('reportRunsJobFilter');
  const reportRunsStatusFilter = document.getElementById('reportRunsStatusFilter');
  const reportRunsAutoRefreshToggle = document.getElementById('reportRunsAutoRefreshToggle');
  const reportRunsAutoRefreshIntervalSelect = document.getElementById('reportRunsAutoRefreshInterval');
  const reportRunsAutoRefreshStatusEl = document.getElementById('reportRunsAutoRefreshStatus');
  const reportRunsSummary = document.getElementById('reportRunsSummary');
  const reportRunsTotalEl = document.getElementById('reportRunsTotal');
  const reportRunsRangeEl = document.getElementById('reportRunsRange');
  const reportRunsSuccessEl = document.getElementById('reportRunsSuccess');
  const reportRunsSuccessPctEl = document.getElementById('reportRunsSuccessPct');
  const reportRunsErrorsEl = document.getElementById('reportRunsErrors');
  const reportRunsErrorsPctEl = document.getElementById('reportRunsErrorsPct');
  const reportRunsLastStatusEl = document.getElementById('reportRunsLastStatus');
  const reportRunsLastWhenEl = document.getElementById('reportRunsLastWhen');
  const reportRunDetailsOverlay = document.getElementById('reportRunDetailsOverlay');
  const reportRunDetailsBody = document.getElementById('reportRunDetailsBody');
  const reportRunDetailsTitle = document.getElementById('reportRunDetailsTitle');
  const reportRunDetailsJob = document.getElementById('reportRunDetailsJob');
  const reportRunDetailsStatus = document.getElementById('reportRunDetailsStatus');
  const closeReportRunDetailsButton = document.getElementById('closeReportRunDetails');
  const refreshReportRunsDefaultText = refreshReportRunsButton ? refreshReportRunsButton.textContent : '';
  const defaultReportRunsEmptyText = reportRunsEmptyMessage ? reportRunsEmptyMessage.textContent : '';
  let reportRunsLoaded = false;
  let reportRunsLoading = false;
  let reportRunsFetchQueued = false;
  const REPORT_RUNS_LIMIT = 20;
  let reportRunsCurrentLimit = REPORT_RUNS_LIMIT;
  const reportRunsFilterState = { jobId: '', status: '' };
  const reportRunsJobLabels = new Map();
  const reportRunsStatusSet = new Set();
  let reportRunsLastResponse = [];
  const MODE_STORAGE_KEY = 'gee-dashboard-mode';
  const REPORT_RUNS_AUTO_REFRESH_STORAGE_KEY = 'ecoplan-report-runs-auto-refresh';
  const DEFAULT_AUTO_REFRESH_INTERVAL_MS = 300000;
  let reportRunsAutoRefreshEnabled = false;
  let reportRunsAutoRefreshIntervalMs = DEFAULT_AUTO_REFRESH_INTERVAL_MS;
  let reportRunsAutoRefreshTimer = null;
  let reportRunsLastUpdatedAt = null;
  let reportRunDetailsActiveId = null;

    function varColor(name) {
      return getComputedStyle(document.body).getPropertyValue(name).trim();
    }

    function colorWithAlpha(color, alpha = 0.2) {
      if (!color) return `rgba(30, 123, 182, ${alpha})`;
      if (color.startsWith('rgba')) {
        const parts = color.split(',');
        parts[3] = ` ${alpha})`;
        return parts.join(',');
      }
      if (color.startsWith('rgb')) {
        return color.replace('rgb', 'rgba').replace(')', `, ${alpha})`);
      }
      if (color.startsWith('#')) {
        const hex = color.replace('#', '');
        const chunk = hex.length === 3 ? hex.split('').map((c) => c + c).join('') : hex;
        const intVal = parseInt(chunk, 16);
        const r = (intVal >> 16) & 255;
        const g = (intVal >> 8) & 255;
        const b = intVal & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      return `rgba(30, 123, 182, ${alpha})`;
    }

    function getFeatureArray(collectionOrArray) {
      if (!collectionOrArray) return [];
      if (Array.isArray(collectionOrArray)) return collectionOrArray;
      if (Array.isArray(collectionOrArray.features)) return collectionOrArray.features;
      return [];
    }

    function averageNumeric(values) {
      const valid = values.filter((value) => typeof value === 'number' && !Number.isNaN(value));
      if (!valid.length) return null;
      return valid.reduce((sum, value) => sum + value, 0) / valid.length;
    }

    function logStatus(message, type = 'info', mode = currentMode) {
      const time = new Date().toLocaleTimeString('es-PE', { hour12: false });
      const line = document.createElement('div');
      const colors = {
        info: varColor('--text-muted'),
        success: varColor('--success'),
        warning: varColor('--warning'),
        error: varColor('--error')
      };
      line.style.color = colors[type] || colors.info;
      line.textContent = `[${time}] ${message}`;
      const container = statusLogs[mode];
      if (container) {
        container.prepend(line);
      }
    }

    function setLoading(isLoading, mode = currentMode) {
      if (mode === 'bloom') {
        if (bloomRunButton) bloomRunButton.disabled = isLoading;
      } else if (mode === 'ecoplan') {
        if (ecoRunButton) ecoRunButton.disabled = isLoading;
      }
      headerLoader.hidden = !isLoading;
      if (isLoading) {
        logStatus('Procesando solicitud...', 'info', mode);
      }
    }

    function formatDateTimeLabel(value) {
      if (!value) {
        return '—';
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return String(value);
      }
      try {
        return date.toLocaleString('es-PE', {
          dateStyle: 'medium',
          timeStyle: 'short'
        });
      } catch (error) {
        return date.toISOString();
      }
    }

    function formatDurationLabel(durationMs) {
      if (!Number.isFinite(durationMs) || durationMs <= 0) {
        return null;
      }
      const totalSeconds = Math.round(durationMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      const parts = [];
      if (hours) parts.push(`${hours}h`);
      if (minutes) parts.push(`${minutes}m`);
      if (seconds || parts.length === 0) parts.push(`${seconds}s`);
      return parts.join(' ');
    }

    function getStatusDescriptor(status) {
      const normalized = typeof status === 'string' ? status.toLowerCase() : '';
      switch (normalized) {
        case 'success':
          return { label: 'Completado', variant: 'success' };
        case 'partial':
          return { label: 'Parcial', variant: 'warning' };
        case 'error':
          return { label: 'Error', variant: 'error' };
        case 'running':
          return { label: 'En progreso', variant: 'neutral' };
        case 'queued':
          return { label: 'En cola', variant: 'neutral' };
        default:
          return { label: status ? status.toString() : 'Desconocido', variant: 'neutral' };
      }
    }

    function mapTagVariant(status) {
      const normalized = typeof status === 'string' ? status.toLowerCase() : '';
      if (normalized === 'success' || normalized === 'sent' || normalized === 'ok') {
        return 'success';
      }
      if (normalized === 'error' || normalized === 'failed') {
        return 'error';
      }
      if (normalized === 'partial' || normalized === 'warning' || normalized === 'pending') {
        return 'warning';
      }
      return 'neutral';
    }

    function renderReportRunsFilters() {
      if (reportRunsJobFilter) {
        const selectedJob = reportRunsFilterState.jobId || '';
        const jobEntries = Array.from(reportRunsJobLabels.entries())
          .map(([jobId, label]) => ({ jobId, label: label || jobId }))
          .sort((a, b) => a.label.localeCompare(b.label, 'es-PE', { sensitivity: 'base' }));

        reportRunsJobFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Todos los jobs';
        reportRunsJobFilter.appendChild(allOption);

        let hasCurrentJob = selectedJob === '';
        jobEntries.forEach(({ jobId, label }) => {
          const option = document.createElement('option');
          option.value = jobId;
          option.textContent = label;
          reportRunsJobFilter.appendChild(option);
          if (jobId === selectedJob) {
            hasCurrentJob = true;
          }
        });

        if (!hasCurrentJob && selectedJob) {
          const fallbackOption = document.createElement('option');
          fallbackOption.value = selectedJob;
          fallbackOption.textContent = selectedJob;
          fallbackOption.hidden = true;
          reportRunsJobFilter.appendChild(fallbackOption);
        }

        reportRunsJobFilter.value = selectedJob;
      }

      if (reportRunsStatusFilter) {
        const selectedStatus = reportRunsFilterState.status || '';
        const statuses = Array.from(reportRunsStatusSet)
          .filter(Boolean)
          .sort((a, b) => a.localeCompare(b, 'es-PE', { sensitivity: 'base' }));

        reportRunsStatusFilter.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Todos los estados';
        reportRunsStatusFilter.appendChild(allOption);

        let hasCurrentStatus = selectedStatus === '';
        statuses.forEach((statusValue) => {
          const descriptor = getStatusDescriptor(statusValue);
          const option = document.createElement('option');
          option.value = statusValue;
          option.textContent = descriptor.label || statusValue;
          reportRunsStatusFilter.appendChild(option);
          if (statusValue === selectedStatus) {
            hasCurrentStatus = true;
          }
        });

        if (!hasCurrentStatus && selectedStatus) {
          const descriptor = getStatusDescriptor(selectedStatus);
          const fallbackOption = document.createElement('option');
          fallbackOption.value = selectedStatus;
          fallbackOption.textContent = descriptor.label || selectedStatus;
          fallbackOption.hidden = true;
          reportRunsStatusFilter.appendChild(fallbackOption);
        }

        reportRunsStatusFilter.value = selectedStatus;
      }
    }

    function updateReportRunsFilterOptions(runs) {
      if (!Array.isArray(runs)) {
        renderReportRunsFilters();
        return;
      }

      runs.forEach((run) => {
        if (run?.jobId) {
          const presetLabel = run?.presetName || run?.presetId;
          const displayLabel = presetLabel ? `${run.jobId} · ${presetLabel}` : run.jobId;
          const existingLabel = reportRunsJobLabels.get(run.jobId);
          if (!existingLabel || existingLabel === run.jobId) {
            reportRunsJobLabels.set(run.jobId, displayLabel);
          }
        }
        if (run?.status) {
          reportRunsStatusSet.add(run.status);
        }
      });

      renderReportRunsFilters();
    }

    function formatBytes(bytes) {
      const value = Number(bytes);
      if (!Number.isFinite(value) || value < 0) {
        return null;
      }
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = value;
      let index = 0;
      while (size >= 1024 && index < units.length - 1) {
        size /= 1024;
        index += 1;
      }
      const decimals = size < 10 && index > 0 ? 1 : 0;
      return `${size.toFixed(decimals)} ${units[index]}`;
    }

    function humanizeKey(key) {
      if (!key) {
        return '';
      }
      const withSpaces = key
        .toString()
        .replace(/[_-]+/g, ' ')
        .replace(/([a-z\d])([A-Z])/g, '$1 $2')
        .replace(/\s{2,}/g, ' ')
        .trim();
      return withSpaces.split(' ').map((word) => {
        if (!word.length) return word;
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
      }).join(' ');
    }

    function buildKeyValueGrid(entries = []) {
      const container = document.createElement('div');
      container.className = 'key-value-grid';
      entries.forEach(({ label, value }) => {
        if (value === undefined || value === null || value === '') {
          return;
        }
        const wrapper = document.createElement('div');
        const labelSpan = document.createElement('span');
        labelSpan.className = 'key-label';
        labelSpan.textContent = label;
        const valueSpan = document.createElement('span');
        valueSpan.className = 'key-value';
        valueSpan.textContent = value;
        wrapper.append(labelSpan, valueSpan);
        container.appendChild(wrapper);
      });
      return container;
    }

    function createEmptyMessage(text) {
      const paragraph = document.createElement('p');
      paragraph.className = 'row-subtext';
      paragraph.style.margin = '0';
      paragraph.textContent = text;
      return paragraph;
    }

    function createResultsList(results) {
      if (!Array.isArray(results) || !results.length) {
        return null;
      }

      const list = document.createElement('div');
      list.className = 'results-list';

      results.forEach((result) => {
        const item = document.createElement('div');
        item.className = 'result-item';

        const main = document.createElement('div');
        main.className = 'result-item-main';
        const title = document.createElement('div');
        title.style.fontWeight = '600';
  title.textContent = (result?.format || 'Formato').toString().toUpperCase();
        main.appendChild(title);

        const metaParts = [];
        const sizeLabel = formatBytes(result?.bytes);
        if (sizeLabel) {
          metaParts.push(sizeLabel);
        }
        if (result?.gcs?.bucket && result?.gcs?.path) {
          metaParts.push(`${result.gcs.bucket}/${result.gcs.path}`);
        }
        if (result?.error) {
          metaParts.push(`Error: ${result.error}`);
        }
        if (metaParts.length) {
          const subtitle = document.createElement('span');
          subtitle.className = 'row-subtext';
          subtitle.textContent = metaParts.join(' · ');
          main.appendChild(subtitle);
        }

        item.appendChild(main);

        const actions = document.createElement('div');
        actions.className = 'result-item-actions';
        const descriptor = getStatusDescriptor(result?.status);
        const statusTag = createTagElement(descriptor.label, mapTagVariant(result?.status));
        actions.appendChild(statusTag);
        if (result?.gcs?.publicUrl) {
          const link = document.createElement('a');
          link.href = result.gcs.publicUrl;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'Abrir';
          actions.appendChild(link);
        }
        item.appendChild(actions);

        list.appendChild(item);
      });

      return list;
    }

    function createNotificationsList(notifications) {
      if (!notifications || typeof notifications !== 'object' || !Object.keys(notifications).length) {
        return null;
      }

      const list = document.createElement('div');
      list.className = 'notifications-list';

      Object.entries(notifications).forEach(([channel, info]) => {
        const item = document.createElement('div');
        item.className = 'notification-item';

        const main = document.createElement('div');
        main.className = 'notification-item-main';
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.textContent = channel === 'email' ? 'Email' : channel === 'slack' ? 'Slack' : humanizeKey(channel);
        main.appendChild(title);

        const details = [];
        if (Array.isArray(info?.recipients) && info.recipients.length) {
          details.push(`Destinatarios: ${info.recipients.join(', ')}`);
        }
        if (info?.error) {
          details.push(`Error: ${info.error}`);
        } else if (info?.reason) {
          details.push(`Motivo: ${info.reason}`);
        }
        if (details.length) {
          const subtitle = document.createElement('span');
          subtitle.className = 'row-subtext';
          subtitle.textContent = details.join(' · ');
          main.appendChild(subtitle);
        }

        item.appendChild(main);

        const actions = document.createElement('div');
        actions.className = 'notification-item-actions';
        const statusTag = createTagElement(translateNotificationStatus(info?.status), mapTagVariant(info?.status));
        actions.appendChild(statusTag);
        item.appendChild(actions);

        list.appendChild(item);
      });

      return list;
    }

    function formatPercentage(part, total) {
      if (!Number.isFinite(part) || !Number.isFinite(total) || total <= 0) {
        return '0%';
      }
      const percentage = (part / total) * 100;
      return `${percentage.toFixed(percentage >= 99 || percentage === 0 ? 0 : 1)}%`;
    }

    function parseAutoRefreshInterval(value) {
      const parsed = Number(value);
      if (!Number.isFinite(parsed)) {
        return DEFAULT_AUTO_REFRESH_INTERVAL_MS;
      }
      return Math.min(Math.max(parsed, 60000), 3600000);
    }

    function loadModePreference() {
      if (typeof window === 'undefined' || !window.localStorage) {
        return null;
      }
      try {
        const stored = window.localStorage.getItem(MODE_STORAGE_KEY);
        if (stored === 'bloom' || stored === 'ecoplan') {
          return stored;
        }
      } catch (error) {
        console.warn('No se pudo cargar el modo preferido:', error);
      }
      return null;
    }

    function persistModePreference(mode) {
      if (typeof window === 'undefined' || !window.localStorage) {
        return;
      }
      try {
        window.localStorage.setItem(MODE_STORAGE_KEY, mode);
      } catch (error) {
        console.warn('No se pudo guardar el modo preferido:', error);
      }
    }

    function loadReportRunsAutoRefreshSettings() {
      if (typeof window === 'undefined' || !window.localStorage) {
        return;
      }
      try {
        const raw = window.localStorage.getItem(REPORT_RUNS_AUTO_REFRESH_STORAGE_KEY);
        if (!raw) {
          return;
        }
        const parsed = JSON.parse(raw);
        if (typeof parsed === 'object' && parsed) {
          if (typeof parsed.enabled === 'boolean') {
            reportRunsAutoRefreshEnabled = parsed.enabled;
          }
          if (parsed.interval !== undefined) {
            reportRunsAutoRefreshIntervalMs = parseAutoRefreshInterval(parsed.interval);
          }
        }
      } catch (error) {
        console.warn('No se pudo cargar la configuración de auto-actualización:', error);
      }
    }

    function persistReportRunsAutoRefreshSettings() {
      if (typeof window === 'undefined' || !window.localStorage) {
        return;
      }
      try {
        window.localStorage.setItem(REPORT_RUNS_AUTO_REFRESH_STORAGE_KEY, JSON.stringify({
          enabled: reportRunsAutoRefreshEnabled,
          interval: reportRunsAutoRefreshIntervalMs
        }));
      } catch (error) {
        console.warn('No se pudo guardar la configuración de auto-actualización:', error);
      }
    }

    function applyReportRunsAutoRefreshDomState() {
      if (reportRunsAutoRefreshToggle) {
        reportRunsAutoRefreshToggle.checked = reportRunsAutoRefreshEnabled;
      }
      if (reportRunsAutoRefreshIntervalSelect) {
        reportRunsAutoRefreshIntervalSelect.value = reportRunsAutoRefreshIntervalMs.toString();
      }
      updateReportRunsAutoRefreshStatusLabel();
    }

    function updateReportRunsAutoRefreshStatusLabel() {
      if (!reportRunsAutoRefreshStatusEl) {
        return;
      }
      const documentHidden = typeof document !== 'undefined' && document.hidden;
      const activeNow = reportRunsAutoRefreshEnabled && currentMode === 'ecoplan' && !documentHidden;
      let modeLabel = 'Actualización manual';
      if (reportRunsAutoRefreshEnabled) {
        modeLabel = activeNow ? 'Auto-actualización activa' : 'Auto-actualización pausada';
        if (!activeNow && currentMode !== 'ecoplan') {
          modeLabel = 'Auto-actualización en espera (modo Bloom)';
        } else if (!activeNow && documentHidden) {
          modeLabel = 'Auto-actualización pausada (pestaña inactiva)';
        }
      }

      if (!reportRunsLastUpdatedAt) {
        reportRunsAutoRefreshStatusEl.textContent = `${modeLabel}.`;
        return;
      }

      reportRunsAutoRefreshStatusEl.textContent = `${modeLabel}. Última actualización: ${formatDateTimeLabel(reportRunsLastUpdatedAt)}`;
    }

    function clearReportRunsAutoRefreshTimer() {
      if (reportRunsAutoRefreshTimer) {
        clearInterval(reportRunsAutoRefreshTimer);
        reportRunsAutoRefreshTimer = null;
      }
      updateReportRunsAutoRefreshStatusLabel();
    }

    function scheduleReportRunsAutoRefresh({ fetchImmediately = false } = {}) {
      clearReportRunsAutoRefreshTimer();

      if (!reportRunsAutoRefreshEnabled || currentMode !== 'ecoplan') {
        return;
      }

      if (typeof document !== 'undefined' && document.hidden) {
        return;
      }

      reportRunsAutoRefreshTimer = setInterval(() => {
        fetchReportRuns({ announce: false });
      }, reportRunsAutoRefreshIntervalMs);

      if (fetchImmediately) {
        fetchReportRuns({ announce: false });
      }

      updateReportRunsAutoRefreshStatusLabel();
    }

    function handleVisibilityChange() {
      if (!reportRunsAutoRefreshEnabled) {
        return;
      }
      if (document.hidden) {
        clearReportRunsAutoRefreshTimer();
      } else {
        scheduleReportRunsAutoRefresh();
      }
      updateReportRunsAutoRefreshStatusLabel();
    }

  function updateReportRunsSummary(runs = []) {
      if (!reportRunsSummary) {
        return;
      }

      if (!Array.isArray(runs) || !runs.length) {
        reportRunsSummary.hidden = true;
        if (reportRunsTotalEl) reportRunsTotalEl.textContent = '0';
        if (reportRunsRangeEl) reportRunsRangeEl.textContent = '–';
        if (reportRunsSuccessEl) reportRunsSuccessEl.textContent = '0';
        if (reportRunsSuccessPctEl) reportRunsSuccessPctEl.textContent = '0%';
        if (reportRunsErrorsEl) reportRunsErrorsEl.textContent = '0';
        if (reportRunsErrorsPctEl) reportRunsErrorsPctEl.textContent = '0%';
        if (reportRunsLastStatusEl) reportRunsLastStatusEl.textContent = '–';
        if (reportRunsLastWhenEl) reportRunsLastWhenEl.textContent = '–';
        return;
      }

      const total = runs.length;
      const successCount = runs.filter((run) => run?.status === 'success').length;
      const errorCount = runs.filter((run) => run?.status === 'error').length;

      if (reportRunsTotalEl) {
        reportRunsTotalEl.textContent = String(total);
      }

      if (reportRunsSuccessEl) {
        reportRunsSuccessEl.textContent = String(successCount);
      }
      if (reportRunsSuccessPctEl) {
        reportRunsSuccessPctEl.textContent = formatPercentage(successCount, total);
      }

      if (reportRunsErrorsEl) {
        reportRunsErrorsEl.textContent = String(errorCount);
      }
      if (reportRunsErrorsPctEl) {
        reportRunsErrorsPctEl.textContent = formatPercentage(errorCount, total);
      }

      const latest = runs[0];
      const earliest = runs[runs.length - 1];

      if (reportRunsRangeEl) {
        const startLabel = earliest ? formatDateTimeLabel(earliest.generatedAt || earliest.completedAt || earliest.startedAt) : null;
        const endLabel = latest ? formatDateTimeLabel(latest.generatedAt || latest.completedAt || latest.startedAt) : null;
        if (startLabel && endLabel && startLabel !== endLabel) {
          reportRunsRangeEl.textContent = `${startLabel} → ${endLabel}`;
        } else {
          reportRunsRangeEl.textContent = endLabel || startLabel || '–';
        }
      }

      if (reportRunsLastStatusEl || reportRunsLastWhenEl) {
        const descriptor = getStatusDescriptor(latest?.status);
        if (reportRunsLastStatusEl) {
          reportRunsLastStatusEl.textContent = descriptor.label;
        }
        if (reportRunsLastWhenEl) {
          const lastInstant = latest?.generatedAt || latest?.completedAt || latest?.startedAt;
          reportRunsLastWhenEl.textContent = lastInstant ? formatDateTimeLabel(lastInstant) : '–';
        }
      }

      reportRunsSummary.hidden = false;
    }

    function createMetricsSection(metrics) {
      if (!metrics || typeof metrics !== 'object') {
        return null;
      }
      const entries = Object.entries(metrics).filter(([, value]) => value !== null && value !== undefined);
      if (!entries.length) {
        return null;
      }

      const section = document.createElement('div');
      section.className = 'modal-section';
      const heading = document.createElement('h4');
      heading.textContent = 'Indicadores clave';
      section.appendChild(heading);

      const grid = document.createElement('div');
      grid.className = 'metrics-grid';

      entries.forEach(([key, value]) => {
        const card = document.createElement('div');
        card.className = 'metrics-card';
        const title = document.createElement('h5');
        title.textContent = humanizeKey(key);
        const metricValue = document.createElement('div');
        metricValue.className = 'metric-value';
        if (typeof value === 'number' && Number.isFinite(value)) {
          const decimals = Math.abs(value) >= 100 ? 0 : 2;
          metricValue.textContent = formatNumber(value, decimals);
        } else {
          metricValue.textContent = String(value);
        }
        card.append(title, metricValue);
        grid.appendChild(card);
      });

      section.appendChild(grid);
      return section;
    }

    function createJsonBlock(data) {
      const pre = document.createElement('pre');
      pre.className = 'json-block';
      try {
        if (typeof data === 'string') {
          pre.textContent = data;
        } else {
          pre.textContent = JSON.stringify(data, null, 2);
        }
      } catch (error) {
        pre.textContent = String(data);
      }
      return pre;
    }

    function closeReportRunDetails({ silent = false } = {}) {
      if (!reportRunDetailsOverlay) {
        return;
      }
      reportRunDetailsActiveId = null;
      reportRunDetailsOverlay.hidden = true;
      reportRunDetailsOverlay.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('modal-open');
      if (reportRunDetailsBody) {
        reportRunDetailsBody.innerHTML = '';
      }
      if (!silent) {
        logStatus('Detalle cerrado.', 'info', 'ecoplan');
      }
    }

    function openReportRunDetails(run) {
      if (!run || !reportRunDetailsOverlay || !reportRunDetailsBody) {
        logStatus('No hay detalles disponibles para esta ejecución.', 'warning', 'ecoplan');
        return;
      }

      reportRunDetailsActiveId = run.id || null;

      const jobParts = [];
      if (run.jobId) {
        jobParts.push(run.jobId);
      }
      if (run.presetName) {
        jobParts.push(run.presetName);
      } else if (run.presetId) {
        jobParts.push(run.presetId);
      }
      if (reportRunDetailsJob) {
        reportRunDetailsJob.textContent = jobParts.length ? jobParts.join(' · ') : 'Ejecución EcoPlan';
      }

      if (reportRunDetailsTitle) {
        const presetLabel = run.presetName || run.presetId || 'Detalle de ejecución';
        reportRunDetailsTitle.textContent = `EcoPlan · ${presetLabel}`;
      }

      if (reportRunDetailsStatus) {
        const descriptor = getStatusDescriptor(run.status);
        reportRunDetailsStatus.textContent = descriptor.label;
        reportRunDetailsStatus.className = `status-pill ${descriptor.variant}`;
      }

      const sections = [];
      const timelineItems = [];
      if (run.startedAt) {
        timelineItems.push({ label: 'Inicio', value: formatDateTimeLabel(run.startedAt) });
      }
      if (run.completedAt) {
        timelineItems.push({ label: 'Fin', value: formatDateTimeLabel(run.completedAt) });
      }
      if (run.generatedAt) {
        timelineItems.push({ label: 'Generado', value: formatDateTimeLabel(run.generatedAt) });
      }
      const durationLabel = formatDurationLabel(run.durationMs);
      if (durationLabel) {
        timelineItems.push({ label: 'Duración', value: durationLabel });
      }
      if (run.trigger) {
        timelineItems.push({ label: 'Disparador', value: humanizeKey(run.trigger) });
      }
      if (run.hash) {
        timelineItems.push({ label: 'Hash', value: run.hash });
      }
      if (run.id) {
        timelineItems.push({ label: 'ID interno', value: run.id });
      }

      if (timelineItems.length) {
        const timelineSection = document.createElement('div');
        timelineSection.className = 'modal-section';
        const timelineHeading = document.createElement('h4');
        timelineHeading.textContent = 'Cronología';
        timelineSection.appendChild(timelineHeading);
        timelineSection.appendChild(buildKeyValueGrid(timelineItems));
        sections.push(timelineSection);
      }

      const resultsSection = document.createElement('div');
      resultsSection.className = 'modal-section';
      const resultsHeading = document.createElement('h4');
      resultsHeading.textContent = 'Archivos generados';
      resultsSection.appendChild(resultsHeading);
      const resultsList = createResultsList(run.results);
      if (resultsList) {
        resultsSection.appendChild(resultsList);
      } else {
        const message = run.status === 'running'
          ? 'Los formatos aún se están generando.'
          : 'No se registraron formatos para esta ejecución.';
        resultsSection.appendChild(createEmptyMessage(message));
      }
      sections.push(resultsSection);

      const notificationsSection = document.createElement('div');
      notificationsSection.className = 'modal-section';
      const notificationsHeading = document.createElement('h4');
      notificationsHeading.textContent = 'Notificaciones';
      notificationsSection.appendChild(notificationsHeading);
      const notificationsList = createNotificationsList(run.notifications);
      if (notificationsList) {
        notificationsSection.appendChild(notificationsList);
      } else {
        notificationsSection.appendChild(createEmptyMessage('No se registraron notificaciones para esta ejecución.'));
      }
      sections.push(notificationsSection);

      const metricsSection = createMetricsSection(run.metrics);
      if (metricsSection) {
        sections.push(metricsSection);
      }

      if (run.delivery && Object.keys(run.delivery).length) {
        const deliverySection = document.createElement('div');
        deliverySection.className = 'modal-section';
        const heading = document.createElement('h4');
        heading.textContent = 'Entrega';
        deliverySection.appendChild(heading);
        deliverySection.appendChild(createJsonBlock(run.delivery));
        sections.push(deliverySection);
      }

      if (run.request && Object.keys(run.request).length) {
        const requestSection = document.createElement('div');
        requestSection.className = 'modal-section';
        const heading = document.createElement('h4');
        heading.textContent = 'Payload efectivo';
        requestSection.appendChild(heading);
        requestSection.appendChild(createJsonBlock(run.request));
        sections.push(requestSection);
      }

      if (run.error && (run.error.message || run.error.stack)) {
        const errorSection = document.createElement('div');
        errorSection.className = 'modal-section';
        const heading = document.createElement('h4');
        heading.textContent = 'Errores reportados';
        errorSection.appendChild(heading);
        const errorText = [];
        if (run.error.message) {
          errorText.push(`Mensaje: ${run.error.message}`);
        }
        if (run.error.stack) {
          errorText.push(run.error.stack);
        }
        errorSection.appendChild(createJsonBlock(errorText.join('\n')));
        sections.push(errorSection);
      }

      reportRunDetailsBody.replaceChildren(...sections);

      reportRunDetailsOverlay.hidden = false;
      reportRunDetailsOverlay.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
      if (closeReportRunDetailsButton) {
        closeReportRunDetailsButton.focus();
      }

      const descriptor = getStatusDescriptor(run.status);
      logStatus(`Detalles listos · ${run.jobId || 'job'} (${descriptor.label})`, 'info', 'ecoplan');
    }

    function translateNotificationStatus(status) {
      const normalized = typeof status === 'string' ? status.toLowerCase() : '';
      switch (normalized) {
        case 'sent':
          return 'OK';
        case 'skipped':
          return 'Omitido';
        case 'error':
          return 'Error';
        case 'pending':
          return 'Pendiente';
        case 'queued':
          return 'En cola';
        default:
          return status ? status.toString() : '—';
      }
    }

    function createTagElement(label, variant = 'neutral', href = null, tooltip = '') {
      const element = href ? document.createElement('a') : document.createElement('span');
      element.className = `tag ${variant}`;
      element.textContent = label;
      if (href) {
        element.href = href;
        element.target = '_blank';
        element.rel = 'noopener noreferrer';
      }
      if (tooltip) {
        element.title = tooltip;
      }
      return element;
    }

    function renderFormatsCell(cell, run) {
      cell.textContent = '';
      const results = Array.isArray(run?.results) ? run.results : [];
      if (!results.length) {
        cell.textContent = run?.status === 'running' ? 'Procesando…' : '—';
        return;
      }

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '6px';

      results.forEach((result) => {
        const formatLabel = (result?.format || '').toString().toUpperCase() || 'FORMATO';
        const href = result?.gcs?.publicUrl || null;
        const variant = mapTagVariant(result?.status);
        const tooltipParts = [];
        if (href) {
          tooltipParts.push('Abrir en pestaña nueva');
        } else if (result?.status === 'success') {
          tooltipParts.push('Generado localmente');
        }
        if (result?.error) {
          tooltipParts.push(`Error: ${result.error}`);
        }
        const tooltip = tooltipParts.join(' · ');
        const tag = createTagElement(formatLabel, variant, href, tooltip);
        container.appendChild(tag);
      });

      cell.appendChild(container);
    }

    function renderNotificationsCell(cell, run) {
      cell.textContent = '';
      const notifications = run?.notifications;
      if (!notifications || typeof notifications !== 'object' || !Object.keys(notifications).length) {
        cell.textContent = run?.status === 'running' ? 'Pendiente' : '—';
        return;
      }

      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = '6px';

      Object.entries(notifications).forEach(([channel, info]) => {
        const baseLabel = channel === 'email' ? 'Email' : channel === 'slack' ? 'Slack' : channel;
        const statusLabel = translateNotificationStatus(info?.status);
        const text = `${baseLabel}${statusLabel ? ` · ${statusLabel}` : ''}`;
        const tooltipParts = [];
        if (Array.isArray(info?.recipients) && info.recipients.length) {
          tooltipParts.push(`Destinatarios: ${info.recipients.join(', ')}`);
        }
        if (info?.reason) {
          tooltipParts.push(`Motivo: ${info.reason}`);
        }
        if (info?.error) {
          tooltipParts.push(`Error: ${info.error}`);
        }
        const tooltip = tooltipParts.join(' | ');
        const variant = mapTagVariant(info?.status);
        const tag = createTagElement(text, variant, null, tooltip);
        container.appendChild(tag);
      });

      cell.appendChild(container);
    }

    function renderReportRunsTable(runs = []) {
      if (!reportRunsTableBody) {
        return;
      }

      reportRunsTableBody.innerHTML = '';

      if (!Array.isArray(runs) || !runs.length) {
        if (reportRunsEmptyMessage) {
          const filtersApplied = Boolean(reportRunsFilterState.jobId || reportRunsFilterState.status);
          reportRunsEmptyMessage.hidden = false;
          reportRunsEmptyMessage.textContent = filtersApplied
            ? 'No hay ejecuciones que coincidan con los filtros seleccionados.'
            : (defaultReportRunsEmptyText || 'Sin ejecuciones registradas.');
        }
        updateReportRunsSummary([]);
        return;
      }

      if (reportRunsEmptyMessage) {
        reportRunsEmptyMessage.hidden = true;
        reportRunsEmptyMessage.textContent = defaultReportRunsEmptyText;
      }

      runs.forEach((run) => {
        const row = document.createElement('tr');
        row.classList.add('clickable-row');
        row.tabIndex = 0;
        row.setAttribute('role', 'button');
        row.setAttribute('aria-label', `Ver detalles de ${run?.jobId || run?.presetName || 'la ejecución'}`);
        row.addEventListener('click', () => {
          openReportRunDetails(run);
        });
        row.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openReportRunDetails(run);
          }
        });

        const dateCell = document.createElement('td');
        const datePrimary = document.createElement('div');
        datePrimary.textContent = formatDateTimeLabel(run?.generatedAt || run?.completedAt || run?.startedAt);
        dateCell.appendChild(datePrimary);
        const metaParts = [];
        if (run?.trigger) {
          metaParts.push(`Trigger: ${run.trigger}`);
        }
        const durationLabel = formatDurationLabel(run?.durationMs);
        if (durationLabel) {
          metaParts.push(`Duración: ${durationLabel}`);
        }
        if (metaParts.length) {
          const metaSpan = document.createElement('span');
          metaSpan.className = 'row-subtext';
          metaSpan.textContent = metaParts.join(' · ');
          dateCell.appendChild(metaSpan);
        }
        row.appendChild(dateCell);

        const jobCell = document.createElement('td');
        const jobTitle = document.createElement('div');
        jobTitle.textContent = run?.jobId || '—';
        jobTitle.style.fontWeight = '600';
        jobCell.appendChild(jobTitle);
        const presetLabel = run?.presetName || run?.presetId;
        if (presetLabel) {
          const presetSpan = document.createElement('span');
          presetSpan.className = 'row-subtext';
          presetSpan.textContent = presetLabel;
          jobCell.appendChild(presetSpan);
        }
        const periodStart = run?.request?.start;
        const periodEnd = run?.request?.end;
        if (periodStart || periodEnd) {
          const periodSpan = document.createElement('span');
          periodSpan.className = 'row-subtext';
          if (periodStart && periodEnd) {
            periodSpan.textContent = `${periodStart} → ${periodEnd}`;
          } else if (periodStart) {
            periodSpan.textContent = `Desde ${periodStart}`;
          } else {
            periodSpan.textContent = `Hasta ${periodEnd}`;
          }
          jobCell.appendChild(periodSpan);
        }
        row.appendChild(jobCell);

        const statusCell = document.createElement('td');
        const descriptor = getStatusDescriptor(run?.status);
        const statusPill = document.createElement('span');
        statusPill.className = `status-pill ${descriptor.variant}`;
        statusPill.textContent = descriptor.label;
        statusCell.appendChild(statusPill);
        if (run?.error?.message) {
          const errorSpan = document.createElement('span');
          errorSpan.className = 'row-subtext';
          errorSpan.textContent = run.error.message;
          statusCell.appendChild(errorSpan);
        }
        row.appendChild(statusCell);

        const formatsCell = document.createElement('td');
        renderFormatsCell(formatsCell, run);
        row.appendChild(formatsCell);

        const notificationsCell = document.createElement('td');
        renderNotificationsCell(notificationsCell, run);
        row.appendChild(notificationsCell);

        reportRunsTableBody.appendChild(row);
      });

      updateReportRunsSummary(runs);
    }

    function setReportRunsLoadingState(isLoading) {
      reportRunsLoading = isLoading;
      if (!refreshReportRunsButton) {
        return;
      }
      refreshReportRunsButton.disabled = isLoading;
      refreshReportRunsButton.textContent = isLoading
        ? 'Actualizando…'
        : (refreshReportRunsDefaultText || 'Actualizar');
    }

    async function fetchReportRuns({ announce = true, limit = REPORT_RUNS_LIMIT } = {}) {
      if (!reportRunsTableBody) {
        return;
      }

      const safeLimit = Math.max(1, Math.min(200, Number(limit) || REPORT_RUNS_LIMIT));
      reportRunsCurrentLimit = safeLimit;

      if (reportRunsLoading) {
        reportRunsFetchQueued = true;
        return;
      }

      setReportRunsLoadingState(true);

      if (announce) {
        logStatus('Consultando historial de reportes...', 'info', 'ecoplan');
      }

      try {
        const params = new URLSearchParams();
        params.set('limit', safeLimit.toString());
        if (reportRunsFilterState.jobId) {
          params.set('jobId', reportRunsFilterState.jobId);
        }
        if (reportRunsFilterState.status) {
          params.set('status', reportRunsFilterState.status);
        }

        const response = await fetch(`/api/reports/history?${params.toString()}`, { cache: 'no-store' });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || response.statusText || 'Error desconocido');
        }
        const data = await response.json();
        const runs = Array.isArray(data?.runs) ? data.runs : [];
        reportRunsLastResponse = runs;
        if (runs.length) {
          updateReportRunsFilterOptions(runs);
        } else {
          renderReportRunsFilters();
        }
        renderReportRunsTable(runs);
        reportRunsLastUpdatedAt = new Date().toISOString();
        updateReportRunsAutoRefreshStatusLabel();
        reportRunsLoaded = true;
        if (announce) {
          const appliedFilters = [];
          if (reportRunsFilterState.jobId) {
            appliedFilters.push(`job ${reportRunsFilterState.jobId}`);
          }
          if (reportRunsFilterState.status) {
            const statusDescriptor = getStatusDescriptor(reportRunsFilterState.status);
            appliedFilters.push(`estado ${statusDescriptor.label}`);
          }
          const filtersText = appliedFilters.length ? ` (${appliedFilters.join(', ')})` : '';
          logStatus(`Historial actualizado (${runs.length})${filtersText}.`, 'success', 'ecoplan');
        }
      } catch (error) {
        console.error('No se pudo cargar el historial de reportes:', error);
        reportRunsLoaded = false;
        if (reportRunsEmptyMessage) {
          reportRunsEmptyMessage.hidden = false;
          reportRunsEmptyMessage.textContent = `Error al cargar historial: ${error.message}`;
        }
        if (announce) {
          logStatus(`No se pudo cargar el historial: ${error.message}`, 'error', 'ecoplan');
        }
      } finally {
        setReportRunsLoadingState(false);
        if (reportRunsFetchQueued) {
          reportRunsFetchQueued = false;
          fetchReportRuns({ announce: false, limit: reportRunsCurrentLimit });
        }
        updateReportRunsAutoRefreshStatusLabel();
      }
    }

    function ensureReportRunsLoaded() {
      if (!reportRunsLoaded && !reportRunsLoading) {
        fetchReportRuns({ announce: false });
      }
    }

    function formatNumber(value, decimals = 2) {
      if (value === null || value === undefined || Number.isNaN(value)) return '–';
      return Number(value).toLocaleString('es-PE', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    function buildRangeText(min, max, decimals = 2) {
      const minText = formatNumber(min, decimals);
      const maxText = formatNumber(max, decimals);
      if (minText === '–' || maxText === '–') {
        return '–';
      }
      return `${minText} – ${maxText}`;
    }

    function setDefaultDates(startId = 'startDate', endId = 'endDate') {
      const startInput = document.getElementById(startId);
      const endInput = document.getElementById(endId);
      if (!startInput || !endInput) return;

      const today = new Date();
      const endValue = today.toISOString().split('T')[0];
      const start = new Date(today);
      start.setDate(start.getDate() - 30);
      const startValue = start.toISOString().split('T')[0];

      if (!startInput.value) {
        startInput.value = startValue;
      }
      if (!endInput.value) {
        endInput.value = endValue;
      }
    }

    async function applyBloomPresetList(presets, {
      preserveSelection = true,
      triggerRun = true
    } = {}) {
      const select = document.getElementById('presetSelect');
      if (!select || !Array.isArray(presets) || !presets.length) {
        return false;
      }

      const previousValue = preserveSelection ? select.value : null;
      const shouldKeepPrevious = previousValue && presets.some((preset) => preset.id === previousValue);

      select.innerHTML = '';
      presets.forEach((preset) => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = `${preset.label} (${preset.type})`;
        option.dataset.defaultBuffer = preset.defaultBuffer ?? 0;
        select.appendChild(option);
      });

      if (shouldKeepPrevious) {
        select.value = previousValue;
      } else if (presets[0]) {
        select.value = presets[0].id;
      }

      if (bloomRunButton) bloomRunButton.disabled = false;
      updateBufferPlaceholder();
      setDefaultDates();

      if (!bloomInitialized && triggerRun) {
        bloomInitialized = true;
        try {
          await runBloomAnalysis();
        } catch (error) {
          console.error('Error al ejecutar el análisis automático:', error);
        }
      }

      return true;
    }

    async function fetchBloomPresets() {
      const select = document.getElementById('presetSelect');
      if (!select) {
        logStatus('No se encontró el selector de presets en el DOM.', 'error', 'bloom');
        return;
      }

      const hasLocalPresets = Array.isArray(BLOOM_PRESETS_LOCAL) && BLOOM_PRESETS_LOCAL.length > 0;

      if (hasLocalPresets) {
        logStatus('Presets locales disponibles inmediatamente.', 'info', 'bloom');
        await applyBloomPresetList(BLOOM_PRESETS_LOCAL, { triggerRun: false });
      }

      logStatus('Solicitando presets de ROI a la API...', 'info', 'bloom');

      try {
        const response = await fetch('/api/bloom/presets', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }
        const data = await response.json();
        const presets = Array.isArray(data?.presets) ? data.presets : [];
        if (!presets.length) {
          throw new Error('Respuesta sin presets');
        }

        await applyBloomPresetList(presets, { preserveSelection: true, triggerRun: true });
        logStatus(`Presets de ROI cargados desde la API (${presets.length}).`, 'success', 'bloom');
      } catch (error) {
        const message = error?.message || 'Error desconocido';
        if (hasLocalPresets) {
          logStatus(`No se pudo cargar presets desde la API (${message}). Se mantiene la lista local.`, 'warning', 'bloom');
          await applyBloomPresetList(BLOOM_PRESETS_LOCAL, { preserveSelection: true, triggerRun: !bloomInitialized });
        } else {
          select.innerHTML = '';
          const option = document.createElement('option');
          option.value = '';
          option.disabled = true;
          option.selected = true;
          option.textContent = 'No se pudieron cargar los presets';
          select.appendChild(option);
          if (bloomRunButton) bloomRunButton.disabled = true;
          logStatus(`Error al cargar presets: ${message}`, 'error', 'bloom');
        }
      }
    }

    async function applyEcoPresetList(presets, {
      preserveSelection = true,
      triggerRun = false
    } = {}) {
      const select = document.getElementById('ecoPresetSelect');
      if (!select || !Array.isArray(presets) || !presets.length) {
        return false;
      }

      const previousValue = preserveSelection ? select.value : null;
      const keepPrevious = previousValue && presets.some((preset) => preset.id === previousValue);

      select.innerHTML = '';
      presets.forEach((preset) => {
        const option = document.createElement('option');
        option.value = preset.id;
        option.textContent = `${preset.label} (${preset.type})`;
        option.dataset.defaultBuffer = preset.defaultBuffer ?? 0;
        select.appendChild(option);
      });

      if (keepPrevious) {
        select.value = previousValue;
      } else if (presets[0]) {
        select.value = presets[0].id;
      }

      if (ecoRunButton) ecoRunButton.disabled = false;
      setDefaultDates('ecoStartDate', 'ecoEndDate');
      updateEcoBufferPlaceholder();

      if (triggerRun && !ecoInitialized) {
        ecoInitialized = true;
        try {
          await runEcoPlanAnalysis();
        } catch (error) {
          console.error('Error al ejecutar análisis EcoPlan automático:', error);
        }
      }

      return true;
    }

    async function fetchEcoPresets() {
      const select = document.getElementById('ecoPresetSelect');
      if (!select) {
        logStatus('No se encontró el selector de presets EcoPlan en el DOM.', 'error', 'ecoplan');
        return;
      }

      const hasLocalPresets = Array.isArray(ECO_PRESETS_LOCAL) && ECO_PRESETS_LOCAL.length > 0;

      if (hasLocalPresets) {
        logStatus('Presets urbanos disponibles localmente.', 'info', 'ecoplan');
        await applyEcoPresetList(ECO_PRESETS_LOCAL, { triggerRun: false });
      }

      logStatus('Solicitando presets EcoPlan a la API...', 'info', 'ecoplan');

      try {
        const response = await fetch('/api/ecoplan/presets', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }
        const data = await response.json();
        const presets = Array.isArray(data?.presets) ? data.presets : [];
        if (!presets.length) {
          throw new Error('Respuesta sin presets');
        }

        await applyEcoPresetList(presets, { preserveSelection: true, triggerRun: true });
        logStatus(`Presets EcoPlan cargados (${presets.length}).`, 'success', 'ecoplan');
      } catch (error) {
        const message = error?.message || 'Error desconocido';
        if (hasLocalPresets) {
          logStatus(`No se pudo actualizar presets EcoPlan (${message}). Se usan locales.`, 'warning', 'ecoplan');
          await applyEcoPresetList(ECO_PRESETS_LOCAL, { preserveSelection: true, triggerRun: false });
        } else {
          select.innerHTML = '';
          const option = document.createElement('option');
          option.value = '';
          option.disabled = true;
          option.selected = true;
          option.textContent = 'No se pudieron cargar los presets';
          select.appendChild(option);
          if (ecoRunButton) ecoRunButton.disabled = true;
          logStatus(`Error al cargar presets EcoPlan: ${message}`, 'error', 'ecoplan');
        }
      }
    }

    function createMap() {
      map = L.map('map', { zoomControl: false }).setView([-12.05, -77.05], 10);

      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const esri = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, GIS User Community'
      });

      baseLayers['OpenStreetMap'] = osm;
      baseLayers['ESRI Imagery'] = esri;
      layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);
      L.control.scale({ metric: true }).addTo(map);
      L.control.zoom({ position: 'topright' }).addTo(map);
    }

    async function loadGeeBasemap() {
      try {
        const response = await fetch('/api/map/info', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }

        const mapInfo = await response.json();
        const url = resolveTileUrl(mapInfo);
        if (!url) {
          logStatus('No se pudo construir la URL de la capa base de GEE.', 'warning', 'bloom');
          return;
        }

        const label = mapInfo.description ? `GEE – ${mapInfo.description}` : 'GEE Landsat 8 True Color';
        const geeLayer = L.tileLayer(url, {
          attribution: 'Google Earth Engine (Landsat 8 True Color)',
          maxZoom: mapInfo.maxZoom ?? 18,
          opacity: 1
        });

        baseLayers[label] = geeLayer;
        geeLayer.addTo(map);
        if (baseLayers['OpenStreetMap'] && map.hasLayer(baseLayers['OpenStreetMap'])) {
          map.removeLayer(baseLayers['OpenStreetMap']);
        }
        rebuildLayerControl();
        logStatus('Capa base satelital de GEE cargada.', 'success', 'bloom');
      } catch (error) {
        console.error('No se pudo cargar el mapa base de GEE:', error);
        logStatus(`No se pudo cargar la capa base de GEE: ${error.message}`, 'warning', 'bloom');
      }
    }

    function rebuildLayerControl() {
      if (layerControl) {
        layerControl.remove();
      }
      layerControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);
    }

    function clearOverlays() {
      Object.values(overlayLayers).forEach((layer) => {
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });
      overlayLayers = {};
      if (roiLayer && map.hasLayer(roiLayer)) {
        map.removeLayer(roiLayer);
      }
      if (contextLayer && map.hasLayer(contextLayer)) {
        map.removeLayer(contextLayer);
      }
      roiLayer = null;
      contextLayer = null;
      rebuildLayerControl();
      layerBadgesContainer.innerHTML = '';
    }

    function addBadge(label) {
      const badge = document.createElement('span');
      badge.className = 'layer-badge';
      badge.textContent = label;
      layerBadgesContainer.appendChild(badge);
    }

    function resolveTileUrl(mapInfo) {
      if (!mapInfo) return null;
      const candidates = [
        mapInfo.tileUrl,
        mapInfo.urlFormat,
        mapInfo.url,
        mapInfo.v1TileUrl,
        mapInfo.legacyTileUrl
      ];

      for (const value of candidates) {
        if (typeof value === 'string' && value.includes('{z}') && value.includes('{x}') && value.includes('{y}')) {
          return value;
        }
      }

      const rawMapId = mapInfo.legacyMapId || mapInfo.mapid;
      if (rawMapId) {
        const hasPath = rawMapId.includes('/');
        const legacyId = hasPath && rawMapId.includes('/maps/') ? rawMapId.split('/maps/')[1] : rawMapId;
        if (legacyId) {
          const suffix = mapInfo.token ? `?token=${mapInfo.token}` : '';
          return `https://earthengine.googleapis.com/map/${legacyId}/{z}/{x}/{y}${suffix}`;
        }
      }

      return null;
    }

    function addOverlayLayer(label, mapInfo, options = {}, mode = currentMode) {
      const url = resolveTileUrl(mapInfo);
      if (!url) {
        logStatus(`No se pudo construir la URL de tiles para ${label}.`, 'error', mode);
        return;
      }

      const layer = L.tileLayer(url, {
        attribution: 'Google Earth Engine',
        opacity: options.opacity ?? mapInfo.opacity ?? 0.85,
        maxZoom: options.maxZoom ?? mapInfo.maxZoom ?? 18
      });
      overlayLayers[label] = layer;
      const shouldShow = options.visible ?? mapInfo.visible ?? false;
      if (shouldShow) {
        layer.addTo(map);
      }
      addBadge(label);
    }

    function updateMapLayers(layers, roiGeometry, contextGeometry, { mode = currentMode } = {}) {
      clearOverlays();

      if (roiLayer) {
        map.removeLayer(roiLayer);
      }
      if (contextLayer) {
        map.removeLayer(contextLayer);
      }

      if (roiGeometry) {
        roiLayer = L.geoJSON(roiGeometry, {
          style: {
            color: '#22d3ee',
            weight: 2,
            dashArray: '6 3',
            fill: false
          }
        }).addTo(map);
        try {
          const bounds = roiLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds.pad(0.25));
          }
        } catch (error) {
          console.warn('No se pudo ajustar el mapa al ROI:', error);
        }
      }

      if (contextGeometry) {
        contextLayer = L.geoJSON(contextGeometry, {
          style: {
            color: '#fbbf24',
            weight: 1.2,
            dashArray: '4 4',
            fill: false
          }
        }).addTo(map);
      }

      if (layers) {
        const entries = Object.entries(layers);
        entries.forEach(([key, layerConfig], index) => {
          const label = layerConfig.name || key;
          let visibleDefault = index === 0;
          if (mode === 'bloom') {
            if (key === 'bloom') visibleDefault = true;
            if (key === 'trueColor') visibleDefault = false;
          }
          if (mode === 'ecoplan') {
            visibleDefault = key === 'heat';
          }
          const defaultOpacity = (mode === 'bloom' && key === 'bloom') ? 0.75 : (layerConfig.opacity ?? 0.85);
          const options = {
            visible: layerConfig.visible ?? visibleDefault,
            opacity: defaultOpacity,
            maxZoom: layerConfig.maxZoom
          };
          addOverlayLayer(label, layerConfig, options, mode);
        });
      }

      rebuildLayerControl();
    }

    function updateContextLayers(contextLayers) {
      if (!contextLayers) return;
      if (contextLayers.chlorophyll) {
        addOverlayLayer('Clorofila MODIS', contextLayers.chlorophyll, { visible: false }, 'bloom');
      }
      if (contextLayers.sst) {
        addOverlayLayer('SST NOAA', contextLayers.sst, { visible: false }, 'bloom');
      }
      rebuildLayerControl();
    }

    function ensureChart(chartRef, canvasId, config) {
      if (chartRef) {
        chartRef.data = config.data;
        chartRef.options = config.options;
        chartRef.update();
        return chartRef;
      }
      const ctx = document.getElementById(canvasId);
      if (!ctx) return null;
      return new Chart(ctx, config);
    }

    function buildLineChartConfig(labels, datasetLabel, data, color) {
      return {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: datasetLabel,
              data,
              borderColor: color,
              backgroundColor: colorWithAlpha(color, 0.18),
              borderWidth: 2,
              pointRadius: 2,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            x: {
              ticks: { maxRotation: 0, autoSkip: true, color: varColor('--text-muted') },
              grid: { display: false }
            },
            y: {
              ticks: { color: varColor('--text-muted') },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            }
          }
        }
      };
    }

    function updateAreaSummary(areaData) {
      const areaFeatures = getFeatureArray(areaData);
      if (!areaFeatures.length) {
        document.getElementById('areaMax').textContent = '–';
        document.getElementById('areaLast').textContent = '–';
        areaChartInstance = ensureChart(areaChartInstance, 'areaChart', buildLineChartConfig([], 'Área (km²)', [], '#f97316'));
        return;
      }
      const areas = areaFeatures.map((f) => Number(f.properties.area_km2 || 0));
      const dates = areaFeatures.map((f) => f.properties.date);
      const maxArea = Math.max(...areas);
      const lastNonNullIndex = [...areas].reverse().findIndex((value) => value > 0);
      const lastIndex = lastNonNullIndex === -1 ? areas.length - 1 : areas.length - 1 - lastNonNullIndex;
      const lastArea = areas[lastIndex];
      const lastDate = dates[lastIndex];

      document.getElementById('areaMax').textContent = `${formatNumber(maxArea)} km²`;
      document.getElementById('areaLast').textContent = `${formatNumber(lastArea)} km² (${lastDate})`;

      areaChartInstance = ensureChart(areaChartInstance, 'areaChart', buildLineChartConfig(
        dates,
        'Área (km²)',
        areas,
        '#f97316'
      ));
    }

    function updateContextCharts(seriesData, summaryData) {
      const chlorFeatures = getFeatureArray(seriesData?.chlorophyll);
      const chlorLabels = chlorFeatures.map((f) => f.properties?.date);
      const chlorValues = chlorFeatures.map((f) => Number(f.properties?.chlor_a ?? f.properties?.value ?? NaN));

      chlorChartInstance = ensureChart(chlorChartInstance, 'chlorChart', buildLineChartConfig(
        chlorLabels,
        'Clorofila-a (mg/m³)',
        chlorValues,
        '#22d3ee'
      ));

      const sstFeatures = getFeatureArray(seriesData?.sst);
      const sstLabels = sstFeatures.map((f) => f.properties?.date);
      const sstValues = sstFeatures.map((f) => {
        const raw = Number(f.properties?.sst ?? f.properties?.value ?? NaN);
        if (!Number.isFinite(raw)) return NaN;
        return raw > 150 ? raw - 273.15 : raw;
      });

      sstChartInstance = ensureChart(sstChartInstance, 'sstChart', buildLineChartConfig(
        sstLabels,
        'SST (°C)',
        sstValues,
        '#ef4444'
      ));

      let chlorMean = Number(summaryData?.chlor_mean ?? NaN);
      if (!Number.isFinite(chlorMean)) {
        chlorMean = averageNumeric(chlorValues.filter((value) => Number.isFinite(value)));
      }

      let sstMean = Number(summaryData?.sst_mean ?? NaN);
      if (Number.isFinite(sstMean) && sstMean > 150) {
        sstMean -= 273.15;
      } else if (!Number.isFinite(sstMean)) {
        sstMean = averageNumeric(sstValues.filter((value) => Number.isFinite(value)));
      }

      document.getElementById('chlorMean').textContent = formatNumber(chlorMean, 2);
      document.getElementById('sstMean').textContent = formatNumber(sstMean, 2);
    }

    function getSummaryNumber(summary, key) {
      if (!summary || summary[key] === null || summary[key] === undefined) {
        return NaN;
      }
      const value = Number(summary[key]);
      return Number.isFinite(value) ? value : NaN;
    }

    function updateEcoSummary(summary) {
      const s = summary || {};
      const ndviMean = getSummaryNumber(s, 'ndvi_mean');
      const ndviMin = getSummaryNumber(s, 'ndvi_min');
      const ndviMax = getSummaryNumber(s, 'ndvi_max');

      const lstMean = getSummaryNumber(s, 'lst_mean');
      const lstMin = getSummaryNumber(s, 'lst_min');
      const lstMax = getSummaryNumber(s, 'lst_max');

      const heatMean = getSummaryNumber(s, 'heat_mean');
      const heatMin = getSummaryNumber(s, 'heat_min');
      const heatMax = getSummaryNumber(s, 'heat_max');

      const ndwiMean = getSummaryNumber(s, 'ndwi_mean');
      const ndwiMin = getSummaryNumber(s, 'ndwi_min');
      const ndwiMax = getSummaryNumber(s, 'ndwi_max');

      const aodMean = getSummaryNumber(s, 'aod_mean');
      const aodMin = getSummaryNumber(s, 'aod_min');
      const aodMax = getSummaryNumber(s, 'aod_max');

      const airQualityMean = getSummaryNumber(s, 'air_quality_mean');
      const airQualityMin = getSummaryNumber(s, 'air_quality_min');
      const airQualityMax = getSummaryNumber(s, 'air_quality_max');

      const no2Mean = getSummaryNumber(s, 'no2_mean');
      const pm25Mean = getSummaryNumber(s, 'pm25_mean');

      const imperviousMean = getSummaryNumber(s, 'impervious_mean');
      const imperviousMin = getSummaryNumber(s, 'impervious_min');
      const imperviousMax = getSummaryNumber(s, 'impervious_max');

      const waterRiskMean = getSummaryNumber(s, 'water_risk_mean');
      const waterRiskMin = getSummaryNumber(s, 'water_risk_min');
      const waterRiskMax = getSummaryNumber(s, 'water_risk_max');

  const greenPerCapitaMean = getSummaryNumber(s, 'green_per_capita_mean');
  const greenPerCapitaMin = getSummaryNumber(s, 'green_per_capita_min');
  const greenPerCapitaMax = getSummaryNumber(s, 'green_per_capita_max');
  const greenAreaM2 = getSummaryNumber(s, 'green_area_m2');
  const greenAreaHa = Number.isFinite(greenAreaM2) ? greenAreaM2 / 10000 : NaN;
  const greenDeficitRatio = getSummaryNumber(s, 'green_deficit_ratio');

  const populationMean = getSummaryNumber(s, 'population_mean');
  const populationMax = getSummaryNumber(s, 'population_max');
  const populationTotal = getSummaryNumber(s, 'population_total');

      if (ecoSummaryEls.ndviMean) ecoSummaryEls.ndviMean.textContent = formatNumber(ndviMean, 3);
      if (ecoSummaryEls.ndviRange) ecoSummaryEls.ndviRange.textContent = buildRangeText(ndviMin, ndviMax, 3);

      if (ecoSummaryEls.lstMean) ecoSummaryEls.lstMean.textContent = formatNumber(lstMean, 2);
      if (ecoSummaryEls.lstRange) ecoSummaryEls.lstRange.textContent = buildRangeText(lstMin, lstMax, 2);

      if (ecoSummaryEls.heatMean) ecoSummaryEls.heatMean.textContent = formatNumber(heatMean, 2);
      if (ecoSummaryEls.heatRange) ecoSummaryEls.heatRange.textContent = buildRangeText(heatMin, heatMax, 2);

      if (ecoSummaryEls.aodMean) ecoSummaryEls.aodMean.textContent = formatNumber(aodMean, 3);
      if (ecoSummaryEls.aodRange) ecoSummaryEls.aodRange.textContent = buildRangeText(aodMin, aodMax, 3);

      if (ecoSummaryEls.airQualityMean) ecoSummaryEls.airQualityMean.textContent = formatNumber(airQualityMean, 2);
      if (ecoSummaryEls.airQualityRange) ecoSummaryEls.airQualityRange.textContent = buildRangeText(airQualityMin, airQualityMax, 2);

      if (ecoSummaryEls.no2Mean) {
        const no2Micro = Number.isFinite(no2Mean) ? no2Mean * 1e6 : NaN;
        ecoSummaryEls.no2Mean.textContent = formatNumber(no2Micro, 1);
      }

      if (ecoSummaryEls.pm25Mean) ecoSummaryEls.pm25Mean.textContent = formatNumber(pm25Mean, 1);

      if (ecoSummaryEls.ndwiMean) ecoSummaryEls.ndwiMean.textContent = formatNumber(ndwiMean, 3);
      if (ecoSummaryEls.ndwiRange) ecoSummaryEls.ndwiRange.textContent = buildRangeText(ndwiMin, ndwiMax, 3);

      if (ecoSummaryEls.imperviousMean) ecoSummaryEls.imperviousMean.textContent = formatNumber(imperviousMean, 3);
      if (ecoSummaryEls.imperviousRange) ecoSummaryEls.imperviousRange.textContent = buildRangeText(imperviousMin, imperviousMax, 3);

      if (ecoSummaryEls.waterRiskMean) ecoSummaryEls.waterRiskMean.textContent = formatNumber(waterRiskMean, 2);
      if (ecoSummaryEls.waterRiskRange) ecoSummaryEls.waterRiskRange.textContent = buildRangeText(waterRiskMin, waterRiskMax, 2);

      if (ecoSummaryEls.greenPerCapitaMean) ecoSummaryEls.greenPerCapitaMean.textContent = formatNumber(greenPerCapitaMean, 1);
      if (ecoSummaryEls.greenPerCapitaRange) ecoSummaryEls.greenPerCapitaRange.textContent = buildRangeText(greenPerCapitaMin, greenPerCapitaMax, 1);
      if (ecoSummaryEls.greenAreaTotal) ecoSummaryEls.greenAreaTotal.textContent = formatNumber(greenAreaHa, 1);

      if (ecoSummaryEls.greenDeficitRatio) {
        if (Number.isFinite(greenDeficitRatio)) {
          ecoSummaryEls.greenDeficitRatio.textContent = `${formatNumber(greenDeficitRatio * 100, 1)} %`;
        } else {
          ecoSummaryEls.greenDeficitRatio.textContent = '–';
        }
      }

      if (ecoSummaryEls.populationMean) ecoSummaryEls.populationMean.textContent = formatNumber(populationMean, 0);
      if (ecoSummaryEls.populationMax) ecoSummaryEls.populationMax.textContent = formatNumber(populationMax, 0);
      if (ecoSummaryEls.populationTotal) ecoSummaryEls.populationTotal.textContent = formatNumber(populationTotal, 0);
    }

    function updateEcoCharts(seriesData) {
      const ndviFeatures = getFeatureArray(seriesData?.ndvi);
      const ndviLabels = ndviFeatures.map((f) => f.properties?.date);
      const ndviValues = ndviFeatures.map((f) => Number(f.properties?.ndvi ?? f.properties?.value ?? NaN));
      ecoNdviChartInstance = ensureChart(ecoNdviChartInstance, 'ecoNdviChart', buildLineChartConfig(
        ndviLabels,
        'NDVI promedio',
        ndviValues,
        '#16a34a'
      ));

      const lstFeatures = getFeatureArray(seriesData?.lst);
      const lstLabels = lstFeatures.map((f) => f.properties?.date);
      const lstValues = lstFeatures.map((f) => Number(f.properties?.lst_c ?? f.properties?.value ?? NaN));
      ecoLstChartInstance = ensureChart(ecoLstChartInstance, 'ecoLstChart', buildLineChartConfig(
        lstLabels,
        'LST (°C)',
        lstValues,
        '#f97316'
      ));

      const aodFeatures = getFeatureArray(seriesData?.aod);
      const aodLabels = aodFeatures.map((f) => f.properties?.date);
      const aodValues = aodFeatures.map((f) => Number(f.properties?.aod ?? f.properties?.value ?? NaN));
      ecoAodChartInstance = ensureChart(ecoAodChartInstance, 'ecoAodChart', buildLineChartConfig(
        aodLabels,
        'AOD promedio',
        aodValues,
        '#9333ea'
      ));

      const no2Features = getFeatureArray(seriesData?.no2);
      const no2Labels = no2Features.map((f) => f.properties?.date);
      const no2Values = no2Features.map((f) => {
        const raw = Number(f.properties?.no2 ?? f.properties?.value ?? NaN);
        return Number.isFinite(raw) ? raw * 1e6 : NaN;
      });
      ecoNo2ChartInstance = ensureChart(ecoNo2ChartInstance, 'ecoNo2Chart', buildLineChartConfig(
        no2Labels,
        'NO₂ (µmol·m⁻²)',
        no2Values,
        '#2563eb'
      ));

      const pm25Features = getFeatureArray(seriesData?.pm25);
      const pm25Labels = pm25Features.map((f) => f.properties?.date);
      const pm25Values = pm25Features.map((f) => Number(f.properties?.pm25 ?? f.properties?.value ?? NaN));
      ecoPm25ChartInstance = ensureChart(ecoPm25ChartInstance, 'ecoPm25Chart', buildLineChartConfig(
        pm25Labels,
        'PM₂.₅ (µg·m⁻³)',
        pm25Values,
        '#dc2626'
      ));
    }

    function resolveDistrictName(properties = {}, fallbackIndex) {
      const nameKeys = ['name', 'NAME', 'NAM', 'NOMBRE', 'NOM_DIST', 'distrito', 'DISTRITO', 'DIST', 'DIST_NAME', 'Provincia', 'provincia'];
      for (const key of nameKeys) {
        if (properties[key]) {
          return properties[key];
        }
      }
      if (fallbackIndex !== undefined) {
        return `Área ${fallbackIndex + 1}`;
      }
      return 'Área';
    }

    function updateEcoBoundaryTable(boundaryStats) {
      if (!ecoSummaryEls.boundaryBody || !ecoSummaryEls.boundaryCard) {
        return;
      }

      ecoSummaryEls.boundaryBody.innerHTML = '';

      const features = getFeatureArray(boundaryStats);
      if (!features.length) {
        ecoSummaryEls.boundaryCard.hidden = true;
        return;
      }

      features.slice(0, 25).forEach((feature, index) => {
        const props = feature.properties || {};
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${resolveDistrictName(props, index)}</td>
          <td>${formatNumber(props.NDVI_mean, 3)}</td>
          <td>${formatNumber(props.LST_C_mean, 2)}</td>
          <td>${formatNumber(props.HeatVulnerability_mean, 2)}</td>
          <td>${formatNumber(props.population_density_mean, 0)}</td>
        `;
        ecoSummaryEls.boundaryBody.appendChild(row);
      });

      ecoSummaryEls.boundaryCard.hidden = false;
    }

    function renderBloomResult(result, { silent = false } = {}) {
      if (!result) return;
      lastBloomResult = result;

      if (currentMode !== 'bloom') {
        if (!silent) {
          logStatus('Resultado de floraciones listo. Cambia a su modo para visualizarlo.', 'info', 'bloom');
        }
        return;
      }
      const { mapData, statsData, contextData } = result;
      const thresholds = mapData?.thresholds || mapData?.thresholdsEvaluated;
      const contextGeometry = contextData?.contextGeometry || contextData?.contextRoi || null;

      if (thresholds) {
        updateThresholdCard(thresholds);
      }

      updateMapLayers(mapData?.layers || {}, mapData?.roi, contextGeometry, { mode: 'bloom' });
      if (contextData?.layers) {
        updateContextLayers(contextData.layers);
      }
      updateAreaSummary(statsData?.areaSeries);
      updateContextCharts(contextData?.series, contextData?.summary);

      if (!silent) {
        logStatus('Capas actualizadas correctamente.', 'success', 'bloom');
        if (mapData?.presetMeta?.label) {
          logStatus(`ROI analizado: ${mapData.presetMeta.label}`, 'success', 'bloom');
        }
      }
    }

    function renderEcoResult(result, { silent = false } = {}) {
      if (!result) return;

      lastEcoResult = result;

      if (currentMode !== 'ecoplan') {
        if (!silent) {
          logStatus('Indicadores EcoPlan listos. Cambia al modo EcoPlan para verlos.', 'info', 'ecoplan');
        }
        return;
      }

      updateMapLayers(result.layers || {}, result.roi, null, { mode: 'ecoplan' });
      updateEcoSummary(result.summary);
      updateEcoCharts(result.series);
      updateEcoBoundaryTable(result.boundaryStats);

      if (!silent) {
        logStatus('Indicadores EcoPlan actualizados.', 'success', 'ecoplan');
        if (result.presetMeta?.label) {
          logStatus(`Área analizada: ${result.presetMeta.label}`, 'success', 'ecoplan');
        }
      }
    }

    function setMode(mode, { reRender = true, silent = false } = {}) {
      const normalized = mode === 'ecoplan' ? 'ecoplan' : 'bloom';
      currentMode = normalized;

      modeButtons.forEach((button) => {
        const isActive = button.dataset.mode === normalized;
        button.classList.toggle('active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });

      const isBloom = normalized === 'bloom';
      bloomControls.classList.toggle('hidden', !isBloom);
      bloomSummarySection.classList.toggle('hidden', !isBloom);
      ecoControls.classList.toggle('hidden', isBloom);
      ecoSummarySection.classList.toggle('hidden', isBloom);

      if (normalized === 'ecoplan') {
        ensureReportRunsLoaded();
        scheduleReportRunsAutoRefresh({ fetchImmediately: reportRunsAutoRefreshEnabled });
      } else {
        clearReportRunsAutoRefreshTimer();
      }

      persistModePreference(normalized);
      updateReportRunsAutoRefreshStatusLabel();

      if (!reRender) {
        return;
      }

      if (normalized === 'bloom') {
        if (lastBloomResult) {
          renderBloomResult(lastBloomResult, { silent: true });
        } else if (!silent) {
          logStatus('Configura los parámetros y ejecuta el análisis de floraciones.', 'info', 'bloom');
        }
      } else if (normalized === 'ecoplan') {
        if (lastEcoResult) {
          renderEcoResult(lastEcoResult, { silent: true });
        } else if (!silent) {
          logStatus('Completa el formulario EcoPlan para obtener indicadores urbanos.', 'info', 'ecoplan');
        }
      }
    }

    function updateThresholdCard(thresholds) {
      document.getElementById('thresholdNdci').textContent = formatNumber(thresholds?.ndci, 3);
      document.getElementById('thresholdFai').textContent = formatNumber(thresholds?.fai, 3);
      document.getElementById('thresholdFaiAlt').textContent = formatNumber(thresholds?.faiAlt, 3);
    }
    function updateBufferPlaceholder() {
      const select = document.getElementById('presetSelect');
      const bufferInput = document.getElementById('buffer');
      if (!select || !bufferInput || !select.selectedOptions.length) return;
      const selectedOption = select.selectedOptions[0];
      const hasBuffer = selectedOption && selectedOption.dataset.defaultBuffer !== undefined;
      if (hasBuffer) {
        const value = Number(selectedOption.dataset.defaultBuffer);
        bufferInput.placeholder = Number.isFinite(value) && value !== 0 ? `Sugerencia: ${value} m` : 'Opcional';
      } else {
        bufferInput.placeholder = 'Opcional';
      }
    }

    function updateEcoBufferPlaceholder() {
      const select = document.getElementById('ecoPresetSelect');
      const bufferInput = document.getElementById('ecoBuffer');
      if (!select || !bufferInput || !select.selectedOptions.length) return;
      const selectedOption = select.selectedOptions[0];
      const hasBuffer = selectedOption && selectedOption.dataset.defaultBuffer !== undefined;
      if (hasBuffer) {
        const value = Number(selectedOption.dataset.defaultBuffer);
        bufferInput.placeholder = Number.isFinite(value) && value !== 0 ? `Sugerencia: ${value} m` : 'Opcional';
      } else {
        bufferInput.placeholder = 'Opcional';
      }
    }

    function collectEcoPayload() {
      const form = document.getElementById('ecoForm');
      if (!form) {
        return null;
      }
      const formData = new FormData(form);
      return {
        preset: formData.get('preset'),
        start: formData.get('start'),
        end: formData.get('end'),
        cloudPercentage: Number(formData.get('cloudPercentage')) || 20,
        populationYear: Number(formData.get('populationYear')) || 2020,
        buffer: formData.get('buffer') ? Number(formData.get('buffer')) : undefined,
        districtsAsset: formData.get('districtsAsset') || undefined
      };
    }

    function setReportButtonsDisabled(disabled) {
      ecoReportButtons.forEach((button) => {
        button.disabled = disabled;
      });
    }

    function sanitizeFilename(base, fallback = 'ecoplan-report') {
      const value = (base || fallback).toString().trim();
      return value.replace(/[^a-z0-9-_]+/gi, '_').replace(/_{2,}/g, '_');
    }

    function getFilenameFromDisposition(disposition, fallback) {
      if (!disposition) {
        return fallback;
      }
      const encodedMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
      if (encodedMatch && encodedMatch[1]) {
        try {
          return decodeURIComponent(encodedMatch[1]);
        } catch (error) {
          // ignore decoding error and continue
        }
      }
      const plainMatch = disposition.match(/filename="?([^";]+)"?/i);
      if (plainMatch && plainMatch[1]) {
        return plainMatch[1];
      }
      return fallback;
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    async function downloadEcoPlanReport(format) {
      const payload = collectEcoPayload();
      if (!payload) {
        logStatus('No se pudo leer el formulario EcoPlan.', 'error', 'ecoplan');
        return;
      }

      const normalizedFormat = (format || 'pdf').toLowerCase();
      const requestBody = { ...payload, format: normalizedFormat };
      const queryFormat = encodeURIComponent(normalizedFormat);
      const presetSlug = sanitizeFilename(payload.preset || 'urbano');
      const defaultFilename = `${presetSlug}.${normalizedFormat === 'html' ? 'html' : normalizedFormat}`;

      setLoading(true, 'ecoplan');
      setReportButtonsDisabled(true);

      try {
        logStatus(`Generando reporte EcoPlan (${normalizedFormat.toUpperCase()})...`, 'info', 'ecoplan');
        const response = await fetch(`/api/reports/generate?format=${queryFormat}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || response.statusText || 'Error desconocido');
        }

        if (normalizedFormat === 'html') {
          const htmlText = await response.text();
          const blob = new Blob([htmlText], { type: 'text/html;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank', 'noopener');
          setTimeout(() => URL.revokeObjectURL(url), 120000);
          logStatus('Reporte HTML abierto en una nueva pestaña.', 'success', 'ecoplan');
          return;
        }

        const contentType = response.headers.get('Content-Type') || '';
        if (contentType.includes('application/json')) {
          const errorJson = await response.json();
          throw new Error(errorJson?.message || 'Error inesperado al generar el reporte.');
        }

        const blob = await response.blob();
        const disposition = response.headers.get('Content-Disposition');
        const filename = getFilenameFromDisposition(disposition, defaultFilename);
        downloadBlob(blob, filename);
        logStatus(`Reporte ${normalizedFormat.toUpperCase()} descargado correctamente.`, 'success', 'ecoplan');
      } catch (error) {
        console.error(error);
        logStatus(`No se pudo generar el reporte: ${error.message}`, 'error', 'ecoplan');
      } finally {
        setLoading(false, 'ecoplan');
        setReportButtonsDisabled(false);
      }
    }

    async function loadQuickView() {
      setLoading(true, 'bloom');

      try {
        logStatus('Solicitando imagen Landsat 8 True Color...', 'info', 'bloom');
        const response = await fetch('/api/map/info', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`Respuesta ${response.status}`);
        }

        const data = await response.json();

        clearOverlays();
        if (roiLayer) {
          map.removeLayer(roiLayer);
          roiLayer = null;
        }
        if (contextLayer) {
          map.removeLayer(contextLayer);
          contextLayer = null;
        }

        addOverlayLayer('Landsat 8 – True Color', {
          ...data,
          name: 'Landsat 8 True Color'
        }, { visible: true, opacity: 1 });

        logStatus('Imagen básica cargada correctamente.', 'success', 'bloom');
      } catch (error) {
        console.error(error);
        logStatus(`No se pudo cargar la imagen simple: ${error.message}`, 'error', 'bloom');
      } finally {
        setLoading(false, 'bloom');
      }
    }

    async function runBloomAnalysis(event) {
      event?.preventDefault();
      setLoading(true, 'bloom');

      try {
        const formData = new FormData(document.getElementById('controlForm'));
        const payload = {
          preset: formData.get('preset'),
          start: formData.get('start'),
          end: formData.get('end'),
          cloudPercentage: Number(formData.get('cloudPercentage')) || 35,
          ndciThreshold: Number(formData.get('ndciThreshold')) || 0.1,
          faiThreshold: Number(formData.get('faiThreshold')) || 0.005,
          adaptiveThreshold: formData.get('adaptiveThreshold') === 'on',
          minPixelsClean: Number(formData.get('minPixelsClean')) || 12,
          buffer: formData.get('buffer') ? Number(formData.get('buffer')) : undefined
        };

        const contextBufferKm = Number(formData.get('contextBufferKm')) || 5;
        const contextPayload = { ...payload, contextBuffer: contextBufferKm * 1000 };

        logStatus('Solicitando datos de bloom a la API...', 'info', 'bloom');

        const [mapResponse, statsResponse, contextResponse] = await Promise.all([
          fetch('/api/bloom/map', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }),
          fetch('/api/bloom/stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }),
          fetch('/api/bloom/context', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(contextPayload)
          })
        ]);

        if (!mapResponse.ok) {
          const errorText = await mapResponse.text();
          throw new Error(`Mapa bloom: ${errorText || mapResponse.statusText}`);
        }
        if (!statsResponse.ok) {
          const errorText = await statsResponse.text();
          throw new Error(`Estadísticas bloom: ${errorText || statsResponse.statusText}`);
        }
        if (!contextResponse.ok) {
          const errorText = await contextResponse.text();
          throw new Error(`Contexto regional: ${errorText || contextResponse.statusText}`);
        }

        const [mapData, statsData, contextData] = await Promise.all([
          mapResponse.json(),
          statsResponse.json(),
          contextResponse.json()
        ]);

        renderBloomResult({
          mapData,
          statsData,
          contextData
        });
      } catch (error) {
        console.error(error);
        logStatus(`Error al ejecutar análisis: ${error.message}`, 'error', 'bloom');
      } finally {
        setLoading(false, 'bloom');
      }
    }

    async function runEcoPlanAnalysis(event) {
      event?.preventDefault();
      setLoading(true, 'ecoplan');
      setReportButtonsDisabled(true);

      try {
        const payload = collectEcoPayload();
        if (!payload) {
          throw new Error('No se pudo leer el formulario EcoPlan.');
        }

        logStatus('Solicitando análisis EcoPlan Urbano...', 'info', 'ecoplan');

        const response = await fetch('/api/ecoplan/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || response.statusText || 'Error desconocido');
        }

        const result = await response.json();
        renderEcoResult(result);
      } catch (error) {
        console.error(error);
        logStatus(`Error EcoPlan: ${error.message}`, 'error', 'ecoplan');
      } finally {
        setLoading(false, 'ecoplan');
        setReportButtonsDisabled(false);
      }
    }

    async function fetchPresets() {
      await fetchBloomPresets();
      await fetchEcoPresets();
    }

    document.addEventListener('DOMContentLoaded', () => {
      createMap();
      loadGeeBasemap();
      fetchPresets();
      loadReportRunsAutoRefreshSettings();
      applyReportRunsAutoRefreshDomState();
      const savedModePreference = loadModePreference();
      if (savedModePreference && savedModePreference !== currentMode) {
        currentMode = savedModePreference;
      }

      document.getElementById('controlForm').addEventListener('submit', runBloomAnalysis);
      document.getElementById('presetSelect').addEventListener('change', updateBufferPlaceholder);
      document.getElementById('ecoForm').addEventListener('submit', runEcoPlanAnalysis);
      document.getElementById('ecoPresetSelect').addEventListener('change', updateEcoBufferPlaceholder);
      modeButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const targetMode = button.dataset.mode;
          if (targetMode) {
            setMode(targetMode);
          }
        });
      });
      ecoReportButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const format = button.dataset.reportFormat;
          if (format) {
            downloadEcoPlanReport(format);
          }
        });
      });
      if (refreshReportRunsButton) {
        refreshReportRunsButton.addEventListener('click', () => {
          fetchReportRuns({ announce: true });
        });
      }
      if (reportRunsJobFilter) {
        reportRunsJobFilter.addEventListener('change', () => {
          reportRunsFilterState.jobId = reportRunsJobFilter.value;
          fetchReportRuns({ announce: true });
        });
      }
      if (reportRunsStatusFilter) {
        reportRunsStatusFilter.addEventListener('change', () => {
          reportRunsFilterState.status = reportRunsStatusFilter.value;
          fetchReportRuns({ announce: true });
        });
      }
      if (reportRunsAutoRefreshToggle) {
        reportRunsAutoRefreshToggle.addEventListener('change', () => {
          reportRunsAutoRefreshEnabled = reportRunsAutoRefreshToggle.checked;
          persistReportRunsAutoRefreshSettings();
          scheduleReportRunsAutoRefresh({ fetchImmediately: reportRunsAutoRefreshEnabled && currentMode === 'ecoplan' });
          updateReportRunsAutoRefreshStatusLabel();
        });
      }
      if (reportRunsAutoRefreshIntervalSelect) {
        reportRunsAutoRefreshIntervalSelect.addEventListener('change', () => {
          reportRunsAutoRefreshIntervalMs = parseAutoRefreshInterval(reportRunsAutoRefreshIntervalSelect.value);
          persistReportRunsAutoRefreshSettings();
          scheduleReportRunsAutoRefresh({ fetchImmediately: reportRunsAutoRefreshEnabled && currentMode === 'ecoplan' });
        });
      }
      if (closeReportRunDetailsButton) {
        closeReportRunDetailsButton.addEventListener('click', () => closeReportRunDetails());
      }
      if (reportRunDetailsOverlay) {
        reportRunDetailsOverlay.addEventListener('click', (event) => {
          if (event.target === reportRunDetailsOverlay) {
            closeReportRunDetails({ silent: true });
          }
        });
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && reportRunDetailsOverlay && !reportRunDetailsOverlay.hidden) {
          closeReportRunDetails({ silent: true });
        }
      });
      document.addEventListener('visibilitychange', handleVisibilityChange);
      setMode(currentMode, { reRender: false, silent: true });
      if (quickViewButton) {
        quickViewButton.addEventListener('click', loadQuickView);
      }
      logStatus('Interfaz lista. Usa "Ver imagen satelital simple" para probar rápidamente.', 'info');
    });
  </script>
</body>
</html>